---
phase: 06-classroom-structure
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/admin/lesson-form.tsx
  - src/components/admin/course-tree.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Admin can create lessons within modules"
    - "Add Lesson button appears in course tree for each module"
    - "New lesson appears in tree after creation"
    - "New lesson can be edited via lesson edit page"
  artifacts:
    - path: "src/components/admin/lesson-form.tsx"
      provides: "Inline lesson creation form"
      min_lines: 50
  key_links:
    - from: "src/components/admin/lesson-form.tsx"
      to: "src/lib/lesson-actions.ts"
      via: "createLesson server action"
      pattern: "createLesson"
    - from: "src/components/admin/course-tree.tsx"
      to: "src/components/admin/lesson-form.tsx"
      via: "component import"
      pattern: "LessonForm"
---

<objective>
Wire the existing createLesson server action to the UI by adding a LessonForm component and "Add Lesson" buttons in the course tree.

Purpose: Close the CLRM-03 gap - admins can create lessons within modules, completing the full course hierarchy creation flow.
Output: LessonForm component and integrated "Add Lesson" UI in course tree sidebar.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-classroom-structure/06-VERIFICATION.md
@src/lib/lesson-actions.ts
@src/lib/validations/lesson.ts
@src/components/admin/module-form.tsx
@src/components/admin/course-tree.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LessonForm component</name>
  <files>src/components/admin/lesson-form.tsx</files>
  <action>
Create LessonForm component following the ModuleForm pattern from src/components/admin/module-form.tsx.

The form should:
1. Accept `moduleId: string` prop (required - which module to add lesson to)
2. Accept `courseId: string` prop (for path revalidation)
3. Accept optional `onSuccess?: () => void` and `onCancel?: () => void` callbacks
4. Import and call `createLesson` from `@/lib/lesson-actions`

Form fields:
- `title` input (required, minLength 3, maxLength 200)
- Hidden `moduleId` input with the moduleId prop value
- Hidden `content` input with default empty Tiptap doc: `{"type":"doc","content":[]}`
- Hidden `status` input with value "DRAFT"

UI pattern (match ModuleForm):
- Horizontal layout: text input + Add button + optional Cancel button
- Use `useTransition` for pending state
- Display error messages below form
- Reset form and call `onSuccess` after successful creation
- Call `router.refresh()` to update the tree

The createLesson action validates:
- title: 3-200 chars
- content: valid Tiptap JSON (empty doc is valid)
- status: DRAFT or PUBLISHED
- moduleId: valid CUID

Example structure:
```typescript
'use client';

import { useTransition, useRef, useState } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { createLesson } from '@/lib/lesson-actions';

interface LessonFormProps {
  moduleId: string;
  courseId: string;
  onSuccess?: () => void;
  onCancel?: () => void;
}

export function LessonForm({ moduleId, courseId, onSuccess, onCancel }: LessonFormProps) {
  // ... follow ModuleForm pattern
}
```
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Component exports correctly: import works in other files
  </verify>
  <done>LessonForm component created with createLesson wiring</done>
</task>

<task type="auto">
  <name>Task 2: Add "Add Lesson" UI to course tree</name>
  <files>src/components/admin/course-tree.tsx</files>
  <action>
Update CourseTree component to include "Add Lesson" capability for each module.

Add to CourseTree:
1. Import `LessonForm` from `@/components/admin/lesson-form`
2. Track which module (if any) has the add lesson form open: `const [addingLessonToModule, setAddingLessonToModule] = useState<string | null>(null)`

Modify the TreeItemComponent or add UI after each module item:
- Add a small "+" button or "Add Lesson" text after each module row (visible on hover or always)
- When clicked, show the LessonForm inline below that module
- Pass moduleId and courseId to LessonForm
- On success: close the form (set addingLessonToModule to null), router.refresh() updates tree
- On cancel: close the form

Implementation approach - choose ONE:

**Option A: Add button inside module tree item (recommended)**
In TreeItemComponent, when `isModule`, add a "+" icon button after the module title:
```tsx
{isModule && (
  <button
    onClick={(e) => {
      e.stopPropagation();
      onAddLesson?.(item.id);
    }}
    className="opacity-0 group-hover:opacity-100 ml-auto p-1 hover:bg-gray-200 rounded"
    title="Add lesson"
  >
    <PlusIcon className="w-4 h-4" />
  </button>
)}
```
Pass `onAddLesson` callback from CourseTree to TreeItemComponent via props.

**Option B: Collapsible section at bottom of tree (simpler)**
Add a "Add Lesson" section below the tree (similar to AddModuleSection in layout.tsx):
- Dropdown to select which module
- LessonForm appears after selection

Choose Option A for better UX - inline with each module.

After adding lesson, the tree should update (via router.refresh) showing the new lesson.
  </action>
  <verify>
- Navigate to /admin/courses/[id] with existing modules
- See "+" or "Add Lesson" button on module rows
- Click button - LessonForm appears
- Enter title, submit - lesson created
- New lesson appears in tree under that module
- Click new lesson - navigates to lesson edit page
- `npm run build` succeeds
  </verify>
  <done>"Add Lesson" UI integrated into course tree, createLesson action now wired to UI</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to /admin/courses/[id] with at least one module
2. Hover over a module - see "Add Lesson" button appear
3. Click "Add Lesson" - inline form appears
4. Enter lesson title (at least 3 chars), click Add
5. Form closes, new lesson appears in tree under that module
6. Click the new lesson - navigates to /admin/courses/[id]/lessons/[lessonId]
7. Lesson edit page loads with the title you entered
8. Can edit content and save
9. Create lessons in multiple modules - all work
10. `npm run build` succeeds
</verification>

<success_criteria>
- LessonForm component exists and imports createLesson
- Course tree has "Add Lesson" UI for each module
- Clicking Add Lesson shows inline form
- Submitting form with valid title creates lesson
- New lesson appears in tree immediately
- Lesson links to edit page
- CLRM-03 requirement now satisfied: "Admin can create lessons within modules"
</success_criteria>

<output>
After completion, create `.planning/phases/06-classroom-structure/06-04-SUMMARY.md`
</output>
