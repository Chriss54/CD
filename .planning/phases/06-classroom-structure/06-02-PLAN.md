---
phase: 06-classroom-structure
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - prisma/schema.prisma
  - src/types/course.ts
  - src/lib/validations/lesson.ts
  - src/lib/lesson-actions.ts
  - src/lib/attachment-actions.ts
  - src/components/admin/lesson-editor.tsx
  - src/components/admin/attachment-list.tsx
  - src/app/(main)/admin/courses/[courseId]/lessons/[lessonId]/page.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Admin can create lessons within modules"
    - "Lesson can contain rich text with headings, lists, code blocks, tables, and links"
    - "Lesson can contain embedded video (YouTube, Vimeo, Loom)"
    - "Admin can attach downloadable files to lessons"
    - "Lessons have draft/published status"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Lesson and Attachment models"
      contains: "model Lesson"
    - path: "src/lib/lesson-actions.ts"
      provides: "Lesson CRUD server actions"
      exports: ["createLesson", "updateLesson", "deleteLesson"]
    - path: "src/components/admin/lesson-editor.tsx"
      provides: "Enhanced Tiptap editor with code blocks, tables, links"
      min_lines: 80
    - path: "src/app/(main)/admin/courses/[courseId]/lessons/[lessonId]/page.tsx"
      provides: "Lesson edit page"
      min_lines: 60
  key_links:
    - from: "src/components/admin/lesson-editor.tsx"
      to: "@tiptap/extension-code-block"
      via: "extension import"
      pattern: "CodeBlock"
    - from: "src/components/admin/lesson-editor.tsx"
      to: "@tiptap/extension-table"
      via: "extension import"
      pattern: "Table.*TableRow.*TableCell"
    - from: "src/lib/attachment-actions.ts"
      to: "Supabase Storage"
      via: "upload API"
      pattern: "supabase.storage.from"
---

<objective>
Add Lesson model with rich text content, video embeds, and file attachments. Create enhanced Tiptap editor with code blocks, tables, and links for lesson content.

Purpose: Complete the course hierarchy so admins can add educational content to modules.
Output: Working lesson editor page with enhanced rich text editing, video embed input, and file attachment support.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-classroom-structure/06-CONTEXT.md
@.planning/phases/06-classroom-structure/06-RESEARCH.md
@.planning/phases/06-classroom-structure/06-01-SUMMARY.md
@prisma/schema.prisma
@src/components/feed/post-editor.tsx
@src/components/video/video-input.tsx
@src/lib/video-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Lesson and Attachment models, install editor extensions</name>
  <files>prisma/schema.prisma, src/types/course.ts, package.json</files>
  <action>
Install Tiptap extensions for enhanced editing:
```bash
npm install @tiptap/extension-code-block @tiptap/extension-table @tiptap/extension-link
```

Note: Table extension requires TableRow, TableCell, TableHeader - these are included in @tiptap/extension-table package.

Add Lesson and Attachment models to Prisma schema:

```prisma
enum LessonStatus {
  DRAFT
  PUBLISHED
}

model Lesson {
  id        String       @id @default(cuid())
  title     String
  position  Int          // For ordering within module
  status    LessonStatus @default(DRAFT)
  videoUrl  String?      // Optional video embed at top
  content   Json         // Tiptap JSON document
  moduleId  String
  module    Module       @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  attachments Attachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([moduleId])
  @@index([moduleId, position])
}

model Attachment {
  id        String   @id @default(cuid())
  name      String   // Original filename
  url       String   // Supabase storage URL
  size      Int      // File size in bytes
  mimeType  String
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([lessonId])
}
```

Update Module model to add lessons relation (remove comment from 06-01).

Update src/types/course.ts:
- Add LessonStatus enum
- Add Lesson type with all fields
- Add Attachment type
- Update ModuleWithLessons to include lessons array
- Add LessonWithAttachments type

Run `npx prisma db push` and `npx prisma generate`.
  </action>
  <verify>
- `npm install` succeeds
- `npx prisma db push` succeeds
- `npx prisma generate` succeeds
- TypeScript compiles
  </verify>
  <done>Lesson and Attachment models exist in database, Tiptap extensions installed</done>
</task>

<task type="auto">
  <name>Task 2: Create lesson and attachment server actions</name>
  <files>src/lib/validations/lesson.ts, src/lib/lesson-actions.ts, src/lib/attachment-actions.ts</files>
  <action>
Create src/lib/validations/lesson.ts:
- lessonSchema: title (3-200 chars), content (Tiptap JSON), videoUrl (optional URL), status (enum), moduleId (cuid)
- Use same Tiptap JSON validation pattern from post.ts (z.record for JSON document)

Create src/lib/lesson-actions.ts with server actions:
- getLesson(id): Returns lesson with attachments and module (to get courseId for breadcrumbs)
- getLessonsForModule(moduleId): Returns lessons ordered by position
- createLesson(data): Creates at next position, validates moduleId exists, admin check
- updateLesson(id, data): Updates lesson, admin check
- deleteLesson(id): Deletes lesson AND attachments (see attachment cleanup below), admin check

Create src/lib/attachment-actions.ts with server actions:
- uploadAttachment(formData): Upload file to Supabase Storage "attachments" bucket
  - Extract file and lessonId from FormData
  - Path: `lessons/${lessonId}/${Date.now()}-${sanitizedFilename}`
  - Get public URL after upload
  - Create Attachment record in database
  - Return { success: true, attachment } or { error: string }
- deleteAttachment(id): Delete from Storage AND database
  - Get attachment record first to get URL/path
  - Delete from Supabase Storage
  - Delete database record
- getAttachments(lessonId): Returns attachments for lesson

IMPORTANT - Storage bucket setup:
The "attachments" bucket must exist in Supabase Storage. If running locally, check if bucket exists via Supabase Studio (localhost:54323). If not, the upload action should create it programmatically or fail gracefully with helpful error.

File size limit: Use 10MB max (project already has 5MB serverActions.bodySizeLimit from 03-01, will need to increase in next.config if needed for larger files).

Allowed file types: PDF, DOCX, DOC, XLSX, XLS, PPTX, PPT, ZIP, TXT, MD
  </action>
  <verify>
- TypeScript compiles
- Server actions export correctly
  </verify>
  <done>Lesson and attachment CRUD operations available with file upload to Supabase Storage</done>
</task>

<task type="auto">
  <name>Task 3: Create enhanced lesson editor and edit page</name>
  <files>src/components/admin/lesson-editor.tsx, src/components/admin/attachment-list.tsx, src/app/(main)/admin/courses/[courseId]/lessons/[lessonId]/page.tsx</files>
  <action>
Create LessonEditor component (src/components/admin/lesson-editor.tsx):
- Enhanced Tiptap editor extending the pattern from post-editor.tsx
- Extensions: StarterKit, CodeBlock, Table (with TableRow, TableCell, TableHeader), Link
- CRITICAL: Use immediatelyRender: false for SSR compatibility
- Toolbar with:
  - Bold, Italic (existing)
  - Headings dropdown (H1, H2, H3)
  - Bullet list, Ordered list
  - Code block button
  - Table insert button (3x3 default)
  - Link button (prompt for URL, see RESEARCH.md pattern)
- Props: content (JSON string), onChange callback

Configure extensions per RESEARCH.md:
```typescript
CodeBlock.configure({
  exitOnTripleEnter: true,
  exitOnArrowDown: true,
}),
Table.configure({
  resizable: true,
}),
TableRow,
TableCell,
TableHeader,
Link.configure({
  openOnClick: false,
  autolink: true,
  defaultProtocol: 'https',
}),
```

Create AttachmentList component:
- Shows list of attachments with filename, size (human readable), download link
- Delete button per attachment with inline confirmation
- Upload button/dropzone for adding new files
- Client component for handling file input and upload progress

Create lesson edit page (/admin/courses/[courseId]/lessons/[lessonId]/page.tsx):
- Server component fetching lesson with attachments
- Breadcrumb: Courses > [Course Title] > [Module Title] > [Lesson Title]
- Form layout:
  - Title input at top
  - Status select (Draft/Published)
  - Video URL input (reuse VideoInput from src/components/video/video-input.tsx)
  - Rich text editor (LessonEditor)
  - Attachments section (AttachmentList)
  - Save button
- Video preview shown above editor when videoUrl is set (reuse VideoEmbedPlayer)
- Auto-save could be nice but not required - explicit Save button is fine
  </action>
  <verify>
- Navigate to /admin/courses/[id]/lessons/[lessonId] - page renders
- Can edit lesson title and content
- Can add video URL - preview appears
- Can format text with bold, italic, headings, lists
- Can insert code block and table
- Can add/remove links
- Can upload and delete attachments
- npm run build succeeds
  </verify>
  <done>Lesson editor with enhanced Tiptap, video embed, and file attachments working</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to a course detail page (from 06-01)
2. Click a module to see its lessons (or "Add Lesson" button)
3. Create a new lesson with title "Lesson 1"
4. Lesson edit page opens with enhanced editor
5. Add video URL (e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ) - preview appears
6. Write content with:
   - A heading (H2)
   - Some bold and italic text
   - A bullet list
   - A code block with sample code
   - A simple 2x2 table
   - A hyperlink
7. Upload a test PDF file - appears in attachments list
8. Delete the attachment - removed from list
9. Save lesson - content persists
10. Reload page - all content and formatting preserved
11. Change lesson status to Published - persists
</verification>

<success_criteria>
- Lesson and Attachment models exist in database
- Admin can create/edit/delete lessons within modules
- Lesson editor supports headings, bold, italic, lists, code blocks, tables, and links
- Video URL renders preview above content
- File attachments can be uploaded and downloaded
- All content persists correctly as Tiptap JSON
</success_criteria>

<output>
After completion, create `.planning/phases/06-classroom-structure/06-02-SUMMARY.md`
</output>
