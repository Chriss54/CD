---
phase: 06-classroom-structure
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/admin/course-tree.tsx
  - src/lib/module-actions.ts
  - src/lib/lesson-actions.ts
  - src/app/(main)/admin/courses/[courseId]/page.tsx
  - src/app/(main)/admin/courses/[courseId]/layout.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Sidebar shows course tree with modules and lessons"
    - "Admin can expand/collapse modules to see lessons"
    - "Admin can drag-drop to reorder modules within course"
    - "Admin can drag-drop to reorder lessons within module"
    - "Admin can drag lesson to different module"
  artifacts:
    - path: "src/components/admin/course-tree.tsx"
      provides: "Drag-drop sortable tree for course structure"
      min_lines: 100
    - path: "src/app/(main)/admin/courses/[courseId]/layout.tsx"
      provides: "Layout with sidebar tree"
      min_lines: 30
  key_links:
    - from: "src/components/admin/course-tree.tsx"
      to: "dnd-kit-sortable-tree"
      via: "import"
      pattern: "SortableTree"
    - from: "src/components/admin/course-tree.tsx"
      to: "src/lib/module-actions.ts"
      via: "reorder server action"
      pattern: "reorderModules"
---

<objective>
Build the sidebar tree navigation for course structure with drag-and-drop reordering. Admin can see modules and lessons in a tree, expand/collapse modules, and drag items to reorder.

Purpose: Provide visual organization and easy reordering of course content without manual position editing.
Output: Sidebar tree component in course admin layout with full drag-drop reordering capability.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-classroom-structure/06-CONTEXT.md
@.planning/phases/06-classroom-structure/06-RESEARCH.md
@.planning/phases/06-classroom-structure/06-01-SUMMARY.md
@src/lib/module-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit dependencies</name>
  <files>package.json</files>
  <action>
Install dnd-kit-sortable-tree and its peer dependencies:

```bash
npm install dnd-kit-sortable-tree @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

These packages enable:
- @dnd-kit/core: Base drag-drop functionality
- @dnd-kit/sortable: Sortable presets for lists
- @dnd-kit/utilities: CSS transform utilities
- dnd-kit-sortable-tree: Tree structure support with nested items
  </action>
  <verify>
- `npm install` succeeds without errors
- packages appear in package.json dependencies
  </verify>
  <done>dnd-kit packages installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Add reorder server actions</name>
  <files>src/lib/module-actions.ts, src/lib/lesson-actions.ts</files>
  <action>
Add reorder server actions following the RESEARCH.md transaction pattern:

In src/lib/module-actions.ts, add:
```typescript
export async function reorderModules(courseId: string, orderedIds: string[]) {
  // Admin check
  // Use transaction to prevent race conditions
  await db.$transaction(
    orderedIds.map((id, index) =>
      db.module.update({
        where: { id },
        data: { position: index },
      })
    )
  );
  revalidatePath(`/admin/courses/${courseId}`);
  return { success: true };
}
```

In src/lib/lesson-actions.ts, add:
```typescript
export async function reorderLessons(moduleId: string, orderedIds: string[]) {
  // Admin check
  await db.$transaction(
    orderedIds.map((id, index) =>
      db.lesson.update({
        where: { id },
        data: { position: index },
      })
    )
  );
  // Get courseId for revalidation
  const mod = await db.module.findUnique({ where: { id: moduleId }, select: { courseId: true } });
  if (mod) revalidatePath(`/admin/courses/${mod.courseId}`);
  return { success: true };
}

export async function moveLessonToModule(
  lessonId: string,
  targetModuleId: string,
  newPosition: number
) {
  // Admin check
  // Get lesson's current module for revalidation
  const lesson = await db.lesson.findUnique({
    where: { id: lessonId },
    select: { moduleId: true, module: { select: { courseId: true } } },
  });
  if (!lesson) return { error: 'Lesson not found' };

  await db.$transaction([
    // Update lesson's module and position
    db.lesson.update({
      where: { id: lessonId },
      data: {
        moduleId: targetModuleId,
        position: newPosition,
      },
    }),
    // Shift positions in target module to make room
    db.lesson.updateMany({
      where: {
        moduleId: targetModuleId,
        position: { gte: newPosition },
        id: { not: lessonId },
      },
      data: { position: { increment: 1 } },
    }),
  ]);

  revalidatePath(`/admin/courses/${lesson.module.courseId}`);
  return { success: true };
}
```

Note: Position gaps after moves are acceptable (per RESEARCH.md). The relative order is what matters.
  </action>
  <verify>
- TypeScript compiles
- Server actions export correctly
  </verify>
  <done>Reorder and move server actions available for tree drag-drop operations</done>
</task>

<task type="auto">
  <name>Task 3: Create CourseTree component and layout with sidebar</name>
  <files>src/components/admin/course-tree.tsx, src/app/(main)/admin/courses/[courseId]/layout.tsx, src/app/(main)/admin/courses/[courseId]/page.tsx</files>
  <action>
Create CourseTree component (src/components/admin/course-tree.tsx):

Client component using dnd-kit-sortable-tree pattern from RESEARCH.md:

```typescript
'use client';

import { SortableTree, SimpleTreeItemWrapper, TreeItemComponentProps } from 'dnd-kit-sortable-tree';
import { forwardRef } from 'react';
// ... imports for actions

interface TreeItem {
  id: string;
  value: string;
  type: 'module' | 'lesson';
  status?: 'DRAFT' | 'PUBLISHED';
  children?: TreeItem[];
}

interface CourseTreeProps {
  courseId: string;
  modules: ModuleWithLessons[]; // From types/course.ts
  currentLessonId?: string; // For highlighting active item
}

// Custom tree item component
const TreeItemComponent = forwardRef<HTMLDivElement, TreeItemComponentProps<TreeItem>>((props, ref) => (
  <SimpleTreeItemWrapper {...props} ref={ref}>
    <div className={cn(
      props.item.type === 'module' ? 'font-semibold' : 'pl-4 text-sm',
      props.item.status === 'DRAFT' && 'text-gray-500'
    )}>
      {props.item.type === 'lesson' && <span className="mr-2">üìÑ</span>}
      {props.item.type === 'module' && <span className="mr-2">üìÅ</span>}
      {props.item.value}
      {props.item.status === 'DRAFT' && (
        <span className="ml-2 text-xs bg-gray-200 px-1 rounded">Draft</span>
      )}
    </div>
  </SimpleTreeItemWrapper>
));

export function CourseTree({ courseId, modules, currentLessonId }: CourseTreeProps) {
  // Transform modules to tree items
  const items: TreeItem[] = modules.map(m => ({
    id: m.id,
    value: m.title,
    type: 'module',
    children: m.lessons?.map(l => ({
      id: l.id,
      value: l.title,
      type: 'lesson',
      status: l.status,
    })) ?? [],
  }));

  // Handle tree changes (reorder, move)
  const handleItemsChanged = async (newItems: TreeItem[]) => {
    // Detect what changed and call appropriate server action
    // - If module order changed: reorderModules
    // - If lesson order within module changed: reorderLessons
    // - If lesson moved to different module: moveLessonToModule
    // Implementation: Compare old vs new structure
  };

  return (
    <nav className="p-4">
      <SortableTree
        items={items}
        onItemsChanged={handleItemsChanged}
        TreeItemComponent={TreeItemComponent}
      />
    </nav>
  );
}
```

Key behaviors:
- Modules expand/collapse to show lessons
- Clicking a lesson navigates to its edit page
- Dragging reorders within same level
- Dragging lesson to different module moves it
- Visual indicator for current/active item
- Draft items shown with muted style and badge

Create course layout (src/app/(main)/admin/courses/[courseId]/layout.tsx):
- Fetch course with modules and lessons
- Two-column layout: sidebar (CourseTree) + main content (children)
- Sidebar width ~280px, scrollable
- Course title at top of sidebar
- "Add Module" button in sidebar header

Update course detail page:
- Remove inline module list (now in sidebar)
- Show course settings/info in main area
- Or redirect to first lesson if exists
  </action>
  <verify>
- Navigate to /admin/courses/[id] - sidebar shows with tree
- Modules display with expand/collapse
- Lessons appear under their modules
- Can drag a module up/down - order persists after refresh
- Can drag a lesson up/down within module - order persists
- Can drag lesson to different module - moves correctly
- Click lesson navigates to lesson edit page
- npm run build succeeds
  </verify>
  <done>Sidebar tree with drag-drop reordering fully functional</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to /admin/courses/[id] with existing modules and lessons
2. Sidebar shows tree structure with modules and lessons
3. Collapse a module - lessons hide
4. Expand module - lessons show
5. Drag Module 2 above Module 1 - order changes
6. Refresh page - new order persisted
7. Drag Lesson 1 from Module 1 to Module 2 - lesson moves
8. Refresh page - lesson is now in Module 2
9. Drag lessons within a module to reorder - order persists
10. Click a lesson - navigates to lesson edit page
11. Draft lessons show with visual indicator
</verification>

<success_criteria>
- dnd-kit packages installed and working
- Sidebar tree shows course structure (modules > lessons)
- Modules expand/collapse
- Drag-drop reorders modules within course
- Drag-drop reorders lessons within module
- Drag-drop moves lessons between modules
- Position changes persist to database via transactions
- Click navigation works to lesson edit pages
</success_criteria>

<output>
After completion, create `.planning/phases/06-classroom-structure/06-03-SUMMARY.md`
</output>
