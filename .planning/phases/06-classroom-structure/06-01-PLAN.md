---
phase: 06-classroom-structure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/course.ts
  - src/lib/validations/course.ts
  - src/lib/course-actions.ts
  - src/lib/module-actions.ts
  - src/app/(main)/admin/courses/page.tsx
  - src/app/(main)/admin/courses/[courseId]/page.tsx
  - src/components/admin/course-form.tsx
  - src/components/admin/module-form.tsx
  - src/components/admin/course-card.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can create a course with title and description"
    - "Admin can create modules within a course"
    - "Admin can edit and delete courses"
    - "Admin can edit and delete modules"
    - "Courses have draft/published status"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Course, Module models with status enums"
      contains: "model Course"
    - path: "src/lib/course-actions.ts"
      provides: "Course CRUD server actions"
      exports: ["createCourse", "updateCourse", "deleteCourse"]
    - path: "src/lib/module-actions.ts"
      provides: "Module CRUD server actions"
      exports: ["createModule", "updateModule", "deleteModule"]
    - path: "src/app/(main)/admin/courses/page.tsx"
      provides: "Admin course list page"
      min_lines: 30
    - path: "src/app/(main)/admin/courses/[courseId]/page.tsx"
      provides: "Course detail/edit page with modules"
      min_lines: 50
  key_links:
    - from: "src/app/(main)/admin/courses/page.tsx"
      to: "src/lib/course-actions.ts"
      via: "server action calls"
      pattern: "createCourse|getCourses"
    - from: "src/components/admin/course-form.tsx"
      to: "src/lib/validations/course.ts"
      via: "form validation"
      pattern: "courseSchema"
---

<objective>
Create the database schema for courses and modules, implement server actions for CRUD operations, and build the admin interface for managing course structure.

Purpose: Establish the foundation of the classroom system - admins need to create and organize courses before adding lessons.
Output: Working admin pages at /admin/courses for listing courses and /admin/courses/[id] for managing a course's modules.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-classroom-structure/06-CONTEXT.md
@.planning/phases/06-classroom-structure/06-RESEARCH.md
@prisma/schema.prisma
@src/components/feed/post-editor.tsx
@src/lib/post-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Course and Module database models</name>
  <files>prisma/schema.prisma, src/types/course.ts</files>
  <action>
Add Course and Module models to Prisma schema following the pattern from RESEARCH.md:

```prisma
enum CourseStatus {
  DRAFT
  PUBLISHED
}

model Course {
  id          String       @id @default(cuid())
  title       String
  description String?      @db.Text
  status      CourseStatus @default(DRAFT)

  modules     Module[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([status])
}

model Module {
  id        String   @id @default(cuid())
  title     String
  position  Int      // For ordering within course
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  lessons   Lesson[] // Will be added in 06-02

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
  @@index([courseId, position])
}
```

Note: Add Lesson[] relation but comment it as "// Added in 06-02" since Lesson model comes later.

Create src/types/course.ts with TypeScript types:
- CourseStatus enum matching Prisma
- CourseWithModules type (includes modules array)
- ModuleWithLessons type (includes lessons array - for future use)

Run `npx prisma db push` to sync schema.
Run `npx prisma generate` to regenerate client.
  </action>
  <verify>
- `npx prisma db push` succeeds
- `npx prisma generate` succeeds
- TypeScript compiles without errors
  </verify>
  <done>Course and Module models exist in database with proper relations and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create validation schemas and server actions</name>
  <files>src/lib/validations/course.ts, src/lib/course-actions.ts, src/lib/module-actions.ts</files>
  <action>
Create validation schemas in src/lib/validations/course.ts:
- courseSchema: title (required, 3-100 chars), description (optional, max 2000 chars), status (enum)
- moduleSchema: title (required, 3-100 chars), courseId (required cuid)

Create src/lib/course-actions.ts with server actions:
- getCourses(): Returns all courses ordered by createdAt desc, include module count
- getCourse(id): Returns course with modules ordered by position
- createCourse(data): Creates course, revalidates /admin/courses
- updateCourse(id, data): Updates course, checks admin role
- deleteCourse(id): Deletes course (cascade deletes modules), checks admin role

Create src/lib/module-actions.ts with server actions:
- createModule(data): Creates module at next position (max position + 1)
- updateModule(id, data): Updates module
- deleteModule(id): Deletes module, does NOT recompact positions (sparse positions OK per RESEARCH.md)

All actions must:
- Use 'use server' directive
- Check session exists and user has admin/owner role (pattern from 05-01)
- Use Zod validation
- Call revalidatePath appropriately
  </action>
  <verify>
- TypeScript compiles
- Server actions export correctly
  </verify>
  <done>Course and module CRUD operations available as server actions with role-based access control</done>
</task>

<task type="auto">
  <name>Task 3: Create admin course list and detail pages</name>
  <files>src/app/(main)/admin/courses/page.tsx, src/app/(main)/admin/courses/[courseId]/page.tsx, src/components/admin/course-form.tsx, src/components/admin/module-form.tsx, src/components/admin/course-card.tsx</files>
  <action>
Create /admin/courses page:
- Server component that fetches courses using getCourses()
- Grid of CourseCard components showing title, status badge (Draft/Published), module count
- "Create Course" button opening inline form or navigating to create
- Use existing EmptyState component when no courses

Create CourseCard component:
- Shows course title, description preview (truncated), status badge
- Module count indicator
- Link to /admin/courses/[id] for editing
- Delete button with inline confirmation (pattern from 04-03, 05-04)

Create CourseForm component:
- Client component with react-hook-form
- Fields: title, description (textarea), status (select: Draft/Published)
- Submit calls createCourse or updateCourse based on mode
- Loading states on submit

Create /admin/courses/[courseId] page:
- Server component fetching course with modules
- Course header with edit form (inline or expandable)
- Modules section showing list of modules ordered by position
- "Add Module" button with ModuleForm
- Each module shows title with edit/delete actions
- Inline delete confirmation for modules with lesson count warning (from CONTEXT.md)

Create ModuleForm component:
- Client component for creating/editing modules
- Fields: title only (courseId passed as prop)
- Submit calls createModule or updateModule
  </action>
  <verify>
- Visit /admin/courses - page renders without errors
- Can create a new course
- Can edit course title/description/status
- Can create modules within a course
- Can delete courses and modules
- npm run build succeeds
  </verify>
  <done>Admin can manage courses and modules through /admin/courses interface</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to /admin/courses - should show empty state or course list
2. Create a new course with title "Test Course" and description
3. Course appears in list with "Draft" status badge
4. Click course to open detail page
5. Add a module "Module 1" - appears in module list
6. Add a second module "Module 2" - appears below Module 1
7. Edit Module 1 title - change persists
8. Delete Module 2 - module removed (with confirmation)
9. Change course status to Published - badge updates
10. Delete course - course removed from list (with confirmation)
</verification>

<success_criteria>
- Course and Module models exist in database
- Admin can create/edit/delete courses at /admin/courses
- Admin can create/edit/delete modules within a course
- Courses have draft/published status with visual indicator
- Module ordering by position field works
- Role-based access restricts actions to admin/owner
</success_criteria>

<output>
After completion, create `.planning/phases/06-classroom-structure/06-01-SUMMARY.md`
</output>
