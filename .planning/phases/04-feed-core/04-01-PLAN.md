---
phase: 04-feed-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/video-utils.ts
  - src/lib/validations/post.ts
  - src/lib/post-actions.ts
  - src/types/post.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Post model exists in database with content and embeds fields"
    - "Video URLs can be parsed to extract platform and ID"
    - "Posts can be created with content and embeds via server action"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Post model definition"
      contains: "model Post"
    - path: "src/lib/video-utils.ts"
      provides: "Video URL parsing and embed helpers"
      exports: ["parseVideoUrl", "getThumbnailUrl", "getEmbedUrl"]
    - path: "src/lib/validations/post.ts"
      provides: "Zod schemas for post content validation"
      exports: ["postSchema"]
    - path: "src/lib/post-actions.ts"
      provides: "Server actions for post CRUD"
      exports: ["createPost", "updatePost", "deletePost"]
  key_links:
    - from: "src/lib/post-actions.ts"
      to: "prisma.post"
      via: "db import and queries"
      pattern: "db\\.post\\.(create|update|delete)"
    - from: "src/lib/post-actions.ts"
      to: "src/lib/validations/post.ts"
      via: "postSchema import"
      pattern: "import.*postSchema.*from"
---

<objective>
Create the data foundation for the feed feature: Post model, video utilities, validation, and server actions.

Purpose: Establish the backend layer that all feed UI components will consume. This is the critical foundation that enables posts to be created, stored, and retrieved.
Output: Database model, TypeScript types, video parsing utilities, validation schema, and server actions for post CRUD.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-feed-core/04-RESEARCH.md
@prisma/schema.prisma
@src/lib/profile-actions.ts
@src/lib/validations/profile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Post model</name>
  <files>
    package.json
    prisma/schema.prisma
    src/types/post.ts
  </files>
  <action>
1. Install required packages:
   ```bash
   npm install @tiptap/react @tiptap/pm @tiptap/starter-kit get-video-id date-fns
   ```

2. Add Post model to prisma/schema.prisma after the User model:
   ```prisma
   model Post {
     id        String   @id @default(cuid())
     content   Json     // Tiptap JSON document
     embeds    Json     @default("[]") // Array of VideoEmbed objects
     authorId  String
     author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

     createdAt DateTime @default(now())
     updatedAt DateTime @updatedAt

     @@index([authorId])
     @@index([createdAt(sort: Desc)])
   }
   ```

3. Add posts relation to User model (add after existing fields):
   ```prisma
   posts Post[]
   ```

4. Run database migration:
   ```bash
   npx prisma db push
   ```

5. Create src/types/post.ts with TypeScript interfaces:
   - VideoService type: 'youtube' | 'vimeo' | 'loom'
   - VideoEmbed interface: { service, id, url }
   - PostWithAuthor type extending Prisma Post with author relation
  </action>
  <verify>
    - `npx prisma db push` completes without errors
    - `npx prisma studio` shows Post table with correct columns
    - `npm run build` passes TypeScript compilation
  </verify>
  <done>
    - Post model exists in schema with content (Json), embeds (Json), authorId fields
    - User model has posts relation
    - Database migrated with Post table
    - TypeScript types defined for VideoEmbed and PostWithAuthor
  </done>
</task>

<task type="auto">
  <name>Task 2: Create video utilities and validation schema</name>
  <files>
    src/lib/video-utils.ts
    src/lib/validations/post.ts
  </files>
  <action>
1. Create src/lib/video-utils.ts with:
   - Import getVideoId from 'get-video-id'
   - Export VideoService type and VideoEmbed interface (re-export from types/post.ts)
   - parseVideoUrl(url: string): VideoEmbed | null
     - Use getVideoId to extract service and id
     - Only accept youtube, vimeo, loom services
     - Return null for unsupported URLs
   - getThumbnailUrl(embed: VideoEmbed): string
     - YouTube: https://img.youtube.com/vi/{id}/mqdefault.jpg
     - Vimeo/Loom: Return placeholder for now (API route in later phase)
   - getEmbedUrl(embed: VideoEmbed): string
     - YouTube: https://www.youtube.com/embed/{id}?autoplay=1
     - Vimeo: https://player.vimeo.com/video/{id}?autoplay=1
     - Loom: https://www.loom.com/embed/{id}?autoplay=1

2. Create src/lib/validations/post.ts with:
   - Tiptap content schema (basic JSON structure validation)
   - VideoEmbed schema using z.object
   - postSchema that validates:
     - content: string that transforms to JSON, validates as Tiptap doc
     - embeds: optional string that transforms to array of VideoEmbed
   - Export PostInput type using z.input

Follow the pattern from src/lib/validations/profile.ts for schema structure.
  </action>
  <verify>
    - `npm run build` passes
    - Manual test: Import parseVideoUrl in a test file and verify:
      - parseVideoUrl('https://www.youtube.com/watch?v=dQw4w9WgXcQ') returns { service: 'youtube', id: 'dQw4w9WgXcQ', url: '...' }
      - parseVideoUrl('https://invalid.com') returns null
  </verify>
  <done>
    - video-utils.ts exports parseVideoUrl, getThumbnailUrl, getEmbedUrl
    - post.ts exports postSchema with content and embeds validation
    - Both files compile without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create post server actions</name>
  <files>
    src/lib/post-actions.ts
  </files>
  <action>
Create src/lib/post-actions.ts following the pattern from src/lib/profile-actions.ts:

1. Add 'use server' directive at top

2. Import dependencies:
   - getServerSession from 'next-auth'
   - revalidatePath from 'next/cache'
   - authOptions from '@/lib/auth'
   - db from '@/lib/db'
   - postSchema from '@/lib/validations/post'

3. createPost(formData: FormData):
   - Validate session (return { error: 'Not authenticated' } if missing)
   - Parse and validate content and embeds using postSchema
   - Create post with db.post.create
   - revalidatePath('/feed')
   - Return { success: true }

4. updatePost(postId: string, formData: FormData):
   - Validate session
   - Fetch post and verify authorId === session.user.id (return { error: 'Not authorized' } if not)
   - Parse and validate content and embeds
   - Update with db.post.update
   - revalidatePath('/feed')
   - revalidatePath(`/feed/${postId}`)
   - Return { success: true }

5. deletePost(postId: string):
   - Validate session
   - Fetch post and verify authorId === session.user.id
   - Delete with db.post.delete
   - revalidatePath('/feed')
   - Return { success: true }

CRITICAL: Always check post.authorId === session.user.id before update/delete to prevent unauthorized access.
  </action>
  <verify>
    - `npm run build` passes
    - Server actions have correct 'use server' directive
    - Authorization checks exist in updatePost and deletePost
  </verify>
  <done>
    - post-actions.ts exports createPost, updatePost, deletePost
    - All actions validate authentication
    - Update/delete actions verify post ownership
    - Actions use revalidatePath for cache invalidation
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds with no errors
2. `npx prisma studio` shows Post model with correct schema
3. All new files exist and export their expected functions/types
4. Database has Post table with proper indexes
</verification>

<success_criteria>
- Post model in database with content (Json), embeds (Json), authorId, timestamps
- User model has posts relation (one-to-many)
- video-utils.ts can parse YouTube/Vimeo/Loom URLs and generate embed URLs
- postSchema validates Tiptap JSON content structure
- Server actions handle CRUD with proper auth and ownership checks
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-feed-core/04-01-SUMMARY.md`
</output>
