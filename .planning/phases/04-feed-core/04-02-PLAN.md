---
phase: 04-feed-core
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/feed/post-editor.tsx
  - src/components/video/video-embed.tsx
  - src/components/video/video-input.tsx
  - src/components/feed/post-card.tsx
autonomous: true

must_haves:
  truths:
    - "Rich text editor renders with bold/italic/link formatting controls"
    - "Video embed shows thumbnail and plays on click"
    - "Post card displays author, content, timestamp, and embeds"
  artifacts:
    - path: "src/components/feed/post-editor.tsx"
      provides: "Tiptap rich text editor wrapper"
      min_lines: 40
    - path: "src/components/video/video-embed.tsx"
      provides: "Lazy-loading video player with thumbnail"
      min_lines: 30
    - path: "src/components/video/video-input.tsx"
      provides: "URL input for adding video embeds"
      min_lines: 20
    - path: "src/components/feed/post-card.tsx"
      provides: "Individual post display component"
      min_lines: 50
  key_links:
    - from: "src/components/feed/post-editor.tsx"
      to: "@tiptap/react"
      via: "useEditor hook"
      pattern: "useEditor"
    - from: "src/components/video/video-embed.tsx"
      to: "src/lib/video-utils.ts"
      via: "getEmbedUrl import"
      pattern: "import.*getEmbedUrl.*from"
    - from: "src/components/feed/post-card.tsx"
      to: "date-fns"
      via: "formatDistanceToNow"
      pattern: "formatDistanceToNow"
---

<objective>
Create the UI components for the feed: rich text editor, video embeds, and post display card.

Purpose: Build the reusable components that will be assembled into the post form and feed display. These are the visual building blocks.
Output: PostEditor (Tiptap wrapper), VideoEmbed (lazy-load player), VideoInput (URL field), PostCard (display component).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-feed-core/04-RESEARCH.md
@.planning/phases/04-feed-core/04-01-SUMMARY.md
@src/lib/video-utils.ts
@src/types/post.ts
@src/components/ui/avatar.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Tiptap PostEditor component</name>
  <files>
    src/components/feed/post-editor.tsx
  </files>
  <action>
Create src/components/feed/post-editor.tsx as a client component:

1. Add 'use client' directive

2. Import:
   - useEditor, EditorContent from '@tiptap/react'
   - StarterKit from '@tiptap/starter-kit'

3. Create PostEditorProps interface:
   - content?: string (initial JSON string content)
   - onChange?: (json: object) => void
   - placeholder?: string

4. Export PostEditor component:
   - Use useEditor hook with:
     - extensions: [StarterKit]
     - content: content ? JSON.parse(content) : ''
     - immediatelyRender: false (CRITICAL for SSR)
     - onUpdate: ({ editor }) => onChange?.(editor.getJSON())

   - Return null if !editor (loading state)

   - Render toolbar with buttons for:
     - Bold (B) - editor.chain().focus().toggleBold().run()
     - Italic (I) - editor.chain().focus().toggleItalic().run()
     - Apply active state styling (font-bold/italic when active)

   - Render EditorContent with className="prose max-w-none min-h-[100px]"

   - Wrap in border rounded-lg p-4 container

5. Style toolbar buttons with:
   - px-2 py-1 rounded hover:bg-gray-100
   - Active state: bg-gray-200

CRITICAL: Must include `immediatelyRender: false` to prevent SSR hydration errors.
  </action>
  <verify>
    - `npm run build` passes
    - Component renders without hydration errors in browser
    - Bold/Italic buttons toggle formatting
  </verify>
  <done>
    - PostEditor component exists with 'use client' directive
    - Uses Tiptap StarterKit with immediatelyRender: false
    - Has bold and italic toolbar buttons
    - Calls onChange with JSON when content changes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VideoEmbed and VideoInput components</name>
  <files>
    src/components/video/video-embed.tsx
    src/components/video/video-input.tsx
  </files>
  <action>
1. Create src/components/video/video-embed.tsx as client component:
   - Add 'use client' directive
   - Import useState from 'react'
   - Import Image from 'next/image'
   - Import VideoEmbed type, getEmbedUrl, getThumbnailUrl from '@/lib/video-utils'

   VideoEmbedProps interface:
   - embed: VideoEmbed

   Component logic:
   - State: const [isPlaying, setIsPlaying] = useState(false)

   When isPlaying=true:
   - Render iframe in aspect-video container
   - src={getEmbedUrl(embed)}
   - allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
   - allowFullScreen

   When isPlaying=false:
   - Render clickable button with thumbnail
   - Use next/image with src={getThumbnailUrl(embed)}
   - Overlay with play button icon (SVG triangle)
   - onClick={() => setIsPlaying(true)}
   - aspect-video responsive container
   - Play button: white circle with dark triangle icon

2. Create src/components/video/video-input.tsx as client component:
   - Add 'use client' directive
   - Import useState from 'react'
   - Import parseVideoUrl, VideoEmbed from '@/lib/video-utils'

   VideoInputProps interface:
   - onAdd: (embed: VideoEmbed) => void
   - disabled?: boolean

   Component logic:
   - State: const [url, setUrl] = useState('')
   - State: const [error, setError] = useState<string | null>(null)

   handleAdd function:
   - const embed = parseVideoUrl(url)
   - If !embed: setError('Invalid video URL. Supported: YouTube, Vimeo, Loom')
   - Else: onAdd(embed), setUrl(''), setError(null)

   Render:
   - Input field (type="url", placeholder="Paste video URL...")
   - Add button (calls handleAdd)
   - Error message display if error exists
   - Flex layout with gap
  </action>
  <verify>
    - `npm run build` passes
    - VideoEmbed shows thumbnail initially, iframe after click
    - VideoInput validates URLs and shows error for invalid ones
  </verify>
  <done>
    - video-embed.tsx lazy-loads videos with thumbnail-to-iframe pattern
    - video-input.tsx parses URLs and calls onAdd with valid embeds
    - Both components have proper TypeScript types
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PostCard display component</name>
  <files>
    src/components/feed/post-card.tsx
  </files>
  <action>
Create src/components/feed/post-card.tsx as a server component (no 'use client' needed):

1. Import:
   - Link from 'next/link'
   - formatDistanceToNow from 'date-fns'
   - Avatar from '@/components/ui/avatar'
   - VideoEmbed component from '@/components/video/video-embed'
   - PostWithAuthor type from '@/types/post'
   - generateHTML from '@tiptap/html' (for rendering content)
   - StarterKit from '@tiptap/starter-kit'

2. PostCardProps interface:
   - post: PostWithAuthor
   - showActions?: boolean (default false)
   - currentUserId?: string

3. Create helper function renderContent(content: object):
   - Use generateHTML(content, [StarterKit]) to convert Tiptap JSON to HTML
   - Return the HTML string

4. Component structure (social card layout):
   ```
   <article className="border rounded-lg p-4 bg-white">
     <div className="flex gap-3">
       {/* Avatar */}
       <Link href={`/members/${post.author.id}`}>
         <Avatar src={post.author.image} name={post.author.name} size="md" />
       </Link>

       {/* Content area */}
       <div className="flex-1 min-w-0">
         {/* Header: name + timestamp */}
         <div className="flex items-center gap-2">
           <Link href={`/members/${post.author.id}`} className="font-medium hover:underline">
             {post.author.name}
           </Link>
           <span className="text-sm text-muted-foreground">
             {formatDistanceToNow(post.createdAt, { addSuffix: true })}
           </span>
         </div>

         {/* Post content (rendered HTML) */}
         <div
           className="prose prose-sm max-w-none mt-2"
           dangerouslySetInnerHTML={{ __html: renderContent(post.content) }}
         />

         {/* Video embeds */}
         {post.embeds.length > 0 && (
           <div className="mt-3 space-y-3">
             {post.embeds.map((embed, i) => (
               <VideoEmbed key={i} embed={embed} />
             ))}
           </div>
         )}

         {/* Actions (edit/delete) - only for post author */}
         {showActions && currentUserId === post.authorId && (
           <div className="mt-3 flex gap-2">
             <Link href={`/feed/${post.id}/edit`} className="text-sm text-blue-600 hover:underline">
               Edit
             </Link>
             {/* Delete button will be added in Plan 03 */}
           </div>
         )}
       </div>
     </div>
   </article>
   ```

Note: The dangerouslySetInnerHTML is safe here because Tiptap's generateHTML produces sanitized output from our validated JSON structure.
  </action>
  <verify>
    - `npm run build` passes
    - Component renders with avatar, name, timestamp, content
    - Video embeds render when post has embeds
    - Edit link shows only for post author when showActions=true
  </verify>
  <done>
    - PostCard displays author avatar linking to profile
    - Shows author name and relative timestamp
    - Renders Tiptap content as HTML
    - Displays video embeds below content
    - Conditionally shows edit link for post author
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds with no errors
2. PostEditor renders without hydration errors
3. VideoEmbed lazy-loads videos correctly
4. PostCard displays all post information properly
</verification>

<success_criteria>
- PostEditor has Tiptap with immediatelyRender: false, bold/italic buttons
- VideoEmbed shows thumbnail, transitions to iframe on click
- VideoInput validates URLs, shows errors for invalid ones
- PostCard displays author info, content, timestamps, embeds
- All components compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-feed-core/04-02-SUMMARY.md`
</output>
