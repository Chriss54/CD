---
phase: 04-feed-core
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/components/feed/post-form.tsx
  - src/app/(main)/feed/page.tsx
  - src/app/(main)/feed/[id]/page.tsx
  - src/app/(main)/feed/[id]/edit/page.tsx
  - src/components/feed/delete-post-button.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a text post that appears in the feed"
    - "User can embed YouTube, Vimeo, or Loom video in a post"
    - "User can view a chronological feed of all posts (newest first)"
    - "User can edit their own posts after publishing"
    - "User can delete their own posts"
  artifacts:
    - path: "src/components/feed/post-form.tsx"
      provides: "Post creation/editing form combining editor and video inputs"
      min_lines: 60
    - path: "src/app/(main)/feed/page.tsx"
      provides: "Feed page with paginated posts"
      min_lines: 40
    - path: "src/app/(main)/feed/[id]/page.tsx"
      provides: "Individual post detail page"
      min_lines: 30
    - path: "src/app/(main)/feed/[id]/edit/page.tsx"
      provides: "Post edit page"
      min_lines: 30
    - path: "src/components/feed/delete-post-button.tsx"
      provides: "Delete button with confirmation"
      min_lines: 30
  key_links:
    - from: "src/components/feed/post-form.tsx"
      to: "src/lib/post-actions.ts"
      via: "createPost/updatePost import"
      pattern: "import.*(createPost|updatePost).*from"
    - from: "src/app/(main)/feed/page.tsx"
      to: "prisma.post"
      via: "db.post.findMany"
      pattern: "db\\.post\\.findMany"
    - from: "src/components/feed/delete-post-button.tsx"
      to: "src/lib/post-actions.ts"
      via: "deletePost import"
      pattern: "import.*deletePost.*from"
---

<objective>
Assemble the feed feature: post creation form, feed page with pagination, post detail/edit pages, and delete functionality.

Purpose: Integrate all components into working pages that deliver the complete feed experience. This completes Phase 4.
Output: PostForm component, /feed page with pagination, /feed/[id] detail page, /feed/[id]/edit page, delete functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-feed-core/04-CONTEXT.md
@.planning/phases/04-feed-core/04-02-SUMMARY.md
@src/lib/post-actions.ts
@src/components/feed/post-editor.tsx
@src/components/video/video-input.tsx
@src/components/feed/post-card.tsx
@src/components/ui/pagination.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PostForm and feed page</name>
  <files>
    src/components/feed/post-form.tsx
    src/app/(main)/feed/page.tsx
  </files>
  <action>
1. Create src/components/feed/post-form.tsx as client component:

   Add 'use client' directive

   Imports:
   - useState from 'react'
   - useRouter from 'next/navigation'
   - PostEditor from './post-editor'
   - VideoInput from '@/components/video/video-input'
   - VideoEmbed component from '@/components/video/video-embed'
   - createPost, updatePost from '@/lib/post-actions'
   - VideoEmbed type from '@/types/post'
   - Button from '@/components/ui/button'

   PostFormProps interface:
   - mode: 'create' | 'edit'
   - postId?: string (required for edit mode)
   - initialContent?: string (JSON string)
   - initialEmbeds?: VideoEmbed[]

   Component state:
   - content: object | null (Tiptap JSON)
   - embeds: VideoEmbed[]
   - isSubmitting: boolean
   - error: string | null

   handleSubmit:
   - Set isSubmitting true
   - Create FormData with JSON.stringify(content) and JSON.stringify(embeds)
   - Call createPost or updatePost based on mode
   - Handle error response
   - On success: router.push('/feed') for create, router.push(`/feed/${postId}`) for edit
   - revalidate via router.refresh()

   Render:
   - Form with onSubmit={handleSubmit}
   - PostEditor with onChange={(json) => setContent(json)}
   - VideoInput with onAdd={(embed) => setEmbeds([...embeds, embed])}
   - Display added embeds with remove button for each
   - Submit button ("Post" for create, "Save" for edit)
   - Error display if error exists

2. Create src/app/(main)/feed/page.tsx as server component:

   Imports:
   - db from '@/lib/db'
   - getServerSession from 'next-auth'
   - authOptions from '@/lib/auth'
   - PostCard from '@/components/feed/post-card'
   - PostForm from '@/components/feed/post-form'
   - Pagination from '@/components/ui/pagination'

   Constants:
   - POSTS_PER_PAGE = 10 (per CONTEXT.md)

   Page props:
   - searchParams: Promise<{ page?: string }>

   Fetch data:
   - Parse page number from searchParams (default 1)
   - Calculate skip = (page - 1) * POSTS_PER_PAGE
   - Fetch posts with db.post.findMany:
     - skip, take: POSTS_PER_PAGE
     - orderBy: { createdAt: 'desc' }
     - include: { author: { select: { id, name, image } } }
   - Fetch total count with db.post.count()
   - Calculate totalPages = Math.ceil(total / POSTS_PER_PAGE)
   - Get session for currentUserId

   Render:
   - Container max-w-2xl mx-auto
   - PostForm mode="create" at top (always visible)
   - Divider
   - Posts list: map posts to PostCard with showActions and currentUserId
   - Pagination component if totalPages > 1
   - Empty state if no posts
  </action>
  <verify>
    - `npm run build` passes
    - Navigate to /feed, see post form and empty state or existing posts
    - Create a post, it appears at top of feed
    - Pagination shows when >10 posts
  </verify>
  <done>
    - PostForm combines editor, video inputs, and submit logic
    - Feed page fetches posts with pagination
    - New posts appear in feed after creation
    - Pagination works correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create post detail and edit pages</name>
  <files>
    src/app/(main)/feed/[id]/page.tsx
    src/app/(main)/feed/[id]/edit/page.tsx
  </files>
  <action>
1. Create src/app/(main)/feed/[id]/page.tsx as server component:

   Imports:
   - notFound from 'next/navigation'
   - db from '@/lib/db'
   - getServerSession from 'next-auth'
   - authOptions from '@/lib/auth'
   - PostCard from '@/components/feed/post-card'
   - DeletePostButton from '@/components/feed/delete-post-button'
   - Link from 'next/link'

   Page props:
   - params: Promise<{ id: string }>

   Fetch post:
   - await params to get id
   - db.post.findUnique({ where: { id }, include: { author: { select: { id, name, image } } } })
   - If !post: notFound()
   - Get session for currentUserId

   Render:
   - Container max-w-2xl mx-auto
   - Back link to /feed
   - PostCard with post data
   - If currentUserId === post.authorId:
     - Edit link to /feed/${id}/edit
     - DeletePostButton with postId

2. Create src/app/(main)/feed/[id]/edit/page.tsx as server component:

   Imports:
   - notFound, redirect from 'next/navigation'
   - db from '@/lib/db'
   - getServerSession from 'next-auth'
   - authOptions from '@/lib/auth'
   - PostForm from '@/components/feed/post-form'
   - Link from 'next/link'

   Page props:
   - params: Promise<{ id: string }>

   Fetch and authorize:
   - await params to get id
   - Get session - if !session, redirect to /login
   - db.post.findUnique({ where: { id } })
   - If !post: notFound()
   - If post.authorId !== session.user.id: redirect to /feed/${id} (not authorized)

   Render:
   - Container max-w-2xl mx-auto
   - Back link to /feed/${id}
   - Heading "Edit Post"
   - PostForm with:
     - mode="edit"
     - postId={id}
     - initialContent={JSON.stringify(post.content)}
     - initialEmbeds={post.embeds as VideoEmbed[]}

CRITICAL: Edit page must verify post.authorId === session.user.id before allowing edit.
  </action>
  <verify>
    - `npm run build` passes
    - Navigate to /feed/[id], see post detail with edit/delete for author
    - Navigate to /feed/[id]/edit as author, see pre-filled form
    - Navigate to /feed/[id]/edit as non-author, get redirected
    - Save edits, see updated content
  </verify>
  <done>
    - Post detail page shows single post with back link
    - Edit/delete actions visible only to post author
    - Edit page pre-fills form with existing content
    - Authorization prevents editing others' posts
  </done>
</task>

<task type="auto">
  <name>Task 3: Create delete functionality</name>
  <files>
    src/components/feed/delete-post-button.tsx
  </files>
  <action>
Create src/components/feed/delete-post-button.tsx as client component:

1. Add 'use client' directive

2. Imports:
   - useState from 'react'
   - useRouter from 'next/navigation'
   - deletePost from '@/lib/post-actions'
   - Button from '@/components/ui/button'

3. DeletePostButtonProps interface:
   - postId: string

4. Component state:
   - isConfirming: boolean (show confirm dialog)
   - isDeleting: boolean (loading state)
   - error: string | null

5. handleDelete function:
   - Set isDeleting true
   - Call deletePost(postId)
   - If error response: setError(error), setIsDeleting(false)
   - If success: router.push('/feed'), router.refresh()

6. Render logic:
   - If !isConfirming:
     - Red "Delete" button that sets isConfirming=true

   - If isConfirming:
     - Confirmation UI:
       - Text: "Are you sure you want to delete this post?"
       - "Cancel" button (sets isConfirming=false)
       - "Delete" button (calls handleDelete, shows loading state)
     - Error message if error exists

7. Styling:
   - Delete button: text-red-600 hover:text-red-700
   - Confirm delete button: bg-red-600 hover:bg-red-700 text-white
   - Cancel button: secondary style
   - Disable buttons when isDeleting

Note: This is a simple inline confirmation. No modal needed - keep it lightweight.
  </action>
  <verify>
    - `npm run build` passes
    - Click Delete, see confirmation
    - Click Cancel, confirmation hides
    - Click confirm Delete, post is deleted, redirected to /feed
  </verify>
  <done>
    - Delete button shows confirmation before deleting
    - Cancel dismisses confirmation
    - Confirm deletes post and redirects to feed
    - Loading state prevents double-clicks
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds with no errors
2. Complete user journey test:
   - Go to /feed
   - Create a post with text and video embed
   - See post in feed
   - Click post to view detail
   - Edit post, save changes
   - Delete post, confirm deleted
3. Pagination works with multiple posts
4. Non-authors cannot edit/delete others' posts
</verification>

<success_criteria>
- User can create posts with text and video embeds from /feed
- Feed displays posts newest-first with pagination (10/page)
- Post detail page shows full post with author actions
- Edit page pre-fills form and saves changes
- Delete has confirmation and removes post
- Authorization prevents unauthorized edit/delete
- All five phase requirements (FEED-01 through FEED-05) are met
</success_criteria>

<output>
After completion, create `.planning/phases/04-feed-core/04-03-SUMMARY.md`
</output>
