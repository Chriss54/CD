---
phase: 08-events-calendar
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/event.ts
  - src/lib/validations/event.ts
  - src/lib/event-actions.ts
  - src/app/(main)/admin/events/page.tsx
  - src/app/(main)/admin/events/[eventId]/page.tsx
  - src/components/admin/event-form.tsx
  - src/components/admin/event-card.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can create an event with title, description, and date/time"
    - "Admin can edit an existing event"
    - "Admin can delete an event"
    - "Events store start/end times in UTC with @db.Timestamptz"
    - "Events support weekly/monthly recurrence"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Event model with RecurrenceType enum"
      contains: "model Event"
    - path: "src/lib/event-actions.ts"
      provides: "Event CRUD server actions"
      exports: ["createEvent", "updateEvent", "deleteEvent", "getEvents", "getEvent"]
    - path: "src/app/(main)/admin/events/page.tsx"
      provides: "Admin event list page"
      min_lines: 30
    - path: "src/components/admin/event-form.tsx"
      provides: "Event create/edit form with datetime inputs"
      min_lines: 80
  key_links:
    - from: "src/app/(main)/admin/events/page.tsx"
      to: "src/lib/event-actions.ts"
      via: "server action calls"
      pattern: "getEvents|createEvent"
    - from: "src/components/admin/event-form.tsx"
      to: "src/lib/validations/event.ts"
      via: "form validation"
      pattern: "eventSchema"
---

<objective>
Create the Event database model with recurrence support, implement server actions for CRUD operations, and build the admin interface for managing events.

Purpose: Establish the foundation for the events calendar - admins need to create and manage events before users can view them.
Output: Working admin pages at /admin/events for listing events and /admin/events/[id] for editing events.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-events-calendar/08-CONTEXT.md
@.planning/phases/08-events-calendar/08-RESEARCH.md
@prisma/schema.prisma
@src/lib/course-actions.ts
@src/components/admin/course-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Event database model with RecurrenceType enum</name>
  <files>prisma/schema.prisma, src/types/event.ts</files>
  <action>
Add RecurrenceType enum and Event model to Prisma schema:

```prisma
// Events Calendar - Phase 08
enum RecurrenceType {
  NONE
  WEEKLY
  MONTHLY
}

model Event {
  id            String         @id @default(cuid())
  title         String         @db.VarChar(200)
  description   Json           // Tiptap JSON document
  startTime     DateTime       @db.Timestamptz(3)
  endTime       DateTime       @db.Timestamptz(3)
  location      String?        @db.VarChar(200)
  locationUrl   String?        @db.VarChar(500)
  coverImage    String?        // Supabase storage URL
  recurrence    RecurrenceType @default(NONE)
  recurrenceEnd DateTime?      @db.Timestamptz(3)

  createdById   String
  createdBy     User           @relation(fields: [createdById], references: [id])

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([startTime])
  @@index([createdById])
}
```

Add `events Event[]` relation to the User model.

IMPORTANT: Use `@db.Timestamptz(3)` for all datetime fields to store timezone-aware timestamps in UTC (per RESEARCH.md Pitfall 4).

Create src/types/event.ts with TypeScript types:
- RecurrenceType type matching Prisma enum
- EventWithCreator type (includes createdBy relation)

Run `npx prisma db push` to sync schema.
Run `npx prisma generate` to regenerate client.
  </action>
  <verify>
- `npx prisma db push` succeeds
- `npx prisma generate` succeeds
- TypeScript compiles without errors
  </verify>
  <done>Event model exists in database with RecurrenceType enum and proper timezone-aware timestamps</done>
</task>

<task type="auto">
  <name>Task 2: Create validation schemas and server actions</name>
  <files>src/lib/validations/event.ts, src/lib/event-actions.ts</files>
  <action>
Create validation schema in src/lib/validations/event.ts:
- eventSchema with fields:
  - title (required, 1-200 chars)
  - description (required, Tiptap JSON - use z.record for JSON object)
  - startTime (required, string - datetime-local format)
  - endTime (required, string - datetime-local format)
  - location (optional, max 200 chars)
  - locationUrl (optional, max 500 chars, valid URL if provided)
  - coverImage (optional, URL string)
  - recurrence (enum: NONE, WEEKLY, MONTHLY)
  - recurrenceEnd (optional, string - datetime-local format)
- Add refinement: endTime must be after startTime

Create src/lib/event-actions.ts with server actions:
- getEvents(rangeStart?: Date, rangeEnd?: Date): Returns events in date range, ordered by startTime
- getEvent(id): Returns single event with createdBy relation
- createEvent(formData): Creates event, converts local times to UTC using timezone from formData
- updateEvent(id, formData): Updates event, checks admin role
- deleteEvent(id): Deletes event, checks admin role

For timezone handling in createEvent/updateEvent:
1. Get timezone from formData.get('timezone')
2. Parse datetime strings with TZDate from @date-fns/tz (will be installed in 08-02, import conditionally or stub)
3. Store as UTC Date objects

NOTE: Since @date-fns/tz isn't installed yet, temporarily parse datetime strings directly:
```typescript
// Temporary until @date-fns/tz is installed in 08-02
const startTime = new Date(formData.get('startTime') as string);
```
The timezone conversion will be properly implemented when the library is added.

All actions must:
- Use 'use server' directive
- Check session exists and user has admin/owner role (pattern from category-actions.ts)
- Use Zod validation
- Call revalidatePath('/calendar') and revalidatePath('/admin/events')
  </action>
  <verify>
- TypeScript compiles
- Server actions export correctly
  </verify>
  <done>Event CRUD operations available as server actions with role-based access control</done>
</task>

<task type="auto">
  <name>Task 3: Create admin event list and edit pages</name>
  <files>src/app/(main)/admin/events/page.tsx, src/app/(main)/admin/events/[eventId]/page.tsx, src/components/admin/event-form.tsx, src/components/admin/event-card.tsx</files>
  <action>
Create /admin/events page:
- Server component that fetches events using getEvents()
- Grid of EventCard components
- "Create Event" button that links to /admin/events/new
- Use existing EmptyState component when no events

Create EventCard component:
- Shows event title, date/time (formatted with date-fns format())
- Location indicator if present
- Recurrence badge (Weekly/Monthly) if not NONE
- Link to /admin/events/[id] for editing
- Delete button with inline confirmation (pattern from course-card.tsx)

Create EventForm component (client component):
- Fields:
  - title (text input)
  - description (reuse LessonEditor component for Tiptap)
  - startTime (datetime-local input)
  - endTime (datetime-local input)
  - location (text input, optional)
  - locationUrl (text input, optional)
  - coverImage (file upload using existing avatar upload pattern, or URL input)
  - recurrence (select: None, Weekly, Monthly)
  - recurrenceEnd (datetime-local input, shown only when recurrence != NONE)
- Hidden input for timezone (populated via useEffect with Intl.DateTimeFormat().resolvedOptions().timeZone)
- Submit calls createEvent or updateEvent based on mode
- For edit mode, pre-populate form with existing event data
- Convert UTC dates to local datetime-local format for form display

Create /admin/events/[eventId]/page.tsx:
- Handles both "new" (create mode) and existing event IDs (edit mode)
- Server component that fetches event if editing
- Renders EventForm with appropriate props
- Back link to /admin/events

For datetime-local input formatting:
```typescript
// Convert Date to datetime-local value
function toDatetimeLocal(date: Date): string {
  return format(date, "yyyy-MM-dd'T'HH:mm");
}
```
  </action>
  <verify>
- Visit /admin/events - page renders without errors
- Can create a new event with title, dates, and description
- Can edit existing event
- Can delete events with confirmation
- Recurrence field shows/hides recurrenceEnd appropriately
- npm run build succeeds
  </verify>
  <done>Admin can manage events through /admin/events interface</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to /admin/events - should show empty state or event list
2. Click "Create Event" - form page loads
3. Fill in event: title "Weekly Standup", description (rich text), start time, end time
4. Set location "Zoom" with URL "https://zoom.us/j/123"
5. Set recurrence to "Weekly" - recurrenceEnd field appears
6. Submit - event created, redirects to list
7. Event card shows title, date, "Weekly" badge
8. Click event to edit - form pre-populated with data
9. Change title, save - change persists
10. Delete event - confirm, event removed
</verification>

<success_criteria>
- Event model exists in database with RecurrenceType enum
- Admin can create events at /admin/events/new
- Admin can edit events at /admin/events/[id]
- Admin can delete events with confirmation
- Events support weekly/monthly recurrence with optional end date
- Role-based access restricts actions to admin/owner
</success_criteria>

<output>
After completion, create `.planning/phases/08-events-calendar/08-01-SUMMARY.md`
</output>
