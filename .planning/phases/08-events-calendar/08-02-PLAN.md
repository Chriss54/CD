---
phase: 08-events-calendar
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - package.json
  - src/lib/timezone.ts
  - src/lib/event-actions.ts
  - src/components/calendar/calendar-grid.tsx
  - src/components/calendar/calendar-header.tsx
  - src/components/calendar/calendar-day-cell.tsx
  - src/components/calendar/event-list.tsx
  - src/components/calendar/event-card.tsx
  - src/components/calendar/view-toggle.tsx
  - src/components/calendar/event-time.tsx
  - src/app/(main)/calendar/page.tsx
  - src/app/(main)/events/[eventId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Events display correctly in the user's local timezone"
    - "User can view upcoming events in a calendar grid view"
    - "User can view upcoming events in a list view"
    - "User can toggle between calendar and list views"
    - "Calendar shows month view with event titles on day cells"
  artifacts:
    - path: "src/lib/timezone.ts"
      provides: "Timezone detection and conversion utilities"
      exports: ["useUserTimezone", "formatEventTime", "toLocalDatetimeString"]
    - path: "src/components/calendar/calendar-grid.tsx"
      provides: "Month view calendar grid component"
      min_lines: 60
    - path: "src/app/(main)/calendar/page.tsx"
      provides: "Events calendar page with view toggle"
      min_lines: 40
    - path: "src/app/(main)/events/[eventId]/page.tsx"
      provides: "Event detail page"
      min_lines: 40
  key_links:
    - from: "src/components/calendar/calendar-grid.tsx"
      to: "src/lib/timezone.ts"
      via: "timezone conversion"
      pattern: "useUserTimezone|TZDate"
    - from: "src/app/(main)/calendar/page.tsx"
      to: "src/lib/event-actions.ts"
      via: "fetch events"
      pattern: "getEvents"
---

<objective>
Install timezone library, create timezone utilities, and build the public-facing calendar UI with both calendar grid and list views.

Purpose: Users need to view upcoming events in their local timezone with intuitive calendar navigation.
Output: Working calendar page at /calendar with toggle between month grid and list views, plus event detail page at /events/[id].
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-events-calendar/08-CONTEXT.md
@.planning/phases/08-events-calendar/08-RESEARCH.md
@.planning/phases/08-events-calendar/08-01-SUMMARY.md
@src/lib/event-actions.ts
@src/types/event.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @date-fns/tz and create timezone utilities</name>
  <files>package.json, src/lib/timezone.ts, src/lib/event-actions.ts</files>
  <action>
Install the timezone library:
```bash
npm install @date-fns/tz
```

Create src/lib/timezone.ts with utilities:

```typescript
'use client';

import { TZDate } from '@date-fns/tz';
import { format } from 'date-fns';
import { useEffect, useState } from 'react';

// Hook to detect user's timezone (client-side only)
export function useUserTimezone(): string {
  const [timezone, setTimezone] = useState('UTC');
  useEffect(() => {
    setTimezone(Intl.DateTimeFormat().resolvedOptions().timeZone);
  }, []);
  return timezone;
}

// Hook to detect 12h vs 24h time preference
export function useTimeFormat(): '12' | '24' {
  const [timeFormat, setTimeFormat] = useState<'12' | '24'>('12');
  useEffect(() => {
    const resolved = Intl.DateTimeFormat(undefined, { hour: 'numeric' }).resolvedOptions();
    setTimeFormat(resolved.hour12 ? '12' : '24');
  }, []);
  return timeFormat;
}

// Format event time in user's timezone
export function formatEventTime(
  utcDate: Date,
  timezone: string,
  pattern: string = 'MMM d, yyyy h:mm a'
): string {
  const tzDate = new TZDate(utcDate, timezone);
  return format(tzDate, pattern);
}

// Convert UTC date to datetime-local input value in user's timezone
export function toLocalDatetimeString(utcDate: Date, timezone: string): string {
  const tzDate = new TZDate(utcDate, timezone);
  return format(tzDate, "yyyy-MM-dd'T'HH:mm");
}

// Get timezone as non-hook for server components (returns UTC for SSR safety)
export function getTimezone(): string {
  if (typeof window === 'undefined') return 'UTC';
  return Intl.DateTimeFormat().resolvedOptions().timeZone;
}
```

Update src/lib/event-actions.ts to use proper timezone conversion:
- In createEvent and updateEvent, use TZDate for parsing:
```typescript
import { TZDate } from '@date-fns/tz';

// In createEvent/updateEvent:
const timezone = formData.get('timezone') as string || 'UTC';
const startTimeLocal = formData.get('startTime') as string;
const endTimeLocal = formData.get('endTime') as string;

// Parse as local time in user's timezone, convert to UTC
const startTz = new TZDate(startTimeLocal, timezone);
const endTz = new TZDate(endTimeLocal, timezone);

// Store as UTC Date
const startTime = new Date(startTz.getTime());
const endTime = new Date(endTz.getTime());
```

Add getEventsForMonth(year: number, month: number) action for calendar view:
- Fetch events where startTime falls within the given month
- Include recurring events that would have occurrences in that month
- Return array of events with their occurrence dates

For recurring events, create a helper function:
```typescript
function getEventOccurrences(
  event: Event,
  rangeStart: Date,
  rangeEnd: Date
): { event: Event; occurrenceDate: Date }[] {
  // Generate occurrences for WEEKLY or MONTHLY recurrence
  // Return array of {event, occurrenceDate} pairs within range
}
```
  </action>
  <verify>
- `npm install @date-fns/tz` succeeds
- TypeScript compiles without errors
- Imports from '@date-fns/tz' resolve correctly
  </verify>
  <done>Timezone library installed and utilities created for timezone-aware date handling</done>
</task>

<task type="auto">
  <name>Task 2: Create calendar grid components</name>
  <files>src/components/calendar/calendar-grid.tsx, src/components/calendar/calendar-header.tsx, src/components/calendar/calendar-day-cell.tsx</files>
  <action>
Create src/components/calendar/calendar-header.tsx:
- Client component for month navigation
- Shows current month/year: "January 2026"
- Previous/Next month buttons (chevron icons)
- "Today" button to jump to current month
- Receives currentMonth (Date) and onMonthChange callback

Create src/components/calendar/calendar-day-cell.tsx:
- Receives: day (Date), events (array for that day), currentMonth (Date)
- Shows day number
- Dim styling for days outside current month (using isSameMonth from date-fns)
- Highlight styling for today (using isToday from date-fns)
- Shows up to 2-3 event titles truncated
- "+N more" indicator if more events exist
- Click on day could navigate to list view filtered to that day (or just show tooltip)

Create src/components/calendar/calendar-grid.tsx:
- Client component (uses hooks for timezone)
- Props: events array, currentMonth Date, onMonthChange function
- Uses date-fns to generate calendar grid:
  ```typescript
  import { startOfMonth, endOfMonth, startOfWeek, endOfWeek, eachDayOfInterval, isSameMonth, isToday, isSameDay } from 'date-fns';

  const monthStart = startOfMonth(currentMonth);
  const monthEnd = endOfMonth(currentMonth);
  const calendarStart = startOfWeek(monthStart);
  const calendarEnd = endOfWeek(monthEnd);
  const days = eachDayOfInterval({ start: calendarStart, end: calendarEnd });
  ```
- Renders 7-column grid with Tailwind:
  ```tsx
  <div className="grid grid-cols-7 gap-px bg-gray-200">
    {/* Header row: Sun, Mon, Tue, Wed, Thu, Fri, Sat */}
    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
      <div key={day} className="bg-gray-50 p-2 text-center text-sm font-medium text-gray-500">
        {day}
      </div>
    ))}
    {/* Day cells */}
    {days.map(day => (
      <CalendarDayCell
        key={day.toISOString()}
        day={day}
        events={getEventsForDay(day)}
        currentMonth={currentMonth}
      />
    ))}
  </div>
  ```
- Helper function to filter events for a specific day (considering timezone)

IMPORTANT: Use client component to avoid SSR hydration mismatch with dates (per RESEARCH.md Pitfall 5).
  </action>
  <verify>
- TypeScript compiles
- Components export correctly
- Calendar grid displays 42 cells (6 weeks) for any month
  </verify>
  <done>Calendar grid components created with month navigation and day cells showing events</done>
</task>

<task type="auto">
  <name>Task 3: Create list view and calendar page</name>
  <files>src/components/calendar/event-list.tsx, src/components/calendar/event-card.tsx, src/components/calendar/view-toggle.tsx, src/components/calendar/event-time.tsx, src/app/(main)/calendar/page.tsx, src/app/(main)/events/[eventId]/page.tsx</files>
  <action>
Create src/components/calendar/event-time.tsx:
- Client component for displaying event times in user's timezone
- Props: start (Date), end (Date)
- Uses useUserTimezone() and useTimeFormat() hooks
- Displays: "Friday, January 24, 2026" and "2:00 PM - 3:00 PM" (or 14:00 - 15:00)

Create src/components/calendar/event-card.tsx (public version, different from admin):
- Shows event title, date/time using EventTime component
- Location with link icon if locationUrl exists
- Recurrence badge if recurring
- Cover image thumbnail if exists
- Link to /events/[id] for details

Create src/components/calendar/event-list.tsx:
- Receives events array
- Groups events by date (today, tomorrow, this week, later)
- Renders EventCard for each event
- Shows "No upcoming events" if empty

Create src/components/calendar/view-toggle.tsx:
- Two buttons: Calendar icon (grid view), List icon (list view)
- Active state styling for current view
- Receives view ('calendar' | 'list') and onViewChange callback

Create src/app/(main)/calendar/page.tsx:
- Server component that fetches events for current month (expand range for list)
- Contains client wrapper component for interactivity
- Default view is 'calendar' (per CONTEXT.md)
- State: currentMonth (Date), view ('calendar' | 'list')
- Renders:
  - CalendarHeader with month navigation
  - ViewToggle
  - CalendarGrid (when view === 'calendar')
  - EventList (when view === 'list')
- URL params for view state (optional): ?view=list or ?view=calendar

Create src/app/(main)/events/[eventId]/page.tsx:
- Server component fetching event by ID
- Shows full event details:
  - Cover image (full width if exists)
  - Title
  - Date/time with EventTime component
  - Location with clickable link
  - Recurrence info
  - Description (render Tiptap JSON with read-only editor, pattern from 07-03)
- Back link to /calendar
- 404 if event not found
  </action>
  <verify>
- Visit /calendar - page renders with calendar grid by default
- Navigate months with prev/next buttons
- Toggle to list view - shows upcoming events
- Click event - navigates to /events/[id]
- Event detail page shows all event information
- Times display in user's local timezone
- npm run build succeeds
  </verify>
  <done>Calendar page with grid/list toggle and event detail page are complete</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to /calendar - should show month grid view by default
2. Current month displayed with correct days
3. Events appear on their scheduled days as truncated titles
4. Click prev/next to navigate months
5. Click "Today" to return to current month
6. Toggle to list view - events shown grouped by date
7. Event times show in local timezone (verify by comparing to UTC)
8. Click an event card - navigates to /events/[id]
9. Event detail page shows:
   - Cover image (if present)
   - Title, full date/time
   - Location with clickable link
   - Description rendered properly
10. Recurring events appear on multiple days in calendar
</verification>

<success_criteria>
- @date-fns/tz installed and working
- Calendar shows month grid with events on correct days
- List view shows upcoming events grouped by date
- View toggle switches between calendar and list
- Event times display in user's local timezone
- Event detail page shows complete event information
- Recurring events generate correct occurrences
</success_criteria>

<output>
After completion, create `.planning/phases/08-events-calendar/08-02-SUMMARY.md`
</output>
