---
phase: 07-classroom-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/enrollment-actions.ts
  - src/lib/progress-actions.ts
autonomous: true

must_haves:
  truths:
    - "Enrollment model exists with userId, courseId, enrolledAt fields"
    - "LessonProgress model exists with userId, lessonId, completedAt fields"
    - "Server actions exist for enrollment operations"
    - "Server actions exist for progress tracking operations"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Enrollment and LessonProgress models"
      contains: "model Enrollment"
    - path: "src/lib/enrollment-actions.ts"
      provides: "Enrollment CRUD operations"
      exports: ["enrollInCourse", "unenrollFromCourse", "getEnrollment", "getEnrolledCoursesWithProgress"]
    - path: "src/lib/progress-actions.ts"
      provides: "Lesson completion operations"
      exports: ["toggleLessonComplete", "getCompletedLessonIds", "getNextIncompleteLesson"]
  key_links:
    - from: "src/lib/enrollment-actions.ts"
      to: "prisma.enrollment"
      via: "database queries"
      pattern: "db\\.enrollment\\."
    - from: "src/lib/progress-actions.ts"
      to: "prisma.lessonProgress"
      via: "database queries"
      pattern: "db\\.lessonProgress\\."
---

<objective>
Add Enrollment and LessonProgress data models with server actions for the student classroom experience.

Purpose: Establish the data layer that enables users to enroll in courses and track lesson completion. This is the foundation for all student-facing classroom features.
Output: Prisma models migrated to database, server actions ready for UI consumption.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-classroom-experience/07-CONTEXT.md
@.planning/phases/07-classroom-experience/07-RESEARCH.md
@prisma/schema.prisma
@src/lib/course-actions.ts
@src/lib/like-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Enrollment and LessonProgress Prisma models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add two new models to the Prisma schema after the existing Attachment model:

1. **Enrollment model** - many-to-many join between User and Course:
   - id: String @id @default(cuid())
   - userId: String (relation to User, onDelete: Cascade)
   - courseId: String (relation to Course, onDelete: Cascade)
   - enrolledAt: DateTime @default(now())
   - @@unique([userId, courseId]) - prevent duplicate enrollments
   - @@index([userId]) and @@index([courseId])

2. **LessonProgress model** - tracks lesson completion per user:
   - id: String @id @default(cuid())
   - userId: String (relation to User, onDelete: Cascade)
   - lessonId: String (relation to Lesson, onDelete: Cascade)
   - completedAt: DateTime @default(now())
   - @@unique([userId, lessonId]) - one completion record per user-lesson pair
   - @@index([userId]) and @@index([lessonId])

3. Add relation fields to existing models:
   - User: enrollments Enrollment[], lessonProgress LessonProgress[]
   - Course: enrollments Enrollment[]
   - Lesson: progress LessonProgress[]

Run `npx prisma db push` to apply changes (development mode - no migration file needed).
  </action>
  <verify>Run `npx prisma db push` completes without errors. Run `npx prisma studio` and verify Enrollment and LessonProgress tables exist with correct columns.</verify>
  <done>Enrollment and LessonProgress models exist in database with proper relations and indexes.</done>
</task>

<task type="auto">
  <name>Task 2: Create enrollment server actions</name>
  <files>src/lib/enrollment-actions.ts</files>
  <action>
Create enrollment server actions file following the pattern from course-actions.ts:

1. **enrollInCourse(courseId: string)**
   - Get session, return error if not authenticated
   - Verify course exists AND status is PUBLISHED (security: don't allow enrolling in drafts)
   - Check not already enrolled (findUnique with userId_courseId)
   - Create Enrollment record
   - revalidatePath('/classroom') and revalidatePath(`/classroom/courses/${courseId}`)
   - Return { success: true }

2. **unenrollFromCourse(courseId: string)**
   - Get session, return error if not authenticated
   - Find enrollment, return error if not found
   - Delete Enrollment record (LessonProgress records preserved per CONTEXT.md)
   - revalidatePath for catalog and course
   - Return { success: true }

3. **getEnrollment(userId: string, courseId: string)**
   - Simple findUnique query
   - Return enrollment or null

4. **getEnrolledCoursesWithProgress(userId: string)**
   - Get all enrollments for user with course details
   - Include course.modules.lessons (only PUBLISHED status)
   - Query LessonProgress for user to get completed lesson IDs
   - Compute progressPercent for each course: (completedCount / totalLessons) * 100, rounded
   - Return array with course info + enrolledAt + progressPercent + completedLessons + totalLessons + nextLessonId

Use 'use server' directive at top. Import getServerSession, authOptions, db, revalidatePath.
  </action>
  <verify>TypeScript compiles without errors. Import the actions in a test file to verify exports work.</verify>
  <done>Four enrollment server actions exported and ready for UI consumption.</done>
</task>

<task type="auto">
  <name>Task 3: Create progress server actions</name>
  <files>src/lib/progress-actions.ts</files>
  <action>
Create lesson progress server actions following the togglePostLike pattern from like-actions.ts:

1. **toggleLessonComplete(lessonId: string)**
   - Get session, return error if not authenticated
   - Get lesson with module.courseId (for revalidation path)
   - Return error if lesson not found OR lesson.status !== 'PUBLISHED'
   - Verify user is enrolled in the course (security check)
   - Check if LessonProgress exists (findUnique with userId_lessonId)
   - If exists: delete it (uncomplete)
   - If not exists: create it (complete)
   - revalidatePath(`/classroom/courses/${courseId}`)
   - Return { success: true, completed: !existing }

2. **getCompletedLessonIds(userId: string, courseId: string)**
   - Get all lessons in course (through modules)
   - Get LessonProgress records for user where lessonId in those IDs
   - Return array of completed lesson IDs

3. **getNextIncompleteLesson(userId: string, courseId: string)**
   - Get course with modules (ordered by position) and lessons (ordered by position, status: PUBLISHED)
   - Get completed lesson IDs for user
   - Flatten to ordered array of lesson IDs
   - Find first ID not in completed set
   - Return { lessonId, moduleId } or null if all complete

Use 'use server' directive. Follow existing patterns for error handling and session checks.
  </action>
  <verify>TypeScript compiles without errors. Server actions are properly exported.</verify>
  <done>Three progress server actions exported: toggle, get completed IDs, get next incomplete.</done>
</task>

</tasks>

<verification>
Run these commands to verify the data layer is complete:

```bash
# Schema applied
npx prisma db push

# TypeScript compiles
npx tsc --noEmit

# Server actions importable
node -e "import('./src/lib/enrollment-actions.ts')" 2>/dev/null || echo "Use tsx or next build to verify"
```

Check Prisma Studio shows:
- Enrollment table with userId, courseId, enrolledAt columns
- LessonProgress table with userId, lessonId, completedAt columns
- Both have proper indexes visible
</verification>

<success_criteria>
- Enrollment model exists with composite unique constraint on [userId, courseId]
- LessonProgress model exists with composite unique constraint on [userId, lessonId]
- enrollInCourse action creates enrollment for published courses only
- unenrollFromCourse action deletes enrollment but preserves progress
- toggleLessonComplete action creates/deletes LessonProgress with enrollment check
- getEnrolledCoursesWithProgress returns courses with computed progress percentage
- All actions have proper authentication checks
- All actions call revalidatePath for affected routes
</success_criteria>

<output>
After completion, create `.planning/phases/07-classroom-experience/07-01-SUMMARY.md`
</output>
