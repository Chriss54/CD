---
phase: 07-classroom-experience
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/(main)/classroom/courses/[courseId]/layout.tsx
  - src/app/(main)/classroom/courses/[courseId]/page.tsx
  - src/app/(main)/classroom/courses/[courseId]/lessons/[lessonId]/page.tsx
  - src/components/classroom/curriculum-sidebar.tsx
  - src/components/classroom/enroll-button.tsx
  - src/components/classroom/mark-complete-button.tsx
autonomous: true

must_haves:
  truths:
    - "User can view course overview page with enrollment option"
    - "User can enroll in a course with one click"
    - "User can view lesson content after enrolling"
    - "User can mark lessons as complete with toggle button"
    - "Sidebar shows curriculum with completion checkmarks"
    - "Progress updates immediately via optimistic UI"
  artifacts:
    - path: "src/app/(main)/classroom/courses/[courseId]/layout.tsx"
      provides: "Student course layout with sidebar"
      min_lines: 40
    - path: "src/app/(main)/classroom/courses/[courseId]/page.tsx"
      provides: "Course overview/landing page"
      min_lines: 30
    - path: "src/app/(main)/classroom/courses/[courseId]/lessons/[lessonId]/page.tsx"
      provides: "Lesson viewer with completion toggle"
      min_lines: 40
    - path: "src/components/classroom/curriculum-sidebar.tsx"
      provides: "Lesson list with checkmarks"
      exports: ["CurriculumSidebar"]
    - path: "src/components/classroom/enroll-button.tsx"
      provides: "One-click enrollment button"
      exports: ["EnrollButton"]
    - path: "src/components/classroom/mark-complete-button.tsx"
      provides: "Lesson completion toggle with optimistic UI"
      exports: ["MarkCompleteButton"]
  key_links:
    - from: "src/components/classroom/mark-complete-button.tsx"
      to: "toggleLessonComplete"
      via: "server action call"
      pattern: "toggleLessonComplete"
    - from: "src/components/classroom/enroll-button.tsx"
      to: "enrollInCourse"
      via: "server action call"
      pattern: "enrollInCourse"
    - from: "src/app/(main)/classroom/courses/[courseId]/layout.tsx"
      to: "getCompletedLessonIds"
      via: "server component data fetch"
      pattern: "getCompletedLessonIds"
---

<objective>
Create the student course experience: enrollment flow, lesson viewing, and progress tracking.

Purpose: Enable users to enroll in courses (CLRM-07), view lessons, mark them complete (CLRM-08), and track progress (CLRM-09). This completes the student-facing classroom functionality.
Output: Complete learning experience with sidebar navigation, lesson viewer, and progress tracking.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-classroom-experience/07-CONTEXT.md
@.planning/phases/07-classroom-experience/07-RESEARCH.md
@.planning/phases/07-classroom-experience/07-01-SUMMARY.md
@src/app/(main)/admin/courses/[courseId]/layout.tsx
@src/components/feed/like-button.tsx
@src/lib/enrollment-actions.ts
@src/lib/progress-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EnrollButton and MarkCompleteButton components</name>
  <files>
    src/components/classroom/enroll-button.tsx
    src/components/classroom/mark-complete-button.tsx
  </files>
  <action>
**1. enroll-button.tsx** - One-click enrollment:
```typescript
'use client';
interface EnrollButtonProps {
  courseId: string;
  isEnrolled: boolean;
}
```
- Use useTransition for pending state
- If not enrolled: "Enroll" button, calls enrollInCourse(courseId)
- If enrolled: Show "Enrolled" badge (green) OR UnenrollButton
- For unenroll: inline confirmation pattern (click once shows "Unenroll?", click again confirms)
- Disable button during pending state
- Style: Primary button for enroll, muted for unenroll

**2. mark-complete-button.tsx** - Toggle with optimistic UI (follow LikeButton pattern):
```typescript
'use client';
interface MarkCompleteButtonProps {
  lessonId: string;
  initialCompleted: boolean;
}
```
- Use useOptimistic hook (like LikeButton uses)
- Use useTransition for pending state
- Toggle state optimistically on click
- Call toggleLessonComplete(lessonId) server action
- Button styling per CONTEXT.md:
  - Position: designed for top-right of lesson header
  - Not completed: gray background, "Mark Complete" text
  - Completed: green background with checkmark icon, "Completed" text
  - Pending: opacity-50, cursor-not-allowed
- Include "Next Lesson" link that appears after marking complete (optional, can be in parent)
  </action>
  <verify>Buttons render, click handlers work, optimistic updates reflect immediately.</verify>
  <done>Interactive enrollment and completion buttons with proper state management.</done>
</task>

<task type="auto">
  <name>Task 2: Create curriculum sidebar component</name>
  <files>src/components/classroom/curriculum-sidebar.tsx</files>
  <action>
Create sidebar showing course curriculum with completion status:

```typescript
interface CurriculumSidebarProps {
  courseId: string;
  courseTitle: string;
  modules: Array<{
    id: string;
    title: string;
    lessons: Array<{
      id: string;
      title: string;
      status: 'DRAFT' | 'PUBLISHED';
    }>;
  }>;
  completedLessonIds: string[];
  isEnrolled: boolean;
  currentLessonId?: string;
}
```

Structure:
1. Back link to /classroom (like admin sidebar has back to /admin/courses)
2. Course title (truncated with title attribute)
3. Modules list (collapsible sections):
   - Module title as header
   - Lessons as links within each module
   - Only show PUBLISHED lessons to students
4. For each lesson:
   - Green checkmark icon if lesson ID is in completedLessonIds
   - Link to /classroom/courses/[courseId]/lessons/[lessonId]
   - Highlight current lesson (if currentLessonId matches)
   - Text styling: completed = text-green-700, current = font-semibold
5. If not enrolled:
   - Show curriculum but lessons are not clickable
   - Or show "Enroll to access lessons" message

Style to match admin sidebar: w-72, border-r, bg-gray-50/50, overflow-y-auto
  </action>
  <verify>Sidebar renders modules and lessons correctly. Checkmarks appear for completed lessons. Links work.</verify>
  <done>Curriculum sidebar shows course structure with completion indicators.</done>
</task>

<task type="auto">
  <name>Task 3: Create student course layout and pages</name>
  <files>
    src/app/(main)/classroom/courses/[courseId]/layout.tsx
    src/app/(main)/classroom/courses/[courseId]/page.tsx
    src/app/(main)/classroom/courses/[courseId]/lessons/[lessonId]/page.tsx
  </files>
  <action>
**1. layout.tsx** - Student course layout (adapt from admin layout):
- Async Server Component
- Get session (redirect to login if not authenticated)
- Fetch course with getCourseWithLessons (reuse from course-actions.ts)
- Check course exists AND status is PUBLISHED (return notFound() otherwise)
- Check enrollment status with getEnrollment
- If enrolled, fetch completedLessonIds with getCompletedLessonIds
- Render:
  - Flex container (flex min-h-[calc(100vh-4rem)])
  - Sidebar: CurriculumSidebar with course data, enrollment status, completed IDs
  - Main content area: children

**2. page.tsx** - Course overview (enrollment landing):
- Async Server Component
- Get courseId from params
- Fetch course details (can reuse data from layout via context or refetch)
- Display:
  - Course title (h1)
  - Description (prose styling)
  - Lesson count summary
  - EnrollButton (shows "Enroll" or "Enrolled" based on status)
  - If enrolled: "Continue Learning" link to next incomplete lesson
  - If not enrolled: CTA explaining what they'll learn

**3. lessons/[lessonId]/page.tsx** - Lesson viewer:
- Async Server Component
- Get lessonId from params
- Verify user is enrolled (redirect to course overview if not)
- Verify lesson exists and is PUBLISHED
- Fetch lesson with content and video
- Check if lesson is completed (for MarkCompleteButton initial state)
- Render:
  - Header with lesson title and MarkCompleteButton (top-right per CONTEXT.md)
  - Video embed if videoUrl exists (reuse VideoEmbedPlayer from feed)
  - Rich text content (render Tiptap JSON with read-only editor or custom renderer)
  - "Next Lesson" button at bottom (if there is a next lesson)
  </action>
  <verify>All three routes work. Course overview shows enrollment option. Lessons show content with completion toggle. Non-enrolled users redirected appropriately.</verify>
  <done>Complete student course experience with layout, overview, and lesson viewer.</done>
</task>

</tasks>

<verification>
Manual testing flow:

1. **Unenrolled user visits course**
   - [ ] /classroom/courses/[id] shows course overview
   - [ ] "Enroll" button visible
   - [ ] Sidebar shows curriculum but lessons not clickable
   - [ ] Direct lesson URL redirects to overview

2. **User enrolls**
   - [ ] Click "Enroll" - immediate feedback
   - [ ] Button changes to "Enrolled"
   - [ ] Lessons become clickable in sidebar

3. **User views lesson**
   - [ ] Lesson content renders (text + video if present)
   - [ ] "Mark Complete" button in top-right
   - [ ] Clicking marks complete, button changes to "Completed"
   - [ ] Sidebar shows green checkmark for completed lesson

4. **Progress tracking**
   - [ ] Return to /classroom - progress bar reflects completion
   - [ ] Complete all lessons - 100% progress, "Completed" badge

5. **Completion toggle**
   - [ ] Can un-complete a lesson (click "Completed" toggles back)
   - [ ] Progress updates accordingly

```bash
# Build and type check
npm run build
npx tsc --noEmit
```
</verification>

<success_criteria>
- Course overview shows for unenrolled users with enrollment CTA
- One-click enrollment works, shows immediate feedback
- Enrolled users can access lessons
- Lesson viewer displays content and video correctly
- MarkCompleteButton uses optimistic UI (instant feedback)
- Sidebar shows checkmarks for completed lessons
- Non-enrolled users cannot access lesson content
- Draft courses/lessons not visible to students
- All routes handle edge cases (not found, not authorized)
</success_criteria>

<output>
After completion, create `.planning/phases/07-classroom-experience/07-03-SUMMARY.md`
</output>
