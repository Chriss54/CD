---
phase: 10-admin-moderation
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/lib/settings-actions.ts
  - src/app/(main)/admin/settings/page.tsx
  - src/components/admin/settings-form.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/header.tsx
autonomous: true

must_haves:
  truths:
    - "Owner can access community settings page"
    - "Owner can update community name and description"
    - "Owner can upload community logo"
    - "Community name displays in sidebar and header"
  artifacts:
    - path: "src/lib/settings-actions.ts"
      provides: "Settings server actions"
      exports: ["getCommunitySettings", "updateCommunitySettings"]
    - path: "src/app/(main)/admin/settings/page.tsx"
      provides: "Community settings page"
    - path: "src/components/admin/settings-form.tsx"
      provides: "Settings form component"
  key_links:
    - from: "src/lib/settings-actions.ts"
      to: "src/lib/audit-actions.ts"
      via: "logAuditEvent on settings update"
      pattern: "SETTINGS_UPDATED"
    - from: "src/components/layout/sidebar.tsx"
      to: "src/lib/settings-actions.ts"
      via: "getCommunitySettings for name"
      pattern: "getCommunitySettings|communitySettings"
---

<objective>
Implement community settings page for owner to configure community name, description, and logo.

Purpose: Allows the owner to customize the community branding. Per CONTEXT.md, only the owner can edit settings, and changes should reflect throughout the UI (sidebar, header).

Output: Community settings page, settings form, settings server actions, updated sidebar/header to show community name.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-admin-moderation/10-CONTEXT.md
@.planning/phases/10-admin-moderation/10-RESEARCH.md
@src/lib/permissions.ts
@src/lib/audit-actions.ts
@src/lib/profile-actions.ts (for upload pattern)
@src/components/layout/sidebar.tsx
@src/components/layout/header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Settings Server Actions</name>
  <files>src/lib/settings-actions.ts</files>
  <action>
Create server actions for community settings:

```typescript
'use server';

import { getServerSession } from 'next-auth';
import { revalidatePath } from 'next/cache';
import { z } from 'zod';
import { authOptions } from '@/lib/auth';
import db from '@/lib/db';
import { canEditSettings, type Role } from '@/lib/permissions';
import { logAuditEvent } from '@/lib/audit-actions';
import { createBrowserSupabaseClient } from '@/lib/supabase';

// Validation schema
const settingsSchema = z.object({
  name: z.string().min(1, 'Name is required').max(100, 'Name too long'),
  description: z.string().max(1000, 'Description too long').optional().nullable(),
});

// Get community settings (create default if not exists)
export async function getCommunitySettings() {
  // Upsert pattern to ensure settings always exist
  const settings = await db.communitySettings.upsert({
    where: { id: 'singleton' },
    update: {},
    create: {
      id: 'singleton',
      name: 'Community',
    },
    select: {
      name: true,
      description: true,
      logo: true,
      updatedAt: true,
    },
  });

  return settings;
}

// Update community settings (owner only)
export async function updateCommunitySettings(formData: FormData) {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) return { error: 'Not authenticated' };

  const userRole = session.user.role as Role;
  if (!canEditSettings(userRole)) {
    return { error: 'Not authorized - owner role required' };
  }

  const validatedFields = settingsSchema.safeParse({
    name: formData.get('name'),
    description: formData.get('description') || null,
  });

  if (!validatedFields.success) {
    return { error: validatedFields.error.flatten().fieldErrors };
  }

  const { name, description } = validatedFields.data;

  const currentSettings = await getCommunitySettings();

  await db.communitySettings.update({
    where: { id: 'singleton' },
    data: { name, description },
  });

  // Log audit event
  await logAuditEvent({
    actorId: session.user.id,
    action: 'SETTINGS_UPDATED',
    targetType: 'settings',
    targetId: 'singleton',
    metadata: {
      changes: {
        name: currentSettings.name !== name ? { from: currentSettings.name, to: name } : undefined,
        description: currentSettings.description !== description
          ? { from: currentSettings.description, to: description }
          : undefined,
      },
    },
  });

  // Revalidate pages that show community name
  revalidatePath('/');
  revalidatePath('/feed');
  revalidatePath('/admin/settings');

  return { success: true };
}

// Upload community logo (owner only)
export async function uploadCommunityLogo(formData: FormData) {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) return { error: 'Not authenticated' };

  const userRole = session.user.role as Role;
  if (!canEditSettings(userRole)) {
    return { error: 'Not authorized - owner role required' };
  }

  const file = formData.get('logo') as File | null;
  if (!file || file.size === 0) {
    return { error: 'No file provided' };
  }

  // Validate file
  const maxSize = 2 * 1024 * 1024; // 2MB
  if (file.size > maxSize) {
    return { error: 'File too large. Maximum size is 2MB.' };
  }

  const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/svg+xml'];
  if (!allowedTypes.includes(file.type)) {
    return { error: 'Invalid file type. Use JPEG, PNG, WebP, or SVG.' };
  }

  const supabase = createBrowserSupabaseClient();

  // Generate unique filename
  const ext = file.name.split('.').pop()?.toLowerCase() ?? 'png';
  const filename = `community-logo-${Date.now()}.${ext}`;

  // Upload to Supabase Storage
  const { error: uploadError } = await supabase.storage
    .from('avatars') // Reuse avatars bucket
    .upload(filename, file, {
      cacheControl: '3600',
      upsert: true,
    });

  if (uploadError) {
    console.error('Upload error:', uploadError);
    return { error: 'Failed to upload logo' };
  }

  // Get public URL
  const { data: { publicUrl } } = supabase.storage
    .from('avatars')
    .getPublicUrl(filename);

  // Update settings
  await db.communitySettings.update({
    where: { id: 'singleton' },
    data: { logo: publicUrl },
  });

  // Log audit event
  await logAuditEvent({
    actorId: session.user.id,
    action: 'SETTINGS_UPDATED',
    targetType: 'settings',
    targetId: 'singleton',
    metadata: { logoUpdated: true },
  });

  revalidatePath('/');
  revalidatePath('/feed');
  revalidatePath('/admin/settings');

  return { success: true, url: publicUrl };
}

// Remove community logo (owner only)
export async function removeCommunityLogo() {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) return { error: 'Not authenticated' };

  const userRole = session.user.role as Role;
  if (!canEditSettings(userRole)) {
    return { error: 'Not authorized - owner role required' };
  }

  await db.communitySettings.update({
    where: { id: 'singleton' },
    data: { logo: null },
  });

  await logAuditEvent({
    actorId: session.user.id,
    action: 'SETTINGS_UPDATED',
    targetType: 'settings',
    targetId: 'singleton',
    metadata: { logoRemoved: true },
  });

  revalidatePath('/');
  revalidatePath('/feed');
  revalidatePath('/admin/settings');

  return { success: true };
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - no TypeScript errors.</verify>
  <done>settings-actions.ts exports getCommunitySettings, updateCommunitySettings, uploadCommunityLogo, removeCommunityLogo.</done>
</task>

<task type="auto">
  <name>Task 2: Create Settings Page and Form</name>
  <files>src/app/(main)/admin/settings/page.tsx, src/components/admin/settings-form.tsx</files>
  <action>
**Create src/components/admin/settings-form.tsx:**

```typescript
'use client';

import { useState, useRef } from 'react';
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import { updateCommunitySettings, uploadCommunityLogo, removeCommunityLogo } from '@/lib/settings-actions';
import { toast } from 'sonner';

interface SettingsFormProps {
  initialSettings: {
    name: string;
    description: string | null;
    logo: string | null;
  };
}

export function SettingsForm({ initialSettings }: SettingsFormProps) {
  const [name, setName] = useState(initialSettings.name);
  const [description, setDescription] = useState(initialSettings.description ?? '');
  const [logo, setLogo] = useState(initialSettings.logo);
  const [isSaving, setIsSaving] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSaving(true);

    const formData = new FormData();
    formData.append('name', name);
    formData.append('description', description);

    const result = await updateCommunitySettings(formData);
    setIsSaving(false);

    if (result.error) {
      if (typeof result.error === 'string') {
        toast.error(result.error);
      } else {
        toast.error('Validation failed');
      }
    } else {
      toast.success('Settings updated');
    }
  };

  const handleLogoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setIsUploading(true);
    const formData = new FormData();
    formData.append('logo', file);

    const result = await uploadCommunityLogo(formData);
    setIsUploading(false);

    if (result.error) {
      toast.error(result.error);
    } else if (result.url) {
      setLogo(result.url);
      toast.success('Logo uploaded');
    }

    // Reset file input
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const handleRemoveLogo = async () => {
    setIsUploading(true);
    const result = await removeCommunityLogo();
    setIsUploading(false);

    if (result.error) {
      toast.error(result.error);
    } else {
      setLogo(null);
      toast.success('Logo removed');
    }
  };

  return (
    <div className="space-y-8">
      {/* Logo section */}
      <div className="bg-white border rounded-lg p-6">
        <h2 className="text-lg font-medium mb-4">Community Logo</h2>
        <div className="flex items-center gap-6">
          <div className="relative w-24 h-24 rounded-lg border bg-muted flex items-center justify-center overflow-hidden">
            {logo ? (
              <Image
                src={logo}
                alt="Community logo"
                fill
                className="object-cover"
              />
            ) : (
              <span className="text-3xl text-muted-foreground">
                {name[0]?.toUpperCase() ?? 'C'}
              </span>
            )}
          </div>
          <div className="space-y-2">
            <input
              ref={fileInputRef}
              type="file"
              accept="image/jpeg,image/png,image/webp,image/svg+xml"
              onChange={handleLogoUpload}
              className="hidden"
              id="logo-upload"
            />
            <Button
              type="button"
              variant="outline"
              onClick={() => fileInputRef.current?.click()}
              disabled={isUploading}
            >
              {isUploading ? 'Uploading...' : 'Upload Logo'}
            </Button>
            {logo && (
              <Button
                type="button"
                variant="ghost"
                onClick={handleRemoveLogo}
                disabled={isUploading}
                className="text-destructive hover:text-destructive"
              >
                Remove
              </Button>
            )}
            <p className="text-xs text-muted-foreground">
              JPEG, PNG, WebP, or SVG. Max 2MB.
            </p>
          </div>
        </div>
      </div>

      {/* Settings form */}
      <form onSubmit={handleSubmit} className="bg-white border rounded-lg p-6 space-y-4">
        <h2 className="text-lg font-medium mb-4">Community Details</h2>

        <div>
          <label htmlFor="name" className="block text-sm font-medium mb-1">
            Community Name <span className="text-destructive">*</span>
          </label>
          <input
            id="name"
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            className="w-full px-3 py-2 border rounded-md text-sm"
            maxLength={100}
            required
          />
        </div>

        <div>
          <label htmlFor="description" className="block text-sm font-medium mb-1">
            Description
          </label>
          <textarea
            id="description"
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            className="w-full px-3 py-2 border rounded-md text-sm min-h-[100px] resize-none"
            maxLength={1000}
            placeholder="Tell visitors about your community..."
          />
          <p className="text-xs text-muted-foreground mt-1">
            {description.length}/1000 characters
          </p>
        </div>

        <div className="pt-4">
          <Button type="submit" disabled={isSaving}>
            {isSaving ? 'Saving...' : 'Save Changes'}
          </Button>
        </div>
      </form>
    </div>
  );
}
```

**Create src/app/(main)/admin/settings/page.tsx:**

```typescript
import { Metadata } from 'next';
import { redirect } from 'next/navigation';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import db from '@/lib/db';
import { canEditSettings, type Role } from '@/lib/permissions';
import { getCommunitySettings } from '@/lib/settings-actions';
import { SettingsForm } from '@/components/admin/settings-form';

export const metadata: Metadata = {
  title: 'Community Settings | Admin',
};

export default async function AdminSettingsPage() {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) redirect('/login');

  const user = await db.user.findUnique({
    where: { id: session.user.id },
    select: { role: true },
  });

  const userRole = (user?.role ?? 'member') as Role;
  if (!canEditSettings(userRole)) {
    redirect('/admin/posts?error=unauthorized');
  }

  const settings = await getCommunitySettings();

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-xl font-semibold">Community Settings</h2>
        <p className="text-sm text-muted-foreground">
          Customize your community&apos;s name, description, and branding.
        </p>
      </div>

      <SettingsForm initialSettings={settings} />
    </div>
  );
}
```
  </action>
  <verify>
1. Run `npx tsc --noEmit` - no TypeScript errors
2. Run `npm run build` - builds successfully
3. Manual verification (after build passes):
   - Visit /admin/settings as owner - see settings form
   - Update community name - saves successfully
   - Update description - saves successfully
   - Upload logo - appears in form
   - Remove logo - logo removed
  </verify>
  <done>Settings page allows owner to update name, description, and logo.</done>
</task>

<task type="auto">
  <name>Task 3: Update Sidebar and Header with Community Name</name>
  <files>src/components/layout/sidebar.tsx, src/components/layout/header.tsx</files>
  <action>
**Update src/components/layout/sidebar.tsx:**

Update to fetch and display community name (and logo if set):

```typescript
import Image from 'next/image';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { NavLink } from './nav-link';
import { SidebarUserMenu } from '@/components/auth/sidebar-user-menu';
import db from '@/lib/db';

const navLinks = [
  { href: '/', label: 'Home' },
  { href: '/feed', label: 'Feed' },
  { href: '/classroom', label: 'Classroom' },
  { href: '/calendar', label: 'Calendar' },
  { href: '/leaderboard', label: 'Leaderboard' },
  { href: '/members', label: 'Members' },
];

export async function Sidebar() {
  const session = await getServerSession(authOptions);

  // Fetch community settings
  const settings = await db.communitySettings.findUnique({
    where: { id: 'singleton' },
    select: { name: true, logo: true },
  });
  const communityName = settings?.name ?? 'Community';
  const communityLogo = settings?.logo;

  // Check if user has admin/mod role for admin link visibility
  let showAdminLink = false;
  if (session?.user?.id) {
    const user = await db.user.findUnique({
      where: { id: session.user.id },
      select: { role: true },
    });
    const roleLevel: Record<string, number> = { owner: 4, admin: 3, moderator: 2, member: 1 };
    showAdminLink = (roleLevel[user?.role ?? 'member'] ?? 1) >= roleLevel.moderator;
  }

  return (
    <aside className="w-64 border-r border-border bg-muted/30 flex flex-col">
      {/* Logo/Brand */}
      <div className="h-16 flex items-center px-6 border-b border-border gap-3">
        {communityLogo ? (
          <div className="relative w-8 h-8 rounded overflow-hidden flex-shrink-0">
            <Image
              src={communityLogo}
              alt={communityName}
              fill
              className="object-cover"
            />
          </div>
        ) : null}
        <span className="text-xl font-bold text-foreground truncate">
          {communityName}
        </span>
      </div>

      {/* Navigation */}
      <nav className="flex-1 p-4 space-y-1">
        {navLinks.map((link) => (
          <NavLink key={link.href} {...link} />
        ))}
        {showAdminLink && (
          <NavLink href="/admin" label="Admin" />
        )}
      </nav>

      {/* User info from session */}
      <SidebarUserMenu />
    </aside>
  );
}
```

**Update src/components/layout/header.tsx:**

```typescript
import Image from 'next/image';
import { UserMenu } from '@/components/auth/user-menu';
import db from '@/lib/db';

export async function Header() {
  // Fetch community settings
  const settings = await db.communitySettings.findUnique({
    where: { id: 'singleton' },
    select: { name: true, logo: true },
  });
  const communityName = settings?.name ?? 'Community';
  const communityLogo = settings?.logo;

  return (
    <header className="h-16 border-b border-border bg-background flex items-center justify-between px-6">
      <div className="flex items-center gap-3">
        {communityLogo ? (
          <div className="relative w-8 h-8 rounded overflow-hidden flex-shrink-0">
            <Image
              src={communityLogo}
              alt={communityName}
              fill
              className="object-cover"
            />
          </div>
        ) : null}
        <h1 className="text-xl font-semibold">{communityName}</h1>
      </div>
      <div className="flex items-center gap-4">
        <UserMenu />
      </div>
    </header>
  );
}
```
  </action>
  <verify>
1. Run `npx tsc --noEmit` - no TypeScript errors
2. Run `npm run build` - builds successfully
3. Manual verification (after build passes):
   - Update community name in settings
   - Refresh any page - sidebar shows updated name
   - Header shows updated name
   - Upload logo - logo appears in sidebar and header
   - Remove logo - logo removed, just name shows
  </verify>
  <done>Sidebar and header display community name and logo from settings.</done>
</task>

</tasks>

<verification>
1. /admin/settings only accessible to owner role
2. Settings form shows current name, description, logo
3. Name and description update saves successfully
4. Logo upload works (appears in form)
5. Logo removal works
6. All settings changes create audit log entries
7. Sidebar shows community name and logo (if set)
8. Header shows community name and logo (if set)
</verification>

<success_criteria>
- Only owner can access /admin/settings
- Community name is editable (1-100 chars)
- Description is editable (0-1000 chars)
- Logo can be uploaded (JPEG, PNG, WebP, SVG, max 2MB)
- Logo can be removed
- All changes logged to audit log
- Community name displays in sidebar brand area
- Community name displays in header
- Logo displays alongside name when set
</success_criteria>

<output>
After completion, create `.planning/phases/10-admin-moderation/10-04-SUMMARY.md`
</output>
