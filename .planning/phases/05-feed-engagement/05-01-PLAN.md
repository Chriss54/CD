---
phase: 05-feed-engagement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/validations/comment.ts
  - src/lib/validations/category.ts
  - src/lib/comment-actions.ts
  - src/lib/like-actions.ts
  - src/lib/category-actions.ts
autonomous: true

must_haves:
  truths:
    - "Comment, PostLike, CommentLike, Category models exist in database"
    - "Server actions exist for comment CRUD operations"
    - "Server actions exist for like toggle operations"
    - "Server actions exist for admin category management"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Comment, PostLike, CommentLike, Category models"
      contains: "model Comment"
    - path: "src/lib/validations/comment.ts"
      provides: "Comment input validation"
      exports: ["commentSchema"]
    - path: "src/lib/validations/category.ts"
      provides: "Category input validation"
      exports: ["categorySchema"]
    - path: "src/lib/comment-actions.ts"
      provides: "Comment CRUD server actions"
      exports: ["createComment", "updateComment", "deleteComment"]
    - path: "src/lib/like-actions.ts"
      provides: "Like toggle server actions"
      exports: ["togglePostLike", "toggleCommentLike", "getPostLikers", "getCommentLikers"]
    - path: "src/lib/category-actions.ts"
      provides: "Category management server actions"
      exports: ["createCategory", "updateCategory", "deleteCategory", "getCategories"]
  key_links:
    - from: "src/lib/comment-actions.ts"
      to: "prisma/schema.prisma"
      via: "db.comment operations"
      pattern: "db\\.comment\\.(create|update|delete|find)"
    - from: "src/lib/like-actions.ts"
      to: "prisma/schema.prisma"
      via: "db.postLike and db.commentLike operations"
      pattern: "db\\.(postLike|commentLike)\\.(create|delete|find)"
---

<objective>
Add engagement models (Comment, PostLike, CommentLike, Category) to database and create server actions for all engagement operations.

Purpose: Enable backend support for comments, likes, and categories before building UI components
Output: Database schema with engagement models, validation schemas, and server actions for CRUD/toggle operations
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-feed-engagement/05-RESEARCH.md
@.planning/phases/04-feed-core/04-01-SUMMARY.md
@prisma/schema.prisma
@src/lib/post-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add engagement models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add four new models to the Prisma schema:

1. **Category model:**
   - id: String @id @default(cuid())
   - name: String @unique
   - color: String (hex color, e.g., "#6366f1")
   - posts: Post[] relation
   - createdAt, updatedAt timestamps

2. **Update Post model:**
   - Add categoryId: String? (nullable for existing posts)
   - Add category: Category? @relation with onDelete: SetNull
   - Add comments: Comment[] relation
   - Add likes: PostLike[] relation
   - Add @@index([categoryId])

3. **Comment model:**
   - id: String @id @default(cuid())
   - content: String @db.VarChar(2000) (plain text, no Tiptap)
   - authorId: String, postId: String
   - author: User relation with onDelete: Cascade
   - post: Post relation with onDelete: Cascade
   - likes: CommentLike[] relation
   - createdAt, updatedAt timestamps
   - @@index([postId]), @@index([authorId]), @@index([createdAt(sort: Desc)])

4. **PostLike model:**
   - id: String @id @default(cuid())
   - userId: String, postId: String
   - user: User relation, post: Post relation (both onDelete: Cascade)
   - createdAt timestamp
   - @@unique([userId, postId]) - prevents duplicate likes
   - @@index([postId]), @@index([userId])

5. **CommentLike model:**
   - id: String @id @default(cuid())
   - userId: String, commentId: String
   - user: User relation, comment: Comment relation (both onDelete: Cascade)
   - createdAt timestamp
   - @@unique([userId, commentId])
   - @@index([commentId]), @@index([userId])

6. **Update User model:**
   - Add comments: Comment[] relation
   - Add postLikes: PostLike[] relation
   - Add commentLikes: CommentLike[] relation

Run `npx prisma db push` to apply schema changes.
Run `npx prisma generate` to regenerate client.
  </action>
  <verify>npx prisma validate && npx prisma db push --accept-data-loss</verify>
  <done>Category, Comment, PostLike, CommentLike models exist. Post has categoryId. User has engagement relations.</done>
</task>

<task type="auto">
  <name>Task 2: Create validation schemas for comments and categories</name>
  <files>src/lib/validations/comment.ts, src/lib/validations/category.ts</files>
  <action>
Create two validation schema files:

**src/lib/validations/comment.ts:**
```typescript
import { z } from 'zod';

export const commentSchema = z.object({
  content: z
    .string()
    .min(1, 'Comment cannot be empty')
    .max(2000, 'Comment must be under 2000 characters')
    .trim(),
});

export type CommentInput = z.infer<typeof commentSchema>;
```

**src/lib/validations/category.ts:**
```typescript
import { z } from 'zod';

const hexColorRegex = /^#[0-9A-Fa-f]{6}$/;

export const categorySchema = z.object({
  name: z
    .string()
    .min(1, 'Category name is required')
    .max(50, 'Category name must be under 50 characters')
    .trim(),
  color: z
    .string()
    .regex(hexColorRegex, 'Color must be a valid hex color (e.g., #6366f1)'),
});

export type CategoryInput = z.infer<typeof categorySchema>;
```
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Comment and category validation schemas exist with proper constraints.</done>
</task>

<task type="auto">
  <name>Task 3: Create server actions for comments, likes, and categories</name>
  <files>src/lib/comment-actions.ts, src/lib/like-actions.ts, src/lib/category-actions.ts</files>
  <action>
Create three server action files following the pattern from post-actions.ts:

**src/lib/comment-actions.ts:**
- `createComment(postId: string, content: string)` - validate with commentSchema, create comment, revalidatePath
- `updateComment(commentId: string, content: string)` - ownership check (authorId === session.user.id), validate, update
- `deleteComment(commentId: string)` - ownership check, delete
- All return `{ success: true }` or `{ error: string }`
- Revalidate `/feed/[postId]` after mutations

**src/lib/like-actions.ts:**
- `togglePostLike(postId: string)` - find existing like by userId_postId, delete if exists, create if not
- `toggleCommentLike(commentId: string)` - find existing like by userId_commentId, delete if exists, create if not
- `getPostLikers(postId: string)` - return array of users who liked the post (id, name, image)
- `getCommentLikers(commentId: string)` - return array of users who liked the comment
- Use compound unique constraint for idempotent toggle
- Revalidate paths after mutations

**src/lib/category-actions.ts:**
- `getCategories()` - return all categories ordered by name
- `createCategory(formData: FormData)` - admin role check, validate with categorySchema, check for duplicate name, create
- `updateCategory(categoryId: string, formData: FormData)` - admin role check, validate, update
- `deleteCategory(categoryId: string)` - admin role check, delete (posts get categoryId set to null via onDelete: SetNull)
- Admin role check: query user.role, verify it's 'admin' or 'owner'
- All mutations revalidate `/admin/categories` and `/feed`
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Server actions exist for comment CRUD, like toggle, and admin category management with proper auth checks.</done>
</task>

</tasks>

<verification>
- [ ] `npx prisma validate` passes
- [ ] `npx prisma db push` succeeds
- [ ] `npx tsc --noEmit` passes with no type errors
- [ ] All server action files export expected functions
- [ ] Comment actions include ownership verification
- [ ] Like actions use compound unique constraint pattern
- [ ] Category actions include admin role check
</verification>

<success_criteria>
1. Database has Category, Comment, PostLike, CommentLike models
2. Post model has categoryId field with Category relation
3. User model has relations to comments and likes
4. Validation schemas enforce content limits and hex color format
5. Server actions are ready for UI components to use
</success_criteria>

<output>
After completion, create `.planning/phases/05-feed-engagement/05-01-SUMMARY.md`
</output>
