---
phase: 05-feed-engagement
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/feed/comment-card.tsx
  - src/components/feed/comment-form.tsx
  - src/components/feed/comment-list.tsx
  - src/app/(main)/feed/[id]/page.tsx
  - src/components/ui/empty-state.tsx
autonomous: true

must_haves:
  truths:
    - "User can add a comment to any post"
    - "User can edit their own comments"
    - "User can delete their own comments with inline confirmation"
    - "Comments display newest first"
    - "Post author's comments have subtle background highlight"
    - "Edited comments show 'edited' label"
  artifacts:
    - path: "src/components/feed/comment-card.tsx"
      provides: "Individual comment display with author highlight, edit/delete actions"
      min_lines: 60
    - path: "src/components/feed/comment-form.tsx"
      provides: "Comment input form with submit logic"
      min_lines: 40
    - path: "src/components/feed/comment-list.tsx"
      provides: "Flat comment list with empty state"
      min_lines: 30
    - path: "src/components/ui/empty-state.tsx"
      provides: "Reusable empty state component with icon, title, description"
      min_lines: 20
  key_links:
    - from: "src/components/feed/comment-form.tsx"
      to: "src/lib/comment-actions.ts"
      via: "createComment server action"
      pattern: "createComment"
    - from: "src/components/feed/comment-card.tsx"
      to: "src/lib/comment-actions.ts"
      via: "updateComment, deleteComment server actions"
      pattern: "(updateComment|deleteComment)"
    - from: "src/app/(main)/feed/[id]/page.tsx"
      to: "src/components/feed/comment-list.tsx"
      via: "CommentList component"
      pattern: "CommentList"
---

<objective>
Build the comment system UI with flat comment display, create/edit/delete functionality, and author highlighting.

Purpose: Enable users to engage with posts through comments per FEED-06 requirement
Output: Comment components integrated into post detail page with full CRUD support
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-feed-engagement/05-CONTEXT.md
@.planning/phases/05-feed-engagement/05-RESEARCH.md
@.planning/phases/05-feed-engagement/05-01-SUMMARY.md
@src/components/feed/delete-post-button.tsx
@src/app/(main)/feed/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EmptyState and CommentCard components</name>
  <files>src/components/ui/empty-state.tsx, src/components/feed/comment-card.tsx</files>
  <action>
**Create src/components/ui/empty-state.tsx:**
Reusable empty state component with:
- Props: icon (ReactNode optional), title (string), description (string optional), action (ReactNode optional)
- Centered layout with flex-col, text-center
- Icon in muted-foreground color with margin-bottom
- Title in text-lg font-medium
- Description in text-sm text-muted-foreground
- Action slot with margin-top

**Create src/components/feed/comment-card.tsx:**
Client component ('use client') with:
- Props: comment object (id, content, authorId, authorName, authorImage, createdAt, updatedAt), postAuthorId (for highlighting), currentUserId
- Display: Avatar, author name, relative timestamp (use date-fns formatDistanceToNow)
- Post author highlight: If comment.authorId === postAuthorId, add subtle bg-muted/50 background
- "edited" label: If updatedAt > createdAt (compare timestamps), show "(edited)" text after timestamp
- Edit mode: Toggle state to show inline textarea for editing, Save/Cancel buttons
- Delete: Follow inline confirmation pattern from delete-post-button.tsx (isConfirming state, Confirm/Cancel buttons)
- Call updateComment and deleteComment server actions
- Only show edit/delete buttons when currentUserId === comment.authorId
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>EmptyState component exists. CommentCard displays comment with author highlight, edit inline, and delete with confirmation.</done>
</task>

<task type="auto">
  <name>Task 2: Create CommentForm and CommentList components</name>
  <files>src/components/feed/comment-form.tsx, src/components/feed/comment-list.tsx</files>
  <action>
**Create src/components/feed/comment-form.tsx:**
Client component ('use client') with:
- Props: postId (string)
- State: content (string), isPending (from useTransition), error (string | null)
- Form with text input and submit button
- Clear form immediately on submit for UX
- Call createComment(postId, content) server action
- On error, restore content and show error message
- Disabled state during pending
- Max length 2000 characters (matching validation)
- Placeholder: "Write a comment..."

**Create src/components/feed/comment-list.tsx:**
Server component (no 'use client') with:
- Props: postId (string), postAuthorId (string), currentUserId (string | undefined)
- Fetch comments from database: db.comment.findMany where postId, orderBy createdAt desc, include author (id, name, image)
- Map to CommentCard components
- Empty state when no comments: Use EmptyState with "Be the first to comment" title
- Show CommentForm at bottom of list
- If user not logged in, show "Sign in to comment" message instead of form
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>CommentForm handles input/submit with error handling. CommentList fetches and displays comments with empty state.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate comments into post detail page</name>
  <files>src/app/(main)/feed/[id]/page.tsx</files>
  <action>
Update the post detail page to include the comment section:

1. Import CommentList component
2. After the PostCard display, add a section for comments:
   - Section heading: "Comments" with comment count from _count
   - Comment count shown in muted text, e.g., "Comments (3)"
   - Only show count when > 0 per CONTEXT.md
3. Pass required props to CommentList:
   - postId: post.id
   - postAuthorId: post.authorId
   - currentUserId: session?.user?.id
4. Update the post query to include:
   - _count: { select: { comments: true } }
5. Wrap CommentList in a div with appropriate spacing (e.g., mt-8 border-t pt-8)

The layout should be:
- Post content
- Author actions (edit/delete for post owner)
- Separator
- Comments heading with count
- CommentList (includes form at bottom)
  </action>
  <verify>npm run build && npm run lint</verify>
  <done>Post detail page shows comments section with heading, count, and CommentList component.</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes
- [ ] EmptyState component is reusable with icon/title/description/action props
- [ ] CommentCard shows author highlight when comment author is post author
- [ ] CommentCard shows "(edited)" for edited comments
- [ ] Edit mode works with inline textarea
- [ ] Delete uses inline confirmation pattern
- [ ] CommentForm clears on submit, shows errors
- [ ] CommentList shows empty state when no comments
- [ ] Post detail page includes comments section with count
</verification>

<success_criteria>
1. Users can add comments to posts via CommentForm
2. Comments display newest first in CommentList
3. Users can edit their own comments inline
4. Users can delete their own comments with confirmation
5. Post author's comments have visual distinction
6. Edited comments show "edited" indicator
7. Empty state encourages first comment
</success_criteria>

<output>
After completion, create `.planning/phases/05-feed-engagement/05-02-SUMMARY.md`
</output>
