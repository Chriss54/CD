---
phase: 12-search-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/XXXXXX_add_search_vectors/migration.sql
  - src/lib/tiptap-utils.ts
autonomous: true

must_haves:
  truths:
    - "Post table has plainText column for storing extracted text"
    - "Post, User, and Course tables have tsvector columns with GIN indexes"
    - "tsvector columns auto-update when source data changes (GENERATED ALWAYS AS)"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Schema with plainText and Unsupported tsvector columns"
      contains: "plainText"
    - path: "src/lib/tiptap-utils.ts"
      provides: "Tiptap JSON to plain text extraction"
      exports: ["extractPlainText"]
  key_links:
    - from: "prisma/schema.prisma"
      to: "migration.sql"
      via: "Prisma migration with manual SQL"
      pattern: "GENERATED ALWAYS AS"
---

<objective>
Add PostgreSQL Full-Text Search infrastructure with tsvector columns and GIN indexes.

Purpose: Enable sub-100ms search queries across Post, User, and Course tables with proper ranking by creating the database foundation for FTS.

Output: Schema with plainText column, tsvector columns, GIN indexes, and Tiptap text extraction utility.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-search-infrastructure/12-RESEARCH.md

@prisma/schema.prisma
@src/lib/post-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Tiptap text extraction utility</name>
  <files>src/lib/tiptap-utils.ts</files>
  <action>
Create `src/lib/tiptap-utils.ts` with an `extractPlainText` function that converts Tiptap JSON to plain text using `generateText()` from @tiptap/core.

```typescript
import { generateText } from '@tiptap/core';
import StarterKit from '@tiptap/starter-kit';

export function extractPlainText(content: unknown): string {
  try {
    return generateText(
      content as Parameters<typeof generateText>[0],
      [StarterKit]
    );
  } catch {
    return '';
  }
}
```

This utility will be used by post-actions.ts to populate the plainText column on create/update, and by the backfill script.

Note: @tiptap/core and @tiptap/starter-kit are already in package.json (v3.17.0).
  </action>
  <verify>
Run `npx tsc --noEmit` to verify the file compiles without errors.
  </verify>
  <done>
File exists at src/lib/tiptap-utils.ts and exports extractPlainText function that compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update schema with plainText and tsvector columns</name>
  <files>prisma/schema.prisma</files>
  <action>
Update prisma/schema.prisma to add:

1. **Post model changes:**
   - Add `plainText String? @db.Text` column (stores extracted Tiptap text)
   - Add `searchVector Unsupported("tsvector")?` column
   - Add `@@index([searchVector], type: Gin)` for GIN index hint

2. **User model changes:**
   - Add `searchVector Unsupported("tsvector")?` column
   - Add `@@index([searchVector], type: Gin)` for GIN index hint

3. **Course model changes:**
   - Add `searchVector Unsupported("tsvector")?` column
   - Add `@@index([searchVector], type: Gin)` for GIN index hint

Example for Post model:
```prisma
model Post {
  id         String    @id @default(cuid())
  content    Json      // Tiptap JSON document
  plainText  String?   @db.Text  // Extracted text for FTS
  embeds     Json      @default("[]")
  authorId   String
  // ... rest of fields ...

  searchVector Unsupported("tsvector")?

  // ... rest of relations and indexes ...
  @@index([searchVector], type: Gin)
}
```

Note: The @@index with type: Gin is a hint for the manual migration. Prisma won't create it automatically for Unsupported types.
  </action>
  <verify>
Run `npx prisma validate` to verify schema is valid.
  </verify>
  <done>
Schema has plainText column on Post, searchVector columns on Post/User/Course, all marked correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create migration with GENERATED columns and GIN indexes</name>
  <files>prisma/migrations/XXXXXX_add_search_vectors/migration.sql</files>
  <action>
Run `npx prisma migrate dev --name add_search_vectors --create-only` to generate the migration skeleton, then manually edit the migration.sql to add the GENERATED ALWAYS AS columns and GIN indexes.

The migration should contain:

```sql
-- Add plainText column to Post (Prisma will generate this)
ALTER TABLE "Post" ADD COLUMN "plainText" TEXT;

-- Add search_vector columns with GENERATED ALWAYS AS
-- Post: weight B for content (since posts don't have titles)
ALTER TABLE "Post" ADD COLUMN "searchVector" tsvector
  GENERATED ALWAYS AS (
    setweight(to_tsvector('english', coalesce("plainText", '')), 'B')
  ) STORED;

-- User: weight A for name (more important), weight B for bio
ALTER TABLE "User" ADD COLUMN "searchVector" tsvector
  GENERATED ALWAYS AS (
    setweight(to_tsvector('english', coalesce(name, '')), 'A') ||
    setweight(to_tsvector('english', coalesce(bio, '')), 'B')
  ) STORED;

-- Course: weight A for title, weight B for description
ALTER TABLE "Course" ADD COLUMN "searchVector" tsvector
  GENERATED ALWAYS AS (
    setweight(to_tsvector('english', coalesce(title, '')), 'A') ||
    setweight(to_tsvector('english', coalesce(description, '')), 'B')
  ) STORED;

-- Create GIN indexes for fast FTS queries
CREATE INDEX "Post_searchVector_idx" ON "Post" USING GIN ("searchVector");
CREATE INDEX "User_searchVector_idx" ON "User" USING GIN ("searchVector");
CREATE INDEX "Course_searchVector_idx" ON "Course" USING GIN ("searchVector");
```

After editing, run `npx prisma migrate dev` to apply the migration.

IMPORTANT: The GENERATED ALWAYS AS columns will auto-update when source columns change. User and Course vectors will work immediately. Post vectors require plainText to be populated (handled in Plan 02).
  </action>
  <verify>
Run `npx prisma migrate status` to confirm migration is applied. Connect to database and verify:
```sql
SELECT column_name, data_type FROM information_schema.columns
WHERE table_name IN ('Post', 'User', 'Course') AND column_name = 'searchVector';
```
Should return 3 rows with data_type = 'tsvector'.
  </verify>
  <done>
Migration applied successfully. Post/User/Course tables have searchVector columns of type tsvector with GIN indexes. User and Course searchVector columns auto-populate from existing name/bio/title/description data.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (TypeScript compiles)
2. `npx prisma validate` passes (schema is valid)
3. `npx prisma migrate status` shows migration applied
4. Database inspection shows tsvector columns exist with GIN indexes
5. User search works immediately: `SELECT * FROM "User" WHERE "searchVector" @@ websearch_to_tsquery('english', 'test');`
</verification>

<success_criteria>
- prisma/schema.prisma contains plainText on Post, searchVector on Post/User/Course
- src/lib/tiptap-utils.ts exports extractPlainText function
- Migration is applied, tsvector columns exist with GIN indexes
- User/Course searchVector auto-populates from existing data
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-search-infrastructure/12-01-SUMMARY.md`
</output>
