---
phase: 09-gamification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/gamification-config.ts
  - src/app/(main)/layout.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "PointsEvent model exists in schema for time-based tracking"
    - "Point values and level thresholds are configurable"
    - "Toast notifications are available app-wide"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "PointsEvent model with userId, amount, action, createdAt"
      contains: "model PointsEvent"
    - path: "src/lib/gamification-config.ts"
      provides: "POINTS, LEVEL_THRESHOLDS, calculateLevel, getPointsToNextLevel"
      exports: ["POINTS", "LEVEL_THRESHOLDS", "calculateLevel", "getPointsToNextLevel"]
    - path: "src/app/(main)/layout.tsx"
      provides: "Sonner Toaster component"
      contains: "Toaster"
  key_links:
    - from: "src/lib/gamification-config.ts"
      to: "LEVEL_THRESHOLDS array"
      via: "calculateLevel function"
      pattern: "calculateLevel.*LEVEL_THRESHOLDS"
---

<objective>
Set up gamification foundation: database schema for points tracking, configuration constants, and toast notification system.

Purpose: Establish the data layer and configuration that all gamification features depend on.
Output: PointsEvent model, gamification config with point values and level thresholds, Sonner toast setup.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-gamification/09-CONTEXT.md
@.planning/phases/09-gamification/09-RESEARCH.md
@prisma/schema.prisma
@src/app/(main)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PointsEvent model and run migration</name>
  <files>prisma/schema.prisma</files>
  <action>
Add PointsEvent model to schema.prisma for tracking when points are earned (needed for time-based leaderboards):

```prisma
model PointsEvent {
  id        String   @id @default(cuid())
  userId    String
  amount    Int
  action    String   // "POST_CREATED", "COMMENT_CREATED", "LIKE_RECEIVED", "LESSON_COMPLETED"
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([createdAt])
}
```

Also add the relation to User model:
```prisma
pointsEvents PointsEvent[]
```

Run `npx prisma db push` to sync schema with database.
  </action>
  <verify>
Run `npx prisma db push` completes without errors.
Run `npx prisma studio` and verify PointsEvent table exists.
  </verify>
  <done>PointsEvent model exists in schema with proper indexes, database synced</done>
</task>

<task type="auto">
  <name>Task 2: Create gamification configuration</name>
  <files>src/lib/gamification-config.ts</files>
  <action>
Create gamification-config.ts with point values, level thresholds, and utility functions:

```typescript
// Point values for each action
export const POINTS = {
  POST_CREATED: 5,
  COMMENT_CREATED: 2,
  LIKE_RECEIVED: 1,
  LESSON_COMPLETED: 10,
} as const;

// Exponential-ish curve for 10 levels
export const LEVEL_THRESHOLDS = [
  0,    // Level 1
  50,   // Level 2
  120,  // Level 3
  210,  // Level 4
  320,  // Level 5
  450,  // Level 6
  600,  // Level 7
  770,  // Level 8
  960,  // Level 9
  1170, // Level 10
] as const;

export function calculateLevel(points: number): number {
  for (let i = LEVEL_THRESHOLDS.length - 1; i >= 0; i--) {
    if (points >= LEVEL_THRESHOLDS[i]) {
      return i + 1;
    }
  }
  return 1;
}

export function getPointsToNextLevel(points: number, currentLevel: number): {
  current: number;
  required: number;
  progress: number;
} | null {
  if (currentLevel >= 10) return null; // Max level

  const currentThreshold = LEVEL_THRESHOLDS[currentLevel - 1];
  const nextThreshold = LEVEL_THRESHOLDS[currentLevel];
  const pointsInLevel = points - currentThreshold;
  const pointsNeeded = nextThreshold - currentThreshold;

  return {
    current: pointsInLevel,
    required: pointsNeeded,
    progress: (pointsInLevel / pointsNeeded) * 100,
  };
}
```
  </action>
  <verify>
TypeScript compiles without errors.
Import the module in another file to verify exports work.
  </verify>
  <done>gamification-config.ts exports POINTS, LEVEL_THRESHOLDS, calculateLevel, getPointsToNextLevel</done>
</task>

<task type="auto">
  <name>Task 3: Install Sonner and add Toaster to layout</name>
  <files>package.json, src/app/(main)/layout.tsx</files>
  <action>
1. Install Sonner:
```bash
npm install sonner
```

2. Add Toaster to the main layout (src/app/(main)/layout.tsx):
- Import `Toaster` from 'sonner'
- Add `<Toaster position="top-center" richColors />` inside the layout body, after the main content area

Position should be top-center for celebratory level-up toasts.
richColors enables the colorful success/error styles.
  </action>
  <verify>
Run `npm run dev` and verify no errors.
Open browser, check that Toaster component renders (no visible UI until toast is triggered).
Test toast works by temporarily adding `toast.success('test')` in a component.
  </verify>
  <done>Sonner installed, Toaster component added to layout, ready for toast notifications</done>
</task>

</tasks>

<verification>
1. `npx prisma db push` succeeds
2. `npm run build` completes without errors
3. gamification-config.ts exports all expected functions
4. Sonner Toaster is present in layout
</verification>

<success_criteria>
- PointsEvent model exists in Prisma schema with userId, amount, action, createdAt fields
- Database is synced with new model (prisma db push successful)
- gamification-config.ts exists with POINTS values, LEVEL_THRESHOLDS, calculateLevel(), getPointsToNextLevel()
- Sonner is installed and Toaster component is in the main layout
</success_criteria>

<output>
After completion, create `.planning/phases/09-gamification/09-01-SUMMARY.md`
</output>
