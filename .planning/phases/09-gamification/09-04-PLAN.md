---
phase: 09-gamification
plan: 04
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/lib/leaderboard-actions.ts
  - src/components/leaderboard/leaderboard-tabs.tsx
  - src/components/leaderboard/leaderboard-row.tsx
  - src/components/leaderboard/user-rank-card.tsx
  - src/app/(main)/leaderboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view leaderboard ranked by points"
    - "Leaderboard has tabs for All-time, This month, This day"
    - "Top 5 users shown per time period"
    - "Current user sees their own rank if not in top 5"
  artifacts:
    - path: "src/lib/leaderboard-actions.ts"
      provides: "Leaderboard queries with PostgreSQL RANK()"
      exports: ["getLeaderboard", "getUserRank"]
    - path: "src/components/leaderboard/leaderboard-tabs.tsx"
      provides: "Time period tab switcher"
      exports: ["LeaderboardTabs"]
    - path: "src/components/leaderboard/leaderboard-row.tsx"
      provides: "Single leaderboard entry row"
      exports: ["LeaderboardRow"]
    - path: "src/components/leaderboard/user-rank-card.tsx"
      provides: "Current user rank display"
      exports: ["UserRankCard"]
    - path: "src/app/(main)/leaderboard/page.tsx"
      provides: "/leaderboard route"
      contains: "LeaderboardTabs"
  key_links:
    - from: "src/app/(main)/leaderboard/page.tsx"
      to: "src/lib/leaderboard-actions.ts"
      via: "getLeaderboard import"
      pattern: "getLeaderboard"
    - from: "src/lib/leaderboard-actions.ts"
      to: "PostgreSQL RANK()"
      via: "$queryRaw"
      pattern: "RANK\\(\\).*OVER"
---

<objective>
Create leaderboard page with time-based ranking tabs using PostgreSQL RANK() function.

Purpose: Users can view community rankings by points across different time periods.
Output: /leaderboard page with All-time, This month, This day tabs, top 5 users, and current user rank.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-gamification/09-CONTEXT.md
@.planning/phases/09-gamification/09-RESEARCH.md
@.planning/phases/09-gamification/09-01-SUMMARY.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create leaderboard server actions with PostgreSQL RANK()</name>
  <files>src/lib/leaderboard-actions.ts</files>
  <action>
Create leaderboard-actions.ts with queries using PostgreSQL RANK() window function:

```typescript
'use server';

import db from '@/lib/db';
import { startOfDay, startOfMonth } from 'date-fns';

export type LeaderboardPeriod = 'all-time' | 'this-month' | 'this-day';

export type LeaderboardEntry = {
  id: string;
  name: string | null;
  image: string | null;
  points: number;
  level: number;
  rank: number;
};

// All-time leaderboard using cumulative User.points
export async function getLeaderboardAllTime(limit: number = 5): Promise<LeaderboardEntry[]> {
  const result = await db.$queryRaw<(Omit<LeaderboardEntry, 'rank'> & { rank: bigint })[]>`
    SELECT id, name, image, points, level,
      RANK() OVER (ORDER BY points DESC) as rank
    FROM "User"
    ORDER BY points DESC
    LIMIT ${limit}
  `;

  return result.map((r) => ({ ...r, rank: Number(r.rank) }));
}

// Time-based leaderboard using PointsEvent table
export async function getLeaderboardByPeriod(
  period: 'this-month' | 'this-day',
  limit: number = 5
): Promise<LeaderboardEntry[]> {
  const startDate = period === 'this-month' ? startOfMonth(new Date()) : startOfDay(new Date());

  const result = await db.$queryRaw<(Omit<LeaderboardEntry, 'rank'> & { rank: bigint })[]>`
    SELECT u.id, u.name, u.image, u.level,
      COALESCE(SUM(pe.amount), 0)::int as points,
      RANK() OVER (ORDER BY COALESCE(SUM(pe.amount), 0) DESC) as rank
    FROM "User" u
    LEFT JOIN "PointsEvent" pe ON pe."userId" = u.id AND pe."createdAt" >= ${startDate}
    GROUP BY u.id, u.name, u.image, u.level
    HAVING COALESCE(SUM(pe.amount), 0) > 0
    ORDER BY points DESC
    LIMIT ${limit}
  `;

  return result.map((r) => ({ ...r, rank: Number(r.rank) }));
}

// Get current user's rank for any period
export async function getUserRankAllTime(userId: string): Promise<LeaderboardEntry | null> {
  const result = await db.$queryRaw<(Omit<LeaderboardEntry, 'rank'> & { rank: bigint })[]>`
    SELECT id, name, image, points, level, rank FROM (
      SELECT id, name, image, points, level,
        RANK() OVER (ORDER BY points DESC) as rank
      FROM "User"
    ) ranked
    WHERE id = ${userId}
  `;

  return result[0] ? { ...result[0], rank: Number(result[0].rank) } : null;
}

export async function getUserRankByPeriod(
  userId: string,
  period: 'this-month' | 'this-day'
): Promise<LeaderboardEntry | null> {
  const startDate = period === 'this-month' ? startOfMonth(new Date()) : startOfDay(new Date());

  const result = await db.$queryRaw<(Omit<LeaderboardEntry, 'rank'> & { rank: bigint })[]>`
    SELECT id, name, image, level, points, rank FROM (
      SELECT u.id, u.name, u.image, u.level,
        COALESCE(SUM(pe.amount), 0)::int as points,
        RANK() OVER (ORDER BY COALESCE(SUM(pe.amount), 0) DESC) as rank
      FROM "User" u
      LEFT JOIN "PointsEvent" pe ON pe."userId" = u.id AND pe."createdAt" >= ${startDate}
      GROUP BY u.id, u.name, u.image, u.level
    ) ranked
    WHERE id = ${userId}
  `;

  return result[0] ? { ...result[0], rank: Number(result[0].rank) } : null;
}

// Unified getter
export async function getLeaderboard(
  period: LeaderboardPeriod,
  limit: number = 5
): Promise<LeaderboardEntry[]> {
  if (period === 'all-time') {
    return getLeaderboardAllTime(limit);
  }
  return getLeaderboardByPeriod(period, limit);
}

export async function getUserRank(
  userId: string,
  period: LeaderboardPeriod
): Promise<LeaderboardEntry | null> {
  if (period === 'all-time') {
    return getUserRankAllTime(userId);
  }
  return getUserRankByPeriod(userId, period);
}
```

Key points:
- All-time uses User.points (cumulative)
- This month/day uses PointsEvent table with date filtering
- RANK() handles ties correctly
- bigint from PostgreSQL is converted to Number
  </action>
  <verify>
TypeScript compiles without errors.
Test getLeaderboardAllTime() in a test route or via Prisma Studio.
  </verify>
  <done>leaderboard-actions.ts exports getLeaderboard and getUserRank with period support</done>
</task>

<task type="auto">
  <name>Task 2: Create leaderboard UI components</name>
  <files>src/components/leaderboard/leaderboard-tabs.tsx, src/components/leaderboard/leaderboard-row.tsx, src/components/leaderboard/user-rank-card.tsx</files>
  <action>
Create the leaderboard component directory and three components:

**src/components/leaderboard/leaderboard-tabs.tsx:**
```typescript
'use client';

import Link from 'next/link';
import { useSearchParams } from 'next/navigation';
import { cn } from '@/lib/utils';

const PERIODS = [
  { id: 'all-time', label: 'All-time' },
  { id: 'this-month', label: 'This month' },
  { id: 'this-day', label: 'This day' },
] as const;

export function LeaderboardTabs() {
  const searchParams = useSearchParams();
  const currentPeriod = searchParams.get('period') || 'all-time';

  return (
    <div className="flex gap-1 p-1 bg-muted rounded-lg">
      {PERIODS.map((period) => (
        <Link
          key={period.id}
          href={`/leaderboard?period=${period.id}`}
          className={cn(
            'px-4 py-2 text-sm font-medium rounded-md transition-colors',
            currentPeriod === period.id
              ? 'bg-background text-foreground shadow-sm'
              : 'text-muted-foreground hover:text-foreground'
          )}
        >
          {period.label}
        </Link>
      ))}
    </div>
  );
}
```

**src/components/leaderboard/leaderboard-row.tsx:**
```typescript
import Link from 'next/link';
import { Avatar } from '@/components/ui/avatar';
import { LevelBadge } from '@/components/gamification/level-badge';
import type { LeaderboardEntry } from '@/lib/leaderboard-actions';

interface LeaderboardRowProps {
  entry: LeaderboardEntry;
  highlight?: boolean;
}

export function LeaderboardRow({ entry, highlight = false }: LeaderboardRowProps) {
  return (
    <div
      className={cn(
        'flex items-center gap-4 p-4 rounded-lg',
        highlight ? 'bg-primary/5 border border-primary/20' : 'bg-muted/50'
      )}
    >
      {/* Rank */}
      <div className="w-8 text-center font-bold text-lg text-muted-foreground">
        #{entry.rank}
      </div>

      {/* User info */}
      <Link href={`/members/${entry.id}`} className="flex items-center gap-3 flex-1 min-w-0">
        <Avatar src={entry.image} name={entry.name} size="md" />
        <div className="flex items-center gap-2 min-w-0">
          <span className="font-medium truncate">{entry.name || 'Anonymous'}</span>
          <LevelBadge level={entry.level} size="sm" />
        </div>
      </Link>

      {/* Points */}
      <div className="text-right">
        <span className="font-bold">{entry.points}</span>
        <span className="text-muted-foreground text-sm ml-1">pts</span>
      </div>
    </div>
  );
}

// Need cn import
import { cn } from '@/lib/utils';
```

**src/components/leaderboard/user-rank-card.tsx:**
```typescript
import { Avatar } from '@/components/ui/avatar';
import { LevelBadge } from '@/components/gamification/level-badge';
import type { LeaderboardEntry } from '@/lib/leaderboard-actions';

interface UserRankCardProps {
  user: LeaderboardEntry;
}

export function UserRankCard({ user }: UserRankCardProps) {
  return (
    <div className="border rounded-lg p-4 bg-muted/30">
      <p className="text-sm text-muted-foreground mb-2">Your ranking</p>
      <div className="flex items-center gap-4">
        <div className="text-2xl font-bold text-primary">#{user.rank}</div>
        <div className="flex items-center gap-3 flex-1">
          <Avatar src={user.image} name={user.name} size="md" />
          <div className="flex items-center gap-2">
            <span className="font-medium">{user.name || 'Anonymous'}</span>
            <LevelBadge level={user.level} size="sm" />
          </div>
        </div>
        <div className="text-right">
          <span className="font-bold">{user.points}</span>
          <span className="text-muted-foreground text-sm ml-1">pts</span>
        </div>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
TypeScript compiles without errors.
Components can be imported from other files.
  </verify>
  <done>LeaderboardTabs, LeaderboardRow, and UserRankCard components created</done>
</task>

<task type="auto">
  <name>Task 3: Create /leaderboard page</name>
  <files>src/app/(main)/leaderboard/page.tsx</files>
  <action>
Create the leaderboard page with server-side data fetching:

```typescript
import { Suspense } from 'react';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { getLeaderboard, getUserRank, type LeaderboardPeriod } from '@/lib/leaderboard-actions';
import { LeaderboardTabs } from '@/components/leaderboard/leaderboard-tabs';
import { LeaderboardRow } from '@/components/leaderboard/leaderboard-row';
import { UserRankCard } from '@/components/leaderboard/user-rank-card';
import { EmptyState } from '@/components/ui/empty-state';

interface LeaderboardPageProps {
  searchParams: Promise<{ period?: string }>;
}

export default async function LeaderboardPage({ searchParams }: LeaderboardPageProps) {
  const { period: periodParam } = await searchParams;
  const period = (['all-time', 'this-month', 'this-day'].includes(periodParam || '')
    ? periodParam
    : 'all-time') as LeaderboardPeriod;

  const session = await getServerSession(authOptions);
  const userId = session?.user?.id;

  // Fetch leaderboard data
  const [leaders, currentUserRank] = await Promise.all([
    getLeaderboard(period, 5),
    userId ? getUserRank(userId, period) : null,
  ]);

  // Check if current user is in top 5
  const isInTopFive = currentUserRank && currentUserRank.rank <= 5;

  return (
    <div className="max-w-2xl mx-auto py-8 px-4">
      <h1 className="text-2xl font-bold mb-6">Leaderboard</h1>

      {/* Period tabs */}
      <Suspense fallback={<div className="h-10 bg-muted rounded-lg animate-pulse" />}>
        <LeaderboardTabs />
      </Suspense>

      {/* Leaderboard entries */}
      <div className="mt-6 space-y-2">
        {leaders.length === 0 ? (
          <EmptyState
            title="No rankings yet"
            description={
              period === 'all-time'
                ? 'Be the first to earn points!'
                : `No activity ${period === 'this-month' ? 'this month' : 'today'} yet.`
            }
          />
        ) : (
          leaders.map((entry) => (
            <LeaderboardRow
              key={entry.id}
              entry={entry}
              highlight={userId === entry.id}
            />
          ))
        )}
      </div>

      {/* Current user's rank (if not in top 5) */}
      {currentUserRank && !isInTopFive && currentUserRank.points > 0 && (
        <div className="mt-8">
          <UserRankCard user={currentUserRank} />
        </div>
      )}
    </div>
  );
}
```

Also add leaderboard link to the sidebar navigation:
- Edit src/components/layout/sidebar.tsx
- Add a "Leaderboard" link with trophy icon to the nav items
  </action>
  <verify>
Visit /leaderboard - page renders with tabs.
Click tabs - URL updates with period param.
Top 5 users displayed (or empty state).
If logged in and not in top 5, see "Your ranking" card at bottom.
  </verify>
  <done>/leaderboard page shows top 5 users with time period tabs and current user rank</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Visit /leaderboard - page loads with "All-time" tab selected
3. Click "This month" tab - URL changes, leaderboard updates
4. Click "This day" tab - URL changes, leaderboard updates
5. Top 5 users shown with rank, avatar, name, level badge, points
6. If current user not in top 5, their rank appears below
7. Empty state shown when no rankings for time period
</verification>

<success_criteria>
- /leaderboard page exists and is accessible
- Three tabs: All-time, This month, This day
- Tabs use URL search params (shareable links)
- Top 5 users displayed with rank, avatar, name, level, points
- PostgreSQL RANK() used for efficient ranking
- Current user's rank shown if not in top 5
- Empty state for periods with no activity
- Leaderboard link added to sidebar navigation
</success_criteria>

<output>
After completion, create `.planning/phases/09-gamification/09-04-SUMMARY.md`
</output>
