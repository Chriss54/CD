---
phase: 11-payments
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/lib/auth.ts
  - src/components/paywall/paywall-modal.tsx
  - src/app/(main)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Session includes hasMembership boolean field"
    - "Unpaid users see paywall modal with blurred background on protected pages"
    - "Paywall modal shows pricing and 'Get Started' button linking to /register"
    - "Users with active membership access all protected pages normally"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "Extended session type with hasMembership"
      contains: "hasMembership"
    - path: "src/components/paywall/paywall-modal.tsx"
      provides: "Paywall modal with pricing display"
      contains: "'use client'"
      min_lines: 40
    - path: "src/app/(main)/layout.tsx"
      provides: "Layout with paywall check for non-members"
      min_lines: 20
  key_links:
    - from: "src/lib/auth.ts"
      to: "prisma/schema.prisma"
      via: "membership status fetch in JWT callback"
      pattern: "db\\.membership\\.findUnique"
    - from: "src/app/(main)/layout.tsx"
      to: "src/components/paywall/paywall-modal.tsx"
      via: "conditional paywall render"
      pattern: "PaywallModal"
---

<objective>
Add membership status to session and implement paywall modal for access gating.

Purpose: Ensure unpaid users (those without active membership) see a paywall modal with blurred content when accessing protected pages, directing them to register/pay to gain full access.
Output: Session includes hasMembership field, paywall modal component, and main layout checks membership to show paywall.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-payments/11-CONTEXT.md
@.planning/phases/11-payments/11-RESEARCH.md

# Prior plan created Membership model
@.planning/phases/11-payments/11-01-SUMMARY.md
@src/lib/auth.ts
@src/app/(main)/layout.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend session with hasMembership field</name>
  <files>
    src/lib/auth.ts
  </files>
  <action>
    1. Extend NextAuth Session type declaration to include hasMembership:
       ```typescript
       declare module 'next-auth' {
         interface Session {
           user: {
             id: string;
             name?: string | null;
             email?: string | null;
             image?: string | null;
             role: Role;
             hasMembership: boolean;
           };
         }
       }
       ```

    2. Extend JWT type declaration:
       ```typescript
       declare module 'next-auth/jwt' {
         interface JWT {
           id: string;
           role: Role;
           hasMembership: boolean;
         }
       }
       ```

    3. Update jwt callback to fetch membership status:
       - When user logs in (user exists), query Membership table
       - Set token.hasMembership = membership?.status === 'ACTIVE'
       - On trigger === 'update', also refresh hasMembership from database

    4. Update session callback to pass hasMembership to session:
       - session.user.hasMembership = token.hasMembership as boolean

    Note: Import db from '@/lib/db' (already imported for role refresh)
  </action>
  <verify>
    - TypeScript compiles without errors
    - Log in with a user who has Membership record
    - Check session via getServerSession() - should have hasMembership: true
    - Create test user without Membership - session should have hasMembership: false
  </verify>
  <done>
    Session type extended with hasMembership boolean, JWT callback fetches membership status from database on login and update triggers
  </done>
</task>

<task type="auto">
  <name>Task 2: Create paywall modal and integrate into main layout</name>
  <files>
    src/components/paywall/paywall-modal.tsx
    src/app/(main)/layout.tsx
  </files>
  <action>
    1. Create paywall-modal.tsx:
       - 'use client' component
       - Props: isOpen (boolean)
       - If !isOpen, return null
       - Fixed overlay covering entire screen (inset-0, z-50)
       - Backdrop: semi-transparent white (bg-white/80) with backdrop-blur-sm
       - Modal card centered with max-w-md
       - Content:
         - "Become a Member" heading (text-2xl font-bold)
         - "Join our community to access all content, courses, and events." description
         - Plan display box: "Community Membership" with "$29/month" pricing
         - Button: "Get Started" that navigates to /register
       - Use existing Button component
       - Use useRouter from next/navigation for button click

    2. Update (main)/layout.tsx:
       - Import getServerSession and authOptions
       - Import PaywallModal
       - In layout component, call getServerSession(authOptions)
       - Check if session?.user?.hasMembership is false (or session is null)
       - If user is logged in but no membership: pass showPaywall=true to layout
       - Render PaywallModal at end of layout with isOpen={!hasMembership}
       - Keep existing sidebar and header structure

    Note: Users without session are redirected by middleware to /login, so the paywall only affects authenticated users without membership. For this mock payment flow, all new registrations get membership, so this primarily handles edge cases (existing users created before Phase 11, or future expired memberships).
  </action>
  <verify>
    - Visit / while logged in with membership - should see normal feed
    - Create a test user directly in database without Membership record
    - Log in as that user
    - Visit / - should see paywall modal with blurred content behind
    - Click "Get Started" - should navigate to /register
  </verify>
  <done>
    Paywall modal shows for logged-in users without active membership, displays pricing, "Get Started" button links to /register, content visible but blurred behind modal
  </done>
</task>

</tasks>

<verification>
1. Session verification:
   - Check session in a Server Component using getServerSession
   - Verify hasMembership is true for users with active Membership
   - Verify hasMembership is false for users without Membership record

2. Paywall behavior:
   - Normal user (with membership): Access all pages without paywall
   - User without membership: See paywall modal on protected pages
   - Paywall shows correct pricing ($29/month)
   - "Get Started" button navigates to /register

3. End-to-end flow:
   - Log out
   - Go to /register
   - Complete registration (creates User + Membership)
   - Land on / - no paywall, full access
</verification>

<success_criteria>
- Session type includes hasMembership: boolean
- JWT callback queries Membership table on login
- PaywallModal component displays with blurred background
- Paywall shows "Community Membership - $29/month" pricing
- Main layout conditionally shows paywall for users without membership
- Users with active membership have unrestricted access
</success_criteria>

<output>
After completion, create `.planning/phases/11-payments/11-02-SUMMARY.md`
</output>
