---
phase: 11-payments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/auth-actions.ts
  - src/lib/validations/auth.ts
  - src/app/(auth)/register/page.tsx
  - src/components/auth/registration-wizard.tsx
  - src/components/auth/step-indicator.tsx
  - src/components/auth/registration-step-account.tsx
  - src/components/auth/registration-step-payment.tsx
  - src/components/auth/registration-success.tsx
autonomous: true

must_haves:
  truths:
    - "New user sees Account step first during registration"
    - "After completing Account step, user sees Payment step with price display"
    - "Payment step has 'Complete Payment' button with 1-2s loading delay"
    - "After mock payment, user sees success page with checkmark"
    - "User can navigate back from Payment step to edit account info"
    - "Account is only created after successful mock payment completion"
    - "User is auto-signed-in after registration and redirected to feed"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Membership model and MembershipStatus enum"
      contains: "model Membership"
    - path: "src/components/auth/registration-wizard.tsx"
      provides: "Multi-step registration orchestrator"
      contains: "'use client'"
      min_lines: 50
    - path: "src/components/auth/step-indicator.tsx"
      provides: "Visual step progress indicator"
      min_lines: 20
    - path: "src/components/auth/registration-step-account.tsx"
      provides: "Account form step with name/email/password"
      contains: "useForm"
      min_lines: 50
    - path: "src/components/auth/registration-step-payment.tsx"
      provides: "Mock payment step with price display"
      min_lines: 30
    - path: "src/components/auth/registration-success.tsx"
      provides: "Success page with checkmark and countdown"
      min_lines: 30
    - path: "src/lib/auth-actions.ts"
      provides: "registerWithMembership server action"
      exports: ["registerWithMembership"]
  key_links:
    - from: "src/components/auth/registration-wizard.tsx"
      to: "src/components/auth/registration-step-account.tsx"
      via: "step state switch"
      pattern: "step.*account"
    - from: "src/components/auth/registration-wizard.tsx"
      to: "src/lib/auth-actions.ts"
      via: "atomic registration"
      pattern: "registerWithMembership"
    - from: "src/lib/auth-actions.ts"
      to: "prisma/schema.prisma"
      via: "User + Membership atomic creation"
      pattern: "membership.*create"
---

<objective>
Transform single-step registration into multi-step wizard with mock payment.

Purpose: Implement the mock payment UI during registration (Account -> Payment -> Success) so new users complete a payment step before gaining access. Account creation is deferred until mock payment completes.
Output: Multi-step registration wizard with step indicator, payment step showing "$29/month", and success page with auto-redirect.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-payments/11-CONTEXT.md
@.planning/phases/11-payments/11-RESEARCH.md

# Existing auth implementation
@src/components/auth/register-form.tsx
@src/lib/auth-actions.ts
@src/lib/validations/auth.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Membership model and registerWithMembership action</name>
  <files>
    prisma/schema.prisma
    src/lib/auth-actions.ts
    src/lib/validations/auth.ts
  </files>
  <action>
    1. Add Membership model to schema.prisma:
       ```prisma
       enum MembershipStatus {
         ACTIVE
         EXPIRED
         CANCELLED
       }

       model Membership {
         id        String           @id @default(cuid())
         userId    String           @unique
         user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
         status    MembershipStatus @default(ACTIVE)
         planName  String           @default("Community Membership")
         paidAt    DateTime         @default(now())
         expiresAt DateTime?        // null = no expiration (for mock payments)

         createdAt DateTime         @default(now())
         updatedAt DateTime         @updatedAt

         @@index([userId])
         @@index([status])
       }
       ```

    2. Add relation on User model:
       ```prisma
       membership     Membership?
       ```

    3. Run `npx prisma db push` to sync schema

    4. In auth-actions.ts, add new server action `registerWithMembership`:
       - Takes typed data object (not FormData) with name, email, password
       - Validates using registerSchema
       - Checks for existing user (returns field error if exists)
       - Creates User AND Membership atomically using Prisma's nested create
       - Returns { success: true, userId } on success
       - Returns { error: { field: ['message'] } } on validation/duplicate errors

    5. Keep existing `registerUser` function unchanged (backward compatibility during transition)

    6. Import MembershipStatus enum from generated prisma client if needed for type safety
  </action>
  <verify>
    - Run `npx prisma db push` - should succeed
    - Run `npx prisma studio` - should show Membership table in schema
    - TypeScript compiles without errors
  </verify>
  <done>
    Membership model exists in schema with ACTIVE/EXPIRED/CANCELLED status enum, User has membership relation, registerWithMembership server action creates User+Membership atomically
  </done>
</task>

<task type="auto">
  <name>Task 2: Create multi-step registration wizard components</name>
  <files>
    src/components/auth/registration-wizard.tsx
    src/components/auth/step-indicator.tsx
    src/components/auth/registration-step-account.tsx
    src/components/auth/registration-step-payment.tsx
    src/components/auth/registration-success.tsx
    src/app/(auth)/register/page.tsx
  </files>
  <action>
    1. Create step-indicator.tsx:
       - Props: currentStep ('account' | 'payment' | 'success')
       - Display 3 steps with labels: Account, Payment, Complete
       - Active step highlighted with primary color (blue-600)
       - Completed steps show checkmark
       - Connecting lines between steps (colored when complete)
       - Use flexbox for horizontal layout

    2. Create registration-step-account.tsx:
       - Props: onComplete(data), defaultValues (for back navigation)
       - Use react-hook-form with zodResolver and existing registerSchema
       - Form fields: name, email, password (reuse existing input styling)
       - Submit button: "Continue to Payment"
       - On valid submit, call onComplete with form data

    3. Create registration-step-payment.tsx:
       - Props: onComplete(), onBack(), isProcessing
       - Display plan card: "Community Membership - $29/month"
       - Mock payment notice: "This is a mock payment. No real charges will be made."
       - Two buttons: "Back" (calls onBack), "Complete Payment" (calls onComplete)
       - Disable buttons when isProcessing=true
       - Show spinner + "Processing..." text on Complete button when processing

    4. Create registration-success.tsx:
       - Props: email, password (for auto sign-in)
       - Display checkmark icon in green circle
       - "Welcome to the Community!" heading
       - "Your account has been created successfully." message
       - Countdown display: "Redirecting in X seconds..."
       - useEffect to call signIn('credentials', { email, password, redirect: false })
       - Then countdown from 3 to 0, then router.push('/') and router.refresh()

    5. Create registration-wizard.tsx:
       - 'use client' component
       - State: step ('account' | 'payment' | 'success'), accountData, isProcessing
       - StepIndicator at top
       - Conditionally render step components based on step state
       - handleAccountComplete: save data, advance to payment
       - handlePaymentComplete: set processing, wait 1.5s, call registerWithMembership, if success advance to success
       - handleBack: go back to account (preserves accountData)
       - Pass accountData to success component for auto sign-in

    6. Update register/page.tsx:
       - Replace RegisterForm with RegistrationWizard
       - Keep existing layout and "Already have an account?" link
       - Update heading to just "Join the Community" (no longer just "Create an account")
  </action>
  <verify>
    - Visit /register - should show Account step with form
    - Fill form, click Continue - should show Payment step
    - Click Back - should return to Account with data preserved
    - Click Complete Payment - should show spinner, then Success page
    - Should auto-redirect to / after 3 seconds
    - New user should appear in database with Membership record
  </verify>
  <done>
    Multi-step registration wizard works: Account -> Payment -> Success, back navigation preserves data, mock payment has 1.5s delay, success auto-signs-in and redirects, User+Membership created atomically
  </done>
</task>

</tasks>

<verification>
1. Register flow complete:
   - Navigate to /register
   - See step indicator showing Account as active
   - Enter name, email, password
   - Click "Continue to Payment"
   - See Payment step with $29/month display
   - Click Back, verify data preserved
   - Click "Complete Payment"
   - See spinner for ~1.5s
   - See Success page with checkmark
   - Auto-redirect to / after 3 seconds

2. Database verification:
   - Check Prisma Studio for new User record
   - Check User has associated Membership record with status=ACTIVE

3. Session verification:
   - After redirect, user should be logged in (check user menu in header)
</verification>

<success_criteria>
- Step indicator shows progress through Account -> Payment -> Complete
- Account step collects name, email, password with validation
- Payment step displays "Community Membership - $29/month"
- Mock payment shows 1-2 second processing delay
- Success page shows checkmark and redirects after 3 seconds
- User + Membership created in single atomic operation
- User is signed in after registration completes
</success_criteria>

<output>
After completion, create `.planning/phases/11-payments/11-01-SUMMARY.md`
</output>
