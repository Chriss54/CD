---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - prisma/schema.prisma
  - prisma.config.ts
  - src/lib/db.ts
  - src/generated/prisma/
  - package.json
autonomous: false
user_setup:
  - service: supabase
    why: "PostgreSQL database for all application data"
    env_vars:
      - name: DATABASE_URL
        source: "Supabase Dashboard -> Project Settings -> Database -> Connection string (Transaction mode, port 6543)"
      - name: DIRECT_URL
        source: "Supabase Dashboard -> Project Settings -> Database -> Connection string (Session mode, port 5432)"
    dashboard_config:
      - task: "Create a new Supabase project"
        location: "https://supabase.com/dashboard -> New Project"

must_haves:
  truths:
    - "Prisma can connect to Supabase PostgreSQL"
    - "Database schema is migrated with all foundation models"
    - "Prisma client can query the database"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Database schema with User model"
      contains: "model User"
    - path: "src/lib/db.ts"
      provides: "Prisma singleton with driver adapter"
      contains: "PrismaPg"
    - path: "prisma.config.ts"
      provides: "Prisma CLI configuration"
      contains: "DIRECT_URL"
    - path: "src/generated/prisma/"
      provides: "Generated Prisma client"
  key_links:
    - from: "src/lib/db.ts"
      to: "DATABASE_URL"
      via: "Pool connection string"
      pattern: "process.env.DATABASE_URL"
    - from: "prisma.config.ts"
      to: "DIRECT_URL"
      via: "CLI connection"
      pattern: "DIRECT_URL"
---

<objective>
Configure Prisma 7 ORM with Supabase PostgreSQL connection and create the foundation database schema.

Purpose: Establish the database layer that all features depend on. Prisma 7 requires driver adapters (breaking change from v6), and Supabase requires dual connection strings for pooled runtime vs direct CLI access.

Output: Working Prisma setup with driver adapter, singleton pattern, and initial User model migrated to Supabase.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md

Key patterns from research:
- Prisma 7 REQUIRES driver adapters (@prisma/adapter-pg)
- Use "prisma-client" provider (not "prisma-client-js")
- Custom output path required: ../generated/prisma
- Supabase: port 6543 for pooled (runtime), port 5432 for direct (migrations)
- SSL: { rejectUnauthorized: false } required for Supabase
- Connection timeout: 5000ms to match Prisma v6 behavior
- Singleton pattern with globalThis for hot reload safety
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Prisma 7 with driver adapter dependencies</name>
  <files>
    package.json
    prisma/schema.prisma
    prisma.config.ts
  </files>
  <action>
Install Prisma 7 and its driver adapter:
```bash
npm install @prisma/client @prisma/adapter-pg pg dotenv
npm install -D prisma @types/pg
```

Initialize Prisma:
```bash
npx prisma init
```

Create prisma.config.ts for CLI configuration (Prisma 7 pattern):
```typescript
import { defineConfig, env } from 'prisma/config';
import 'dotenv/config';

export default defineConfig({
  schema: 'prisma/schema.prisma',
  datasource: {
    url: env('DIRECT_URL'), // Use direct connection for CLI (migrations)
  },
});
```

Update prisma/schema.prisma with Prisma 7 configuration:
```prisma
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // Connection URL configured in prisma.config.ts
}

// Foundation User model - expanded in later phases
model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  image          String?
  hashedPassword String?
  bio            String?   @db.VarChar(500)
  points         Int       @default(0)
  level          Int       @default(1)
  role           String    @default("member") // member, moderator, admin, owner

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([email])
  @@index([points])
}
```

Add src/generated/ to .gitignore (generated files should not be committed):
```
# Prisma generated client
src/generated/
```

IMPORTANT:
- Use "prisma-client" NOT "prisma-client-js" (Prisma 7 breaking change)
- Custom output path prevents ESLint/Turbopack issues with node_modules
  </action>
  <verify>
- `cat package.json | grep "@prisma/adapter-pg"` shows package installed
- `cat prisma/schema.prisma | grep 'provider = "prisma-client"'` shows correct provider
- `cat prisma.config.ts` contains "DIRECT_URL"
  </verify>
  <done>Prisma 7 installed with driver adapter, schema configured with User model</done>
</task>

<task type="auto">
  <name>Task 2: Create Prisma singleton with driver adapter</name>
  <files>
    src/lib/db.ts
  </files>
  <action>
Create src/lib/db.ts with Prisma 7 singleton pattern and driver adapter:
```typescript
import { PrismaClient } from '@/generated/prisma';
import { PrismaPg } from '@prisma/adapter-pg';
import { Pool } from 'pg';

const connectionString = process.env.DATABASE_URL;

if (!connectionString) {
  throw new Error('DATABASE_URL environment variable is not set');
}

const prismaClientSingleton = () => {
  const pool = new Pool({
    connectionString,
    // Match Prisma v6 timeout behavior
    connectionTimeoutMillis: 5000,
    // Required for Supabase SSL
    ssl: { rejectUnauthorized: false },
  });

  const adapter = new PrismaPg(pool);
  return new PrismaClient({ adapter });
};

declare const globalThis: {
  prismaGlobal: ReturnType<typeof prismaClientSingleton>;
} & typeof global;

const db = globalThis.prismaGlobal ?? prismaClientSingleton();

export default db;

if (process.env.NODE_ENV !== 'production') {
  globalThis.prismaGlobal = db;
}
```

CRITICAL: This singleton pattern prevents connection pool exhaustion during hot reloads in development.
  </action>
  <verify>
- `cat src/lib/db.ts` contains "PrismaPg"
- `cat src/lib/db.ts` contains "globalThis"
- `cat src/lib/db.ts` contains "ssl: { rejectUnauthorized: false }"
  </verify>
  <done>Prisma singleton with driver adapter and Supabase SSL configuration exists</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Configure Supabase environment</name>
  <what-needed>Supabase project with PostgreSQL connection strings</what-needed>
  <instructions>
1. Go to https://supabase.com/dashboard
2. Create a new project (or use existing)
3. Go to Project Settings -> Database
4. Copy the connection strings:
   - **Transaction mode (port 6543)** -> DATABASE_URL
   - **Session mode (port 5432)** -> DIRECT_URL
5. Create `.env.local` from the example:
   ```bash
   cp .env.local.example .env.local
   ```
6. Replace the placeholder values with your actual connection strings
7. Ensure the URLs have the correct format:
   - DATABASE_URL ends with `?pgbouncer=true`
   - DIRECT_URL uses port 5432

When ready, type "configured" to continue.
  </instructions>
  <resume-signal>Type "configured" when .env.local has valid Supabase credentials</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Generate Prisma client and run migration</name>
  <files>
    src/generated/prisma/
    prisma/migrations/
  </files>
  <action>
Generate the Prisma client:
```bash
npx prisma generate
```

Run the initial migration to create the User table:
```bash
npx prisma migrate dev --name init
```

Verify the connection and schema by opening Prisma Studio:
```bash
npx prisma studio
```
(This will open a browser window - close it after verifying)

Create a simple test to verify the connection works. Add a temporary test in the Next.js app by updating src/app/page.tsx to test the connection:
```typescript
import db from '@/lib/db';

export default async function Home() {
  // Test database connection
  const userCount = await db.user.count();

  return (
    <main className="flex min-h-screen flex-col items-center justify-center p-24">
      <h1 className="text-4xl font-bold mb-4">Community Platform</h1>
      <p className="text-muted-foreground">
        Database connected. Users: {userCount}
      </p>
    </main>
  );
}
```

This verifies the full stack: Next.js -> Prisma singleton -> Driver adapter -> Supabase PostgreSQL.
  </action>
  <verify>
- `ls src/generated/prisma/` shows generated files
- `ls prisma/migrations/` shows migration folder
- `npm run dev` - visiting localhost:3000 shows "Database connected. Users: 0"
  </verify>
  <done>Prisma client generated, migration applied, database connection verified in the app</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx prisma generate` - Generates client without errors
2. `npx prisma migrate status` - Shows migrations applied
3. `npx prisma studio` - Opens and shows User table
4. `npm run dev` - App connects to database and displays user count
5. No SSL or connection timeout errors in console
</verification>

<success_criteria>
- Prisma 7 installed with @prisma/adapter-pg driver adapter
- prisma/schema.prisma has User model with correct Prisma 7 syntax
- prisma.config.ts configures DIRECT_URL for CLI
- src/lib/db.ts exports Prisma singleton with SSL and timeout config
- src/generated/prisma/ contains generated client
- Migration successfully created User table in Supabase
- Next.js app can query the database
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
