---
phase: 03-profiles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/validations/profile.ts
  - src/lib/profile-actions.ts
  - next.config.ts
  - package.json
autonomous: true
user_setup:
  - service: supabase-storage
    why: "Avatar file uploads"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon public key"
    dashboard_config:
      - task: "Create 'avatars' storage bucket with public access"
        location: "Supabase Dashboard -> Storage -> New bucket -> Name: avatars, Public: true"

must_haves:
  truths:
    - "Profile updates persist to database"
    - "Avatar files upload to Supabase Storage"
    - "Validation rejects invalid profile data"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client"
      exports: ["createClient"]
    - path: "src/lib/profile-actions.ts"
      provides: "Profile update server actions"
      exports: ["updateProfile", "uploadAvatar"]
    - path: "src/lib/validations/profile.ts"
      provides: "Profile validation schemas"
      exports: ["profileSchema", "avatarSchema"]
  key_links:
    - from: "src/lib/profile-actions.ts"
      to: "prisma.user"
      via: "database update"
      pattern: "db\\.user\\.update"
    - from: "src/lib/profile-actions.ts"
      to: "supabase.storage"
      via: "file upload"
      pattern: "supabase\\.storage.*upload"
---

<objective>
Set up Supabase Storage clients and profile server actions for avatar uploads and profile updates.

Purpose: Establish the infrastructure for profile management - Supabase clients for file storage and server actions for profile CRUD operations.
Output: Supabase client utilities, profile validation schemas, and server actions for updateProfile and uploadAvatar.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-profiles/03-RESEARCH.md

# Existing patterns to follow
@src/lib/db.ts
@src/lib/auth-actions.ts
@src/lib/validations/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase packages and configure Next.js for remote images</name>
  <files>package.json, next.config.ts</files>
  <action>
Install @supabase/supabase-js and @supabase/ssr packages.

Update next.config.ts to allow images from Supabase Storage:
- Add images.remotePatterns for *.supabase.co hostname
- Pattern: protocol 'https', hostname '*.supabase.co', pathname '/storage/v1/object/public/**'
- Also add serverActions.bodySizeLimit: '5mb' in experimental for avatar uploads

Run: npm install @supabase/supabase-js @supabase/ssr
  </action>
  <verify>npm ls @supabase/supabase-js @supabase/ssr shows both installed. next.config.ts has remotePatterns for supabase.co.</verify>
  <done>Supabase packages installed, Next.js configured for Supabase images and 5MB uploads</done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase client utilities for browser and server</name>
  <files>src/lib/supabase/client.ts, src/lib/supabase/server.ts</files>
  <action>
Create src/lib/supabase/ directory with two client files:

**client.ts** (browser client):
- Import createBrowserClient from @supabase/ssr
- Export createClient function that returns createBrowserClient with NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY
- Use singleton pattern similar to db.ts

**server.ts** (server client):
- Import createServerClient from @supabase/ssr
- Import cookies from next/headers
- Export async createClient function that:
  - Awaits cookies() to get cookieStore
  - Returns createServerClient with cookie handlers for getAll/setAll
  - Uses same env vars as client

Pattern from research:
```typescript
// server.ts
export async function createClient() {
  const cookieStore = await cookies();
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll(); },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) =>
            cookieStore.set(name, value, options)
          );
        },
      },
    }
  );
}
```
  </action>
  <verify>TypeScript compiles without errors. Files export createClient functions.</verify>
  <done>Supabase clients ready for browser and server use</done>
</task>

<task type="auto">
  <name>Task 3: Create profile validation schemas and server actions</name>
  <files>src/lib/validations/profile.ts, src/lib/profile-actions.ts</files>
  <action>
**profile.ts validation schema:**
- profileSchema: { name: string min 2 max 50, bio: string max 500 (optional, allow empty) }
- Apply newline normalization transform to bio before length check (replace \r\n with \n)
- Export ProfileInput type

**profile-actions.ts server actions:**

1. **updateProfile(formData: FormData)**
   - Mark with 'use server'
   - Get session via getServerSession(authOptions), return error if not authenticated
   - Validate with profileSchema.safeParse
   - Update user via db.user.update with name and bio
   - Call revalidatePath for /profile/edit and /members/{userId}
   - Return { success: true }

2. **uploadAvatar(formData: FormData)**
   - Mark with 'use server'
   - Get session, validate file from formData.get('avatar')
   - Create server Supabase client
   - Generate unique filename: `${userId}/avatar-${Date.now()}.${ext}`
   - Upload to 'avatars' bucket with upsert: true
   - Get public URL via getPublicUrl
   - Update user.image in database
   - Revalidate paths
   - Return { success: true, url: publicUrl }

Follow auth-actions.ts patterns for error handling and FormData validation.
  </action>
  <verify>TypeScript compiles. Both server actions are exported. Validation handles edge cases (empty bio, newlines).</verify>
  <done>Profile validation and server actions ready for use by profile forms</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Supabase packages in node_modules
3. next.config.ts has remotePatterns for Supabase
4. All files created with correct exports
5. TypeScript shows no errors in profile-actions.ts
</verification>

<success_criteria>
- Supabase clients work for both browser and server contexts
- updateProfile server action updates name and bio in database
- uploadAvatar server action uploads to Supabase Storage and saves URL to user.image
- Validation rejects names < 2 chars, bios > 500 chars
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-profiles/03-01-SUMMARY.md`
</output>
