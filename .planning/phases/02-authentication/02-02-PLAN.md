---
phase: 02-authentication
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(auth)/layout.tsx
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/register/page.tsx
  - src/components/auth/login-form.tsx
  - src/components/auth/register-form.tsx
  - src/lib/auth-actions.ts
  - src/lib/validations/auth.ts
autonomous: true

must_haves:
  truths:
    - "User can create account with email and password"
    - "User can log in with email and password"
    - "Invalid credentials show generic error message"
    - "Successful login redirects to home page"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page"
      min_lines: 10
    - path: "src/app/(auth)/register/page.tsx"
      provides: "Registration page"
      min_lines: 10
    - path: "src/components/auth/login-form.tsx"
      provides: "Login form with validation"
      contains: "'use client'"
      min_lines: 40
    - path: "src/components/auth/register-form.tsx"
      provides: "Registration form with validation"
      contains: "'use client'"
      min_lines: 50
    - path: "src/lib/auth-actions.ts"
      provides: "Server actions for registration"
      contains: "'use server'"
      exports: ["registerUser"]
  key_links:
    - from: "src/components/auth/login-form.tsx"
      to: "next-auth/react"
      via: "signIn function"
      pattern: "signIn\\('credentials'"
    - from: "src/lib/auth-actions.ts"
      to: "src/lib/db.ts"
      via: "User creation"
      pattern: "db\\.user\\.create"
    - from: "src/lib/auth-actions.ts"
      to: "bcryptjs"
      via: "Password hashing"
      pattern: "bcrypt\\.hash"
---

<objective>
Create registration and login pages with forms in the (auth) route group.

Purpose: Enable users to create accounts and log in to access the platform.
Output: Working registration and login flows with proper validation and error handling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication/02-RESEARCH.md

# Prior plan in this phase
@.planning/phases/02-authentication/02-01-SUMMARY.md
@src/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth validation schemas and server actions</name>
  <files>src/lib/validations/auth.ts, src/lib/auth-actions.ts</files>
  <action>
Create `src/lib/validations/auth.ts`:
```typescript
import { z } from 'zod';

export const loginSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z.string().min(1, 'Password is required'),
});

export const registerSchema = z.object({
  name: z.string().min(2, 'Name must be at least 2 characters'),
  email: z.string().email('Invalid email address'),
  password: z.string().min(8, 'Password must be at least 8 characters'),
});

export type LoginInput = z.infer<typeof loginSchema>;
export type RegisterInput = z.infer<typeof registerSchema>;
```

Create `src/lib/auth-actions.ts`:
```typescript
'use server';

import { z } from 'zod';
import bcrypt from 'bcryptjs';
import db from '@/lib/db';
import { registerSchema } from '@/lib/validations/auth';

export async function registerUser(formData: FormData) {
  const validatedFields = registerSchema.safeParse({
    name: formData.get('name'),
    email: formData.get('email'),
    password: formData.get('password'),
  });

  if (!validatedFields.success) {
    return { error: validatedFields.error.flatten().fieldErrors };
  }

  const { name, email, password } = validatedFields.data;

  // Check if user exists
  const existingUser = await db.user.findUnique({
    where: { email },
  });

  if (existingUser) {
    return { error: { email: ['Email already in use'] } };
  }

  // Hash password with salt rounds of 10
  const hashedPassword = await bcrypt.hash(password, 10);

  await db.user.create({
    data: {
      name,
      email,
      hashedPassword,
    },
  });

  return { success: true };
}
```

SECURITY NOTE: Return generic "Email already in use" rather than revealing email enumeration attack vectors to sophisticated users. For basic registration UX, this message is acceptable.
  </action>
  <verify>
    - `src/lib/validations/auth.ts` exists with loginSchema and registerSchema
    - `src/lib/auth-actions.ts` exists with 'use server' directive
    - TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>Zod validation schemas and registerUser server action created</done>
</task>

<task type="auto">
  <name>Task 2: Create auth route group and form components</name>
  <files>src/app/(auth)/layout.tsx, src/components/auth/login-form.tsx, src/components/auth/register-form.tsx</files>
  <action>
Create `src/app/(auth)/layout.tsx`:
```typescript
export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="w-full max-w-md p-8 bg-white rounded-lg shadow-md">
        {children}
      </div>
    </div>
  );
}
```

Create `src/components/auth/login-form.tsx`:
```typescript
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { signIn } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { useState } from 'react';
import { loginSchema, type LoginInput } from '@/lib/validations/auth';
import { Button } from '@/components/ui/button';

export function LoginForm() {
  const router = useRouter();
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<LoginInput>({
    resolver: zodResolver(loginSchema),
  });

  const onSubmit = async (data: LoginInput) => {
    setIsLoading(true);
    setError(null);

    const result = await signIn('credentials', {
      email: data.email,
      password: data.password,
      redirect: false,
    });

    setIsLoading(false);

    if (result?.error) {
      setError('Invalid credentials');
      return;
    }

    router.push('/');
    router.refresh();
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
      {error && (
        <div className="p-3 bg-red-100 text-red-700 rounded text-sm">
          {error}
        </div>
      )}

      <div>
        <label htmlFor="email" className="block text-sm font-medium mb-1">
          Email
        </label>
        <input
          {...register('email')}
          type="email"
          id="email"
          className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="you@example.com"
        />
        {errors.email && (
          <p className="text-red-500 text-sm mt-1">{errors.email.message}</p>
        )}
      </div>

      <div>
        <label htmlFor="password" className="block text-sm font-medium mb-1">
          Password
        </label>
        <input
          {...register('password')}
          type="password"
          id="password"
          className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
        {errors.password && (
          <p className="text-red-500 text-sm mt-1">{errors.password.message}</p>
        )}
      </div>

      <Button type="submit" className="w-full" disabled={isLoading}>
        {isLoading ? 'Signing in...' : 'Sign in'}
      </Button>
    </form>
  );
}
```

Create `src/components/auth/register-form.tsx`:
```typescript
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { signIn } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { useState } from 'react';
import { registerSchema, type RegisterInput } from '@/lib/validations/auth';
import { registerUser } from '@/lib/auth-actions';
import { Button } from '@/components/ui/button';

export function RegisterForm() {
  const router = useRouter();
  const [error, setError] = useState<string | null>(null);
  const [fieldErrors, setFieldErrors] = useState<Record<string, string[]>>({});
  const [isLoading, setIsLoading] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<RegisterInput>({
    resolver: zodResolver(registerSchema),
  });

  const onSubmit = async (data: RegisterInput) => {
    setIsLoading(true);
    setError(null);
    setFieldErrors({});

    const formData = new FormData();
    formData.append('name', data.name);
    formData.append('email', data.email);
    formData.append('password', data.password);

    const result = await registerUser(formData);

    if (result.error) {
      setIsLoading(false);
      if (typeof result.error === 'object') {
        setFieldErrors(result.error);
      } else {
        setError('Registration failed');
      }
      return;
    }

    // Auto sign in after registration
    const signInResult = await signIn('credentials', {
      email: data.email,
      password: data.password,
      redirect: false,
    });

    setIsLoading(false);

    if (signInResult?.error) {
      setError('Account created but sign in failed. Please try logging in.');
      return;
    }

    router.push('/');
    router.refresh();
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
      {error && (
        <div className="p-3 bg-red-100 text-red-700 rounded text-sm">
          {error}
        </div>
      )}

      <div>
        <label htmlFor="name" className="block text-sm font-medium mb-1">
          Name
        </label>
        <input
          {...register('name')}
          type="text"
          id="name"
          className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="John Doe"
        />
        {(errors.name || fieldErrors.name) && (
          <p className="text-red-500 text-sm mt-1">
            {errors.name?.message || fieldErrors.name?.[0]}
          </p>
        )}
      </div>

      <div>
        <label htmlFor="email" className="block text-sm font-medium mb-1">
          Email
        </label>
        <input
          {...register('email')}
          type="email"
          id="email"
          className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="you@example.com"
        />
        {(errors.email || fieldErrors.email) && (
          <p className="text-red-500 text-sm mt-1">
            {errors.email?.message || fieldErrors.email?.[0]}
          </p>
        )}
      </div>

      <div>
        <label htmlFor="password" className="block text-sm font-medium mb-1">
          Password
        </label>
        <input
          {...register('password')}
          type="password"
          id="password"
          className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
        {(errors.password || fieldErrors.password) && (
          <p className="text-red-500 text-sm mt-1">
            {errors.password?.message || fieldErrors.password?.[0]}
          </p>
        )}
        <p className="text-gray-500 text-xs mt-1">At least 8 characters</p>
      </div>

      <Button type="submit" className="w-full" disabled={isLoading}>
        {isLoading ? 'Creating account...' : 'Create account'}
      </Button>
    </form>
  );
}
```
  </action>
  <verify>
    - `src/app/(auth)/layout.tsx` exists with centered card layout
    - `src/components/auth/login-form.tsx` exists with 'use client'
    - `src/components/auth/register-form.tsx` exists with 'use client'
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Auth route group layout and form components created</done>
</task>

<task type="auto">
  <name>Task 3: Create login and register pages</name>
  <files>src/app/(auth)/login/page.tsx, src/app/(auth)/register/page.tsx</files>
  <action>
Create `src/app/(auth)/login/page.tsx`:
```typescript
import Link from 'next/link';
import { LoginForm } from '@/components/auth/login-form';

export default function LoginPage() {
  return (
    <div className="space-y-6">
      <div className="text-center">
        <h1 className="text-2xl font-bold">Welcome back</h1>
        <p className="text-gray-600 mt-1">Sign in to your account</p>
      </div>

      <LoginForm />

      <div className="text-center text-sm">
        <Link href="/forgot-password" className="text-blue-600 hover:underline">
          Forgot password?
        </Link>
      </div>

      <div className="text-center text-sm text-gray-600">
        Don&apos;t have an account?{' '}
        <Link href="/register" className="text-blue-600 hover:underline">
          Sign up
        </Link>
      </div>
    </div>
  );
}
```

Create `src/app/(auth)/register/page.tsx`:
```typescript
import Link from 'next/link';
import { RegisterForm } from '@/components/auth/register-form';

export default function RegisterPage() {
  return (
    <div className="space-y-6">
      <div className="text-center">
        <h1 className="text-2xl font-bold">Create an account</h1>
        <p className="text-gray-600 mt-1">Join our community</p>
      </div>

      <RegisterForm />

      <div className="text-center text-sm text-gray-600">
        Already have an account?{' '}
        <Link href="/login" className="text-blue-600 hover:underline">
          Sign in
        </Link>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
    - `src/app/(auth)/login/page.tsx` exists as Server Component
    - `src/app/(auth)/register/page.tsx` exists as Server Component
    - `npm run build` succeeds
    - Visit `/login` - shows login form
    - Visit `/register` - shows registration form
  </verify>
  <done>Login and register pages created with links to each other and forgot password</done>
</task>

</tasks>

<verification>
1. Run `npm run build` - should complete without errors
2. Start dev server and test registration:
   - Visit `/register`
   - Enter name, email, password (8+ chars)
   - Click "Create account"
   - Should redirect to home page
3. Test login:
   - Visit `/login`
   - Enter registered email and password
   - Click "Sign in"
   - Should redirect to home page
4. Test invalid login:
   - Enter wrong email or password
   - Should see "Invalid credentials" error (generic message)
</verification>

<success_criteria>
- User can create account with name, email, password
- User can log in with email and password
- Invalid credentials show generic error
- Successful auth redirects to home
- Forms have client-side validation via Zod
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-02-SUMMARY.md`
</output>
