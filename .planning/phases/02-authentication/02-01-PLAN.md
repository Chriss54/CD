---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/auth.ts
  - src/app/api/auth/[...nextauth]/route.ts
  - src/app/providers.tsx
  - src/app/layout.tsx
  - .env.local
autonomous: true

must_haves:
  truths:
    - "NextAuth v4 installed and configured"
    - "Credentials provider validates email/password against database"
    - "JWT session strategy is active"
    - "SessionProvider wraps application"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "NextAuth configuration with credentials provider"
      exports: ["authOptions"]
      min_lines: 50
    - path: "src/app/api/auth/[...nextauth]/route.ts"
      provides: "NextAuth API route handler"
      exports: ["GET", "POST"]
    - path: "src/app/providers.tsx"
      provides: "SessionProvider wrapper component"
      contains: "SessionProvider"
  key_links:
    - from: "src/lib/auth.ts"
      to: "src/lib/db.ts"
      via: "Prisma client for user lookup"
      pattern: "db\\.user\\.findUnique"
    - from: "src/app/api/auth/[...nextauth]/route.ts"
      to: "src/lib/auth.ts"
      via: "authOptions import"
      pattern: "import.*authOptions.*from.*auth"
---

<objective>
Set up NextAuth v4 with credentials provider for email/password authentication.

Purpose: Establish authentication infrastructure that all auth features build upon.
Output: Working NextAuth configuration with JWT sessions, credentials provider, and SessionProvider.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-RESEARCH.md

# Prior phase context
@.planning/phases/01-foundation/01-02-SUMMARY.md
@src/lib/db.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install NextAuth v4 and dependencies</name>
  <files>package.json</files>
  <action>
Install authentication dependencies:
```bash
npm install next-auth@4 @auth/prisma-adapter bcryptjs
npm install -D @types/bcryptjs
```

CRITICAL: Add npm overrides for Next.js 16 compatibility. Add this to package.json:
```json
{
  "overrides": {
    "next-auth": {
      "next": "$next"
    }
  }
}
```

Run `npm install` again after adding overrides to ensure peer dependencies resolve.

Also install form validation libraries (needed by auth forms):
```bash
npm install zod react-hook-form @hookform/resolvers
```
  </action>
  <verify>
    - `npm ls next-auth` shows 4.24.x installed
    - `npm ls bcryptjs` shows installed
    - `npm ls zod` shows installed
    - No peer dependency warnings in npm output
  </verify>
  <done>NextAuth v4 and all auth dependencies installed with peer dependency overrides for Next.js 16</done>
</task>

<task type="auto">
  <name>Task 2: Create NextAuth configuration and API route</name>
  <files>src/lib/auth.ts, src/app/api/auth/[...nextauth]/route.ts, .env.local</files>
  <action>
Create `src/lib/auth.ts`:
```typescript
import { NextAuthOptions } from 'next-auth';
import CredentialsProvider from 'next-auth/providers/credentials';
import { PrismaAdapter } from '@auth/prisma-adapter';
import bcrypt from 'bcryptjs';
import db from '@/lib/db';

export const authOptions: NextAuthOptions = {
  adapter: PrismaAdapter(db),
  session: {
    strategy: 'jwt', // REQUIRED for credentials provider
    maxAge: 30 * 24 * 60 * 60, // 30 days
  },
  pages: {
    signIn: '/login',
    error: '/login',
  },
  providers: [
    CredentialsProvider({
      name: 'credentials',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) {
          return null;
        }

        const user = await db.user.findUnique({
          where: { email: credentials.email },
        });

        if (!user || !user.hashedPassword) {
          return null; // Generic null - don't reveal if email exists
        }

        const passwordMatch = await bcrypt.compare(
          credentials.password,
          user.hashedPassword
        );

        if (!passwordMatch) {
          return null;
        }

        return {
          id: user.id,
          email: user.email,
          name: user.name,
          image: user.image,
        };
      },
    }),
  ],
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id;
      }
      return token;
    },
    async session({ session, token }) {
      if (session.user) {
        session.user.id = token.id as string;
      }
      return session;
    },
  },
};
```

Create `src/app/api/auth/[...nextauth]/route.ts`:
```typescript
import NextAuth from 'next-auth';
import { authOptions } from '@/lib/auth';

const handler = NextAuth(authOptions);

export { handler as GET, handler as POST };
```

Add to `.env.local` (if not exists):
```
NEXTAUTH_SECRET=your-generated-secret-here
NEXTAUTH_URL=http://localhost:3000
```

Generate real secret:
```bash
openssl rand -base64 32
```

Use the generated value for NEXTAUTH_SECRET.
  </action>
  <verify>
    - `src/lib/auth.ts` exists with authOptions export
    - `src/app/api/auth/[...nextauth]/route.ts` exists
    - `.env.local` contains NEXTAUTH_SECRET and NEXTAUTH_URL
    - `npm run build` succeeds
  </verify>
  <done>NextAuth configured with credentials provider, JWT sessions, and custom login page path</done>
</task>

<task type="auto">
  <name>Task 3: Add SessionProvider to app</name>
  <files>src/app/providers.tsx, src/app/layout.tsx</files>
  <action>
Create `src/app/providers.tsx`:
```typescript
'use client';

import { SessionProvider } from 'next-auth/react';

interface ProvidersProps {
  children: React.ReactNode;
}

export function Providers({ children }: ProvidersProps) {
  return <SessionProvider>{children}</SessionProvider>;
}
```

Update `src/app/layout.tsx` to wrap children with Providers:
- Import Providers from './providers'
- Wrap {children} with <Providers>{children}</Providers>
- Keep existing font and metadata configuration

The structure should be:
```typescript
<html lang="en">
  <body className={/* existing classes */}>
    <Providers>
      {children}
    </Providers>
  </body>
</html>
```
  </action>
  <verify>
    - `src/app/providers.tsx` exists with 'use client' directive
    - `src/app/layout.tsx` imports and uses Providers
    - `npm run build` succeeds
    - `npm run dev` starts without errors
  </verify>
  <done>SessionProvider wraps entire application for client-side session access</done>
</task>

</tasks>

<verification>
1. Run `npm run build` - should complete without errors
2. Run `npm run dev` - should start without errors
3. Visit `http://localhost:3000/api/auth/providers` - should return JSON with credentials provider
4. Visit `http://localhost:3000/api/auth/csrf` - should return CSRF token
</verification>

<success_criteria>
- NextAuth v4 installed with peer dependency overrides
- authOptions exported from src/lib/auth.ts
- API route handles /api/auth/* requests
- SessionProvider wraps application
- Build and dev server run without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
