---
phase: 02-authentication
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - prisma/schema.prisma
  - src/lib/email.ts
  - src/lib/auth-actions.ts
  - src/app/(auth)/forgot-password/page.tsx
  - src/app/(auth)/reset-password/page.tsx
  - src/components/auth/forgot-password-form.tsx
  - src/components/auth/reset-password-form.tsx
  - .env.local
autonomous: true
user_setup:
  - service: resend
    why: "Transactional email for password reset"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify sending domain (or use onboarding@resend.dev for testing)"
        location: "Resend Dashboard -> Domains"

must_haves:
  truths:
    - "User can request password reset via email"
    - "Password reset email is sent with secure token"
    - "User can reset password with valid token"
    - "Reset tokens expire after 1 hour"
    - "Used tokens are deleted"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "PasswordResetToken model"
      contains: "model PasswordResetToken"
    - path: "src/lib/email.ts"
      provides: "Email sending with Resend"
      exports: ["sendPasswordResetEmail"]
    - path: "src/app/(auth)/forgot-password/page.tsx"
      provides: "Forgot password page"
    - path: "src/app/(auth)/reset-password/page.tsx"
      provides: "Reset password page"
  key_links:
    - from: "src/lib/email.ts"
      to: "resend"
      via: "Resend SDK"
      pattern: "new Resend"
    - from: "src/lib/auth-actions.ts"
      to: "src/lib/email.ts"
      via: "sendPasswordResetEmail import"
      pattern: "sendPasswordResetEmail"
    - from: "src/lib/auth-actions.ts"
      to: "prisma.passwordResetToken"
      via: "Token CRUD"
      pattern: "db\\.passwordResetToken"
---

<objective>
Implement password reset flow with Resend email service.

Purpose: Allow users to recover access to their accounts when they forget their password.
Output: Working forgot password and reset password flows with email delivery.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication/02-RESEARCH.md

# Prior plan in this phase
@.planning/phases/02-authentication/02-01-SUMMARY.md
@src/lib/auth.ts
@src/lib/auth-actions.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PasswordResetToken model and install Resend</name>
  <files>prisma/schema.prisma, package.json</files>
  <action>
Install Resend:
```bash
npm install resend
```

Add PasswordResetToken model to `prisma/schema.prisma`:
```prisma
model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
  @@index([email])
  @@index([token])
}
```

Run migration:
```bash
npx prisma migrate dev --name add_password_reset_token
```

Generate updated client:
```bash
npx prisma generate
```
  </action>
  <verify>
    - `npm ls resend` shows installed
    - `prisma/schema.prisma` contains PasswordResetToken model
    - Migration created in `prisma/migrations/`
    - `npx prisma generate` succeeds
  </verify>
  <done>PasswordResetToken model added and Resend installed</done>
</task>

<task type="auto">
  <name>Task 2: Create email service and password reset actions</name>
  <files>src/lib/email.ts, src/lib/auth-actions.ts, src/lib/validations/auth.ts, .env.local</files>
  <action>
Add to `.env.local`:
```
RESEND_API_KEY=re_your_api_key_here
```

Create `src/lib/email.ts`:
```typescript
import { Resend } from 'resend';
import crypto from 'crypto';
import db from '@/lib/db';

const resend = new Resend(process.env.RESEND_API_KEY);

export async function sendPasswordResetEmail(email: string) {
  // Check if user exists (but don't reveal this to caller)
  const user = await db.user.findUnique({ where: { email } });

  if (!user) {
    // Return success even if user doesn't exist (security)
    return { success: true };
  }

  // Delete any existing tokens for this email
  await db.passwordResetToken.deleteMany({ where: { email } });

  // Generate secure token
  const token = crypto.randomBytes(32).toString('hex');
  const expires = new Date(Date.now() + 60 * 60 * 1000); // 1 hour

  await db.passwordResetToken.create({
    data: {
      email,
      token,
      expires,
    },
  });

  const resetLink = `${process.env.NEXTAUTH_URL}/reset-password?token=${token}`;

  // In development, log to console if no API key
  if (!process.env.RESEND_API_KEY || process.env.RESEND_API_KEY === 're_your_api_key_here') {
    console.log('=== Password Reset Email (dev mode) ===');
    console.log('To:', email);
    console.log('Reset Link:', resetLink);
    console.log('========================================');
    return { success: true };
  }

  try {
    await resend.emails.send({
      from: 'Community <onboarding@resend.dev>', // Use Resend's test domain
      to: email,
      subject: 'Reset your password',
      html: `
        <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
          <h1 style="color: #333;">Reset your password</h1>
          <p>You requested a password reset. Click the link below to reset your password:</p>
          <p style="margin: 24px 0;">
            <a href="${resetLink}" style="background: #0070f3; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">
              Reset Password
            </a>
          </p>
          <p style="color: #666; font-size: 14px;">
            This link expires in 1 hour. If you didn't request this, ignore this email.
          </p>
          <hr style="border: none; border-top: 1px solid #eee; margin: 24px 0;" />
          <p style="color: #999; font-size: 12px;">
            If the button doesn't work, copy and paste this link: ${resetLink}
          </p>
        </div>
      `,
    });
  } catch (error) {
    console.error('Failed to send email:', error);
    // Still return success to not reveal email existence
  }

  return { success: true };
}
```

Update `src/lib/validations/auth.ts` to add reset schemas:
```typescript
// Add to existing file:
export const forgotPasswordSchema = z.object({
  email: z.string().email('Invalid email address'),
});

export const resetPasswordSchema = z.object({
  token: z.string().min(1, 'Token is required'),
  password: z.string().min(8, 'Password must be at least 8 characters'),
});

export type ForgotPasswordInput = z.infer<typeof forgotPasswordSchema>;
export type ResetPasswordInput = z.infer<typeof resetPasswordSchema>;
```

Add to `src/lib/auth-actions.ts`:
```typescript
// Add imports at top:
import { sendPasswordResetEmail } from '@/lib/email';
import { forgotPasswordSchema, resetPasswordSchema } from '@/lib/validations/auth';

// Add new actions:
export async function requestPasswordReset(formData: FormData) {
  const validatedFields = forgotPasswordSchema.safeParse({
    email: formData.get('email'),
  });

  if (!validatedFields.success) {
    return { error: 'Invalid email' };
  }

  const { email } = validatedFields.data;

  await sendPasswordResetEmail(email);

  // Always return success (don't reveal if email exists)
  return { success: true };
}

export async function resetPassword(formData: FormData) {
  const validatedFields = resetPasswordSchema.safeParse({
    token: formData.get('token'),
    password: formData.get('password'),
  });

  if (!validatedFields.success) {
    return { error: 'Invalid input' };
  }

  const { token, password } = validatedFields.data;

  const resetToken = await db.passwordResetToken.findUnique({
    where: { token },
  });

  if (!resetToken) {
    return { error: 'Invalid or expired reset link' };
  }

  if (resetToken.expires < new Date()) {
    await db.passwordResetToken.delete({ where: { id: resetToken.id } });
    return { error: 'Reset link has expired' };
  }

  const hashedPassword = await bcrypt.hash(password, 10);

  await db.user.update({
    where: { email: resetToken.email },
    data: { hashedPassword },
  });

  // Delete used token
  await db.passwordResetToken.delete({ where: { id: resetToken.id } });

  return { success: true };
}
```
  </action>
  <verify>
    - `src/lib/email.ts` exists with sendPasswordResetEmail export
    - `src/lib/auth-actions.ts` has requestPasswordReset and resetPassword
    - `src/lib/validations/auth.ts` has forgotPasswordSchema and resetPasswordSchema
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Email service and password reset server actions created</done>
</task>

<task type="auto">
  <name>Task 3: Create forgot and reset password pages</name>
  <files>src/app/(auth)/forgot-password/page.tsx, src/app/(auth)/reset-password/page.tsx, src/components/auth/forgot-password-form.tsx, src/components/auth/reset-password-form.tsx</files>
  <action>
Create `src/components/auth/forgot-password-form.tsx`:
```typescript
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useState } from 'react';
import { forgotPasswordSchema, type ForgotPasswordInput } from '@/lib/validations/auth';
import { requestPasswordReset } from '@/lib/auth-actions';
import { Button } from '@/components/ui/button';

export function ForgotPasswordForm() {
  const [isLoading, setIsLoading] = useState(false);
  const [isSuccess, setIsSuccess] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<ForgotPasswordInput>({
    resolver: zodResolver(forgotPasswordSchema),
  });

  const onSubmit = async (data: ForgotPasswordInput) => {
    setIsLoading(true);

    const formData = new FormData();
    formData.append('email', data.email);

    await requestPasswordReset(formData);

    setIsLoading(false);
    setIsSuccess(true);
  };

  if (isSuccess) {
    return (
      <div className="text-center space-y-4">
        <div className="p-3 bg-green-100 text-green-700 rounded">
          If an account with that email exists, we&apos;ve sent a password reset link.
        </div>
        <p className="text-sm text-gray-600">
          Check your inbox and spam folder.
        </p>
      </div>
    );
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
      <div>
        <label htmlFor="email" className="block text-sm font-medium mb-1">
          Email
        </label>
        <input
          {...register('email')}
          type="email"
          id="email"
          className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="you@example.com"
        />
        {errors.email && (
          <p className="text-red-500 text-sm mt-1">{errors.email.message}</p>
        )}
      </div>

      <Button type="submit" className="w-full" disabled={isLoading}>
        {isLoading ? 'Sending...' : 'Send reset link'}
      </Button>
    </form>
  );
}
```

Create `src/components/auth/reset-password-form.tsx`:
```typescript
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useRouter } from 'next/navigation';
import { useState } from 'react';
import { z } from 'zod';
import { resetPassword } from '@/lib/auth-actions';
import { Button } from '@/components/ui/button';

const formSchema = z.object({
  password: z.string().min(8, 'Password must be at least 8 characters'),
  confirmPassword: z.string(),
}).refine((data) => data.password === data.confirmPassword, {
  message: 'Passwords do not match',
  path: ['confirmPassword'],
});

type FormInput = z.infer<typeof formSchema>;

interface ResetPasswordFormProps {
  token: string;
}

export function ResetPasswordForm({ token }: ResetPasswordFormProps) {
  const router = useRouter();
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [isSuccess, setIsSuccess] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<FormInput>({
    resolver: zodResolver(formSchema),
  });

  const onSubmit = async (data: FormInput) => {
    setIsLoading(true);
    setError(null);

    const formData = new FormData();
    formData.append('token', token);
    formData.append('password', data.password);

    const result = await resetPassword(formData);

    setIsLoading(false);

    if (result.error) {
      setError(result.error);
      return;
    }

    setIsSuccess(true);
  };

  if (isSuccess) {
    return (
      <div className="text-center space-y-4">
        <div className="p-3 bg-green-100 text-green-700 rounded">
          Password reset successfully!
        </div>
        <Button onClick={() => router.push('/login')} className="w-full">
          Sign in
        </Button>
      </div>
    );
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
      {error && (
        <div className="p-3 bg-red-100 text-red-700 rounded text-sm">
          {error}
        </div>
      )}

      <div>
        <label htmlFor="password" className="block text-sm font-medium mb-1">
          New Password
        </label>
        <input
          {...register('password')}
          type="password"
          id="password"
          className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
        {errors.password && (
          <p className="text-red-500 text-sm mt-1">{errors.password.message}</p>
        )}
        <p className="text-gray-500 text-xs mt-1">At least 8 characters</p>
      </div>

      <div>
        <label htmlFor="confirmPassword" className="block text-sm font-medium mb-1">
          Confirm Password
        </label>
        <input
          {...register('confirmPassword')}
          type="password"
          id="confirmPassword"
          className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
        {errors.confirmPassword && (
          <p className="text-red-500 text-sm mt-1">{errors.confirmPassword.message}</p>
        )}
      </div>

      <Button type="submit" className="w-full" disabled={isLoading}>
        {isLoading ? 'Resetting...' : 'Reset password'}
      </Button>
    </form>
  );
}
```

Create `src/app/(auth)/forgot-password/page.tsx`:
```typescript
import Link from 'next/link';
import { ForgotPasswordForm } from '@/components/auth/forgot-password-form';

export default function ForgotPasswordPage() {
  return (
    <div className="space-y-6">
      <div className="text-center">
        <h1 className="text-2xl font-bold">Forgot password?</h1>
        <p className="text-gray-600 mt-1">
          Enter your email and we&apos;ll send you a reset link
        </p>
      </div>

      <ForgotPasswordForm />

      <div className="text-center text-sm text-gray-600">
        Remember your password?{' '}
        <Link href="/login" className="text-blue-600 hover:underline">
          Sign in
        </Link>
      </div>
    </div>
  );
}
```

Create `src/app/(auth)/reset-password/page.tsx`:
```typescript
import Link from 'next/link';
import { ResetPasswordForm } from '@/components/auth/reset-password-form';

interface ResetPasswordPageProps {
  searchParams: Promise<{ token?: string }>;
}

export default async function ResetPasswordPage({ searchParams }: ResetPasswordPageProps) {
  const { token } = await searchParams;

  if (!token) {
    return (
      <div className="space-y-6 text-center">
        <h1 className="text-2xl font-bold">Invalid reset link</h1>
        <p className="text-gray-600">
          This password reset link is invalid or has expired.
        </p>
        <Link href="/forgot-password" className="text-blue-600 hover:underline">
          Request a new reset link
        </Link>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="text-center">
        <h1 className="text-2xl font-bold">Reset your password</h1>
        <p className="text-gray-600 mt-1">Enter your new password below</p>
      </div>

      <ResetPasswordForm token={token} />
    </div>
  );
}
```
  </action>
  <verify>
    - `src/app/(auth)/forgot-password/page.tsx` exists
    - `src/app/(auth)/reset-password/page.tsx` exists
    - `src/components/auth/forgot-password-form.tsx` exists with 'use client'
    - `src/components/auth/reset-password-form.tsx` exists with 'use client'
    - `npm run build` succeeds
    - Visit `/forgot-password` - shows form
    - Visit `/reset-password` (no token) - shows invalid link message
  </verify>
  <done>Forgot password and reset password pages and forms created</done>
</task>

</tasks>

<verification>
1. Run `npm run build` - should complete without errors
2. Test forgot password flow:
   - Create a test user via `/register`
   - Visit `/forgot-password`
   - Enter the test user's email
   - Check console output for reset link (dev mode)
   - Visit the reset link
   - Enter new password
   - Should show success and redirect to login
3. Test expired/invalid token:
   - Visit `/reset-password?token=invalid`
   - Should show error message
4. Verify token deletion:
   - After successful reset, same link should fail
</verification>

<success_criteria>
- User can request password reset email
- Reset email contains secure token link
- Valid token allows password change
- Expired tokens show error
- Used tokens are deleted
- Invalid/missing tokens show error
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-03-SUMMARY.md`
</output>
